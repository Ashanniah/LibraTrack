<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack - Books</title>

  <!-- Fonts & Vendor CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

  <!-- App CSS -->
  <link href="assets/css/sidebar.css" rel="stylesheet">
  <link href="assets/css/librarian-add-book.css" rel="stylesheet">
  <link href="assets/css/books.css" rel="stylesheet">
  <link rel="icon" href="assets/img/LibraTrack-logo.png">

  <script src="assets/js/sidebar.js" defer></script>

  <!-- Small inline overrides -->
  <style>
    .cover-drop{
      width:100%;
      border:2px dashed #dfe5ef;border-radius:16px;
      padding:16px;min-height:220px;cursor:pointer;transition:.2s;
      display:flex;align-items:center;justify-content:center;background:#fff;
    }
    .cover-drop:hover{ background:#f7f9fc }
    .cover-drop.ring{ outline:2px solid var(--bs-primary); outline-offset:2px; }
    .cover-drop.compact{ min-height:auto; padding:12px; display:inline-flex; width:auto; max-width:100% }
    #coverPreview{ max-width:100%; height:auto; max-height:300px; object-fit:contain; border-radius:12px; background:#f3f4f6 }
  </style>
</head>

<body class="sb-body loading">
<div id="sidebar-root"></div>

<div class="sb-wrapper">
  <div class="topbar">
    <div class="page-head d-flex align-items-center gap-2">
      <button id="sidebarToggle" class="btn btn-link text-dark p-0 me-2" aria-label="Toggle sidebar">
        <i class="bi bi-list fs-4"></i>
      </button>
      <div class="page-title">Books</div>
    </div>
  </div>

  <main class="container-fluid py-4">
    <div class="d-flex gap-3 mb-3 border-bottom">
      <button id="tabDiscover" class="btn btn-link tab-btn active px-0">Discover</button>
      <button id="tabAdd" class="btn btn-link tab-btn px-0">Add</button>
    </div>

    <!-- DISCOVER -->
    <section id="panelDiscover" class="card p-3">
      <div class="row g-2 align-items-center">
        <div class="col-lg-6">
          <div class="position-relative" style="max-width:620px">
            <i class="bi bi-search position-absolute" style="left:10px;top:50%;transform:translateY(-50%);opacity:.5"></i>
            <input id="q" class="form-control ps-5" placeholder="Search your favourite books">
          </div>
        </div>
        <div class="col d-flex justify-content-end small text-muted">
          <span id="countInfo"></span>
        </div>
      </div>

      <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
        <h6 class="m-0 fw-semibold">Recommended</h6>
        <button id="seeAll" class="btn btn-link btn-sm p-0">See All</button>
      </div>
      <div id="recStrip" class="h-scroll gap-3"></div>

      <h6 class="mt-4 mb-2 fw-semibold">Categories</h6>
      <div id="catChips" class="chips flex-wrap gap-2"></div>

      <!-- Grid -->
      <div id="grid" class="mt-1 d-flex flex-wrap gap-3"></div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="small text-muted" id="pageInfo"></div>
        <div class="btn-group">
          <button id="prev" class="btn btn-outline-secondary btn-sm"><i class="bi bi-chevron-left"></i></button>
          <button id="next" class="btn btn-outline-secondary btn-sm"><i class="bi bi-chevron-right"></i></button>
        </div>
      </div>
    </section>

    <!-- ADD (librarian only) -->
    <section id="panelAdd" class="card p-3 p-md-4 mt-3 d-none">
      <form id="bookForm" novalidate enctype="multipart/form-data">
        <div class="row g-4">
          <div class="col-12 col-lg-4">
            <h6 class="section-title">Cover</h6>
            <div id="dropArea" class="cover-drop" role="button" tabindex="0">
              <input id="coverInput" name="cover" type="file" accept="image/*" class="d-none">
              <img id="coverPreview" alt="" class="d-none">
              <div id="dropHint" class="text-center">
                <i class="bi bi-image fs-1 d-block mb-2"></i>
                <div class="fw-medium">Click to choose or drop an image</div>
                <small class="text-muted d-block">Max 5 MB · JPG/PNG/WebP/GIF</small>
              </div>
            </div>
            <div class="d-flex gap-2 mt-2">
              <button type="button" id="btnChangeImage" class="btn btn-outline-primary flex-grow-1">
                <i class="bi bi-upload me-1"></i> Change
              </button>
              <button type="button" id="btnRemoveImage" class="btn btn-outline-secondary flex-grow-1">
                <i class="bi bi-x-lg me-1"></i> Remove
              </button>
            </div>
          </div>

          <div class="col-12 col-lg-8">
            <h6 class="section-title">Details</h6>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Title <span class="text-danger">*</span></label>
                <input id="title" name="title" type="text" class="form-control" required>
                <div class="invalid-feedback">Title is required.</div>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">ISBN <span class="text-danger">*</span></label>
                <input id="isbn" name="isbn" type="text" class="form-control" required>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Author <span class="text-danger">*</span></label>
                <input id="author" name="author" type="text" class="form-control" required>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Category <span class="text-danger">*</span></label>
                <select id="category" name="category" class="form-select" required>
                  <option value="" selected disabled>Select category</option>
                  <option>Action and Adventure</option><option>Biography</option><option>Children's Books</option>
                  <option>Computer Science</option><option>Fantasy</option><option>History</option>
                  <option>Mystery</option><option>Romance</option><option>Science</option>
                </select>
              </div>

              <div class="col-6 col-md-3">
                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                <input id="quantity" name="quantity" type="number" min="1" step="1" class="form-control" required>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Publisher <span class="text-danger">*</span></label>
                <input id="publisher" name="publisher" type="text" class="form-control" required>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Date Published</label>
                <input id="publishedAt" name="date_published" type="date" class="form-control">
              </div>
            </div>

            <hr class="my-4">
            <div class="d-flex flex-wrap gap-2">
              <button id="btnSave" type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i> <span id="btnSaveText">Save Book</span>
              </button>
              <button type="button" id="btnGoDiscover" class="btn btn-light">Back to Discover</button>
            </div>
          </div>
        </div>
      </form>
    </section>

    <!-- Book details offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="bookDetails" aria-labelledby="bookDetailsLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="bookDetailsLabel">Book</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body" id="detailsBody"></div>
    </div>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
      <div id="toastSaved" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body"><i class="bi bi-check2-circle me-2"></i><span id="toastMsg">Book saved.</span></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm-fixed">
    <div class="modal-content lt-modal text-center">
      <div class="lt-icon lt-icon-danger">
        <i class="bi bi-exclamation-triangle-fill"></i>
      </div>
      <h5 class="lt-title">Delete Book</h5>
      <p class="lt-text" id="deleteConfirmText">
        Are you sure you want to delete this book? This action cannot be undone.
      </p>
      <div class="lt-actions">
        <button type="button" class="btn lt-btn lt-btn-neutral" data-bs-dismiss="modal">Cancel</button>
        <button id="btnConfirmDelete" type="button" class="btn lt-btn lt-btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Success Modal -->
<div class="modal fade" id="deleteSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm-fixed">
    <div class="modal-content lt-modal text-center">
      <div class="lt-icon lt-icon-success">
        <i class="bi bi-check-circle-fill"></i>
      </div>
      <h5 class="lt-title">Book Deleted Successfully</h5>
      <div class="lt-actions">
        <button type="button" class="btn lt-btn lt-btn-neutral" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Vendor JS -->
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<script>
async function getMe(){
  try{
    const res = await fetch('backend/check-auth.php', {credentials:'include'});
    if (!res.ok) return null;
    const data = await res.json().catch(()=>null);
    return data?.user || null;
  }catch{ return null; }
}

(async ()=>{
  const me = await getMe();
  const role = (me?.role || 'student').toLowerCase();

  if (typeof renderSidebar === 'function') renderSidebar('books', role);
  document.getElementById('sidebarToggle')?.addEventListener('click', ()=>{
    if (typeof toggleSidebar === 'function') toggleSidebar();
    else document.body.classList.toggle('sb-collapsed');
  });

  initBooks(role);
  document.body.classList.remove('loading');
})();

function initBooks(role){
  const API_LIST     = 'backend/books-list.php';
  const API_CREATE   = 'backend/add-book.php';
  const API_EDIT     = 'backend/edit-book.php';
  const API_DELETE   = 'backend/delete-book.php';
  const API_FAVORITE = 'backend/favorite-toggle.php';

  const canManage = () => role === 'librarian';

  const tabDiscover = document.getElementById('tabDiscover');
  const tabAdd      = document.getElementById('tabAdd');
  const panelDiscover = document.getElementById('panelDiscover');
  const panelAdd      = document.getElementById('panelAdd');
  const btnGoDiscover = document.getElementById('btnGoDiscover');

  if (!canManage()) tabAdd.classList.add('d-none');

  function showDiscover(){ tabDiscover.classList.add('active'); tabAdd.classList.remove('active'); panelDiscover.classList.remove('d-none'); panelAdd.classList.add('d-none'); }
  function showAdd(){ if (!canManage()) return; tabAdd.classList.add('active'); tabDiscover.classList.remove('active'); panelAdd.classList.remove('d-none'); panelDiscover.classList.add('d-none'); }
  tabDiscover.onclick = showDiscover; tabAdd.onclick = showAdd; btnGoDiscover && (btnGoDiscover.onclick = showDiscover);

  const qInput    = document.getElementById('q');
  const recStrip  = document.getElementById('recStrip');
  const grid      = document.getElementById('grid');
  const catChips  = document.getElementById('catChips');

  const state = { page:1, pagesize:12, q:'', cat:'' };
  const ALL_CATS = ["All","Action and Adventure","Biography","Children's Books","Computer Science","Fantasy","History","Mystery","Romance","Science"];
  const esc = (s='') => s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

  const renderStars = (rating=0)=>{
    const r = Math.max(0, Math.min(5, Math.round(Number(rating)||0)));
    return Array.from({length:5},(_,i)=>`<i class="bi ${i<r?'bi-star-fill text-warning':'bi-star text-secondary'}"></i>`).join('');
  };
  const renderHeart = (book)=>{
    if (role!=='student') return '';
    const cls = book.is_favorite ? 'bi-heart-fill text-danger' : 'bi-heart';
    return `<button class="btn-fav" title="${book.is_favorite?'Remove from favorites':'Add to favorites'}" data-id="${book.id}">
              <i class="bi ${cls}"></i>
            </button>`;
  };

  function renderChips(){
    catChips.innerHTML = ALL_CATS.map(c=>{
      const v = c==='All' ? '' : c;
      return `<button class="chip ${state.cat===v?'active':''}" data-cat="${v}">${c}</button>`;
    }).join('');
    catChips.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click',()=>{ state.cat = btn.dataset.cat||''; state.page=1; loadGrid(); renderChips(); });
    });
  }

  async function loadRecommended(){
    const url = `${API_LIST}?page=1&pagesize=12&q=&category=`;
    const data = await fetch(url,{credentials:'include'}).then(r=>r.json()).catch(()=>({ok:false}));
    if (!data.ok){ recStrip.innerHTML = `<div class="empty w-100">Failed to load.</div>`; return; }
    recStrip.innerHTML = data.items.map(b=>{
      const cover = b.cover_url || 'assets/img/no-cover.png';
      const t = esc(b.title||''), a = esc(b.author||'');
      return `
        <div class="rec-card p-2">
          <div class="cover-wrap position-relative" role="button" onclick='showDetails(${JSON.stringify(b).replace(/'/g,"&#39;")})'>
            <img src="${cover}" alt="${t}">
            ${renderHeart(b)}
          </div>
          <div class="p-1">
            <div class="title text-truncate" title="${t}">${t}</div>
            <div class="meta text-truncate">${a||'Unknown'}</div>
            <div class="stars mt-1">${renderStars(b.rating || 4)}</div>
          </div>
        </div>`;
    }).join('');
    bindFavoriteButtons();
  }

  async function loadGrid(){
    const url = `${API_LIST}?page=${state.page}&pagesize=${state.pagesize}&q=${encodeURIComponent(state.q)}&category=${encodeURIComponent(state.cat)}`;
    const data = await fetch(url,{credentials:'include'}).then(r=>r.json()).catch(()=>({ok:false}));
    if (!data.ok){ grid.innerHTML = `<div class="empty w-100">Failed to load.</div>`; return; }
    const items = data.items||[];

    grid.innerHTML = items.length ? items.map(b=>{
      const cover = b.cover_url || 'assets/img/no-cover.png';
      const t = esc(b.title||''), a = esc(b.author||''), c = esc(b.category||''), i = esc(b.isbn||'');
      return `
        <div class="grid-item">
          <div class="book-card p-2">
            <div class="cover-wrap position-relative" role="button" onclick='showDetails(${JSON.stringify(b).replace(/'/g,"&#39;")})'>
              <img class="thumb-lg" src="${cover}" alt="${t}">
              ${renderHeart(b)}
            </div>
            <div class="p-2">
              <div class="title text-truncate" title="${t}">${t}</div>
              <div class="meta text-truncate">${a||'Unknown author'}</div>
              <div class="meta">${c}${c&&i?' • ':''}${i?('ISBN: '+i):''}</div>
            </div>
            ${canManage() ? `
            <div class="card-actions">
              <button class="icon-btn btn-edit" data-id="${b.id}" title="Edit"><i class="bi bi-pencil-square"></i></button>
              <button class="icon-btn btn-delete" data-id="${b.id}" data-title="${t}" title="Delete"><i class="bi bi-trash3"></i></button>
            </div>` : ''}
          </div>
        </div>`;
    }).join('') : `<div class="empty w-100">No books found.</div>`;

    document.getElementById('countInfo').textContent = `${data.total.toLocaleString()} total`;
    const start=(data.page-1)*data.pagesize+1, end=Math.min(data.total, data.page*data.pagesize);
    document.getElementById('pageInfo').textContent = data.total ? `Showing ${start}-${end} of ${data.total}` : '';
    document.getElementById('prev').disabled = data.page<=1;
    document.getElementById('next').disabled = data.page>=data.pages;

    bindFavoriteButtons();
    if (canManage()) bindManageButtons(items);
  }

  function bindFavoriteButtons(){
    if (role!=='student') return;
    document.querySelectorAll('.btn-fav').forEach(btn=>{
btn.onclick = async (e)=>{
  e.stopPropagation();
  const id = btn.dataset.id;

  try{
    const fd = new FormData();
    fd.set('book_id', id);

    const res  = await fetch(API_FAVORITE, {
      method: 'POST',
      body: fd,
      credentials: 'include'
    });

    // Always try to parse JSON, but keep a readable fallback
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = null; }

    if (!res.ok || !data || !data.ok) {
      const msg = (data && data.error) ? data.error : (`HTTP ${res.status} ${res.statusText}\n${text}`);
      alert(msg || 'Failed to update favorites.');
      return;
    }

    const icon = btn.querySelector('i');
    icon.classList.toggle('bi-heart-fill', data.favorited);
    icon.classList.toggle('bi-heart', !data.favorited);
    icon.classList.toggle('text-danger', data.favorited);
    btn.title = data.favorited ? 'Remove from favorites' : 'Add to favorites';
  }catch(err){
    alert('Network error: ' + err.message);
  }
};
    });
  }

  // ---- Confirm modal helper
  function confirmDeleteModal(title) {
    return new Promise((resolve) => {
      const modalEl = document.getElementById('deleteConfirmModal');
      const textEl  = document.getElementById('deleteConfirmText');
      const okBtn   = document.getElementById('btnConfirmDelete');

      textEl.textContent = `Are you sure you want to delete "${title}"? This action cannot be undone.`;

      // Reset handler to avoid stacking
      const newBtn = okBtn.cloneNode(true);
      okBtn.parentNode.replaceChild(newBtn, okBtn);

      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      newBtn.addEventListener('click', () => { modal.hide(); resolve(true); }, { once:true });
      modalEl.addEventListener('hidden.bs.modal', () => resolve(false), { once:true });
      modal.show();
    });
  }

  let editingId = null;

  function bindManageButtons(items){
    document.querySelectorAll('.btn-edit').forEach(btn=>{
      btn.onclick = ()=>{
        const id = +btn.dataset.id;
        const b = items.find(x=>+x.id===id);
        if (b) startEdit(b);
      };
    });

    document.querySelectorAll('.btn-delete').forEach(btn=>{
      btn.onclick = async ()=>{
        const id = +btn.dataset.id;
        const t  = btn.dataset.title || 'this book';

        // Bootstrap confirm modal (no native confirm)
        const ok = await confirmDeleteModal(t);
        if (!ok) return;

        const fd = new FormData(); fd.set('id', String(id));

        try{
          const res  = await fetch(API_DELETE, {method:'POST', body:fd, credentials:'include'});
          const data = await res.json().catch(()=>null);

          if (data?.ok){
            await loadGrid();
            await loadRecommended();

            // success modal
            const modalEl = document.getElementById('deleteSuccessModal');
            bootstrap.Modal.getOrCreateInstance(modalEl).show();
          } else {
            alert(data?.error || 'Delete failed');
          }
        }catch{
          alert('Network/server error');
        }
      };
    });
  }

  function startEdit(b){
    tabAdd.click();
    editingId = b.id;

    const form = document.getElementById('bookForm');
    form.classList.remove('was-validated');

    document.getElementById('title').value       = b.title || '';
    document.getElementById('isbn').value        = b.isbn || '';
    document.getElementById('author').value      = b.author || '';
    document.getElementById('category').value    = b.category || '';
    document.getElementById('quantity').value    = b.quantity ?? 1;
    document.getElementById('publisher').value   = b.publisher || '';
    document.getElementById('publishedAt').value = (b.published_at || '').slice(0,10);

    const coverPreview = document.getElementById('coverPreview');
    const dropHint     = document.getElementById('dropHint');
    const dropArea     = document.getElementById('dropArea');
    if (b.cover_url){
      coverPreview.src = b.cover_url;
      coverPreview.classList.remove('d-none');
      dropHint.classList.add('d-none');
      dropArea.classList.add('compact');
    }else{
      coverPreview.classList.add('d-none');
      dropHint.classList.remove('d-none');
      dropArea.classList.remove('compact');
    }

    document.getElementById('btnSaveText').textContent = 'Update Book';
  }

  // paging/search
  document.getElementById('prev').onclick = ()=>{ state.page=Math.max(1,state.page-1); loadGrid(); };
  document.getElementById('next').onclick = ()=>{ state.page+=1; loadGrid(); };
  document.getElementById('seeAll').onclick = ()=>{ state.q=''; state.page=1; loadGrid(); };
  qInput.addEventListener('input', e=>{ state.q=e.target.value.trim(); state.page=1; loadGrid(); });

  // details offcanvas
  window.showDetails = function(b){
    const cover = b.cover_url || 'assets/img/no-cover.png';
    const body = `
      <div class="d-flex gap-3">
        <img src="${cover}" alt="${esc(b.title)}" style="width:110px;height:150px;object-fit:cover;border-radius:8px;background:#f3f4f6">
        <div>
          <div class="fw-semibold">${esc(b.title||'')}</div>
          <div class="text-muted">${esc(b.author||'')}</div>
          <div class="small text-muted mt-1">${esc(b.category||'')}${b.category&&b.isbn?' • ':''}${b.isbn?('ISBN: '+esc(b.isbn)) : ''}</div>
          <div class="small mt-1">Qty: <span class="badge text-bg-light">${b.quantity??0}</span></div>
          <div class="small mt-1">Published: ${b.published_at||''}</div>
          <div class="small mt-1">Publisher: ${esc(b.publisher||'')}</div>
        </div>
      </div>`;
    document.getElementById('bookDetailsLabel').textContent = b.title || 'Book';
    document.getElementById('detailsBody').innerHTML = body;
    bootstrap.Offcanvas.getOrCreateInstance('#bookDetails').show();
  };

  // add/edit form
  const form = document.getElementById('bookForm');
  if (form){
    const toastSaved = new bootstrap.Toast(document.getElementById('toastSaved'));
    const toastMsg   = document.getElementById('toastMsg');
    const dropArea   = document.getElementById('dropArea');
    const coverInput = document.getElementById('coverInput');
    const coverPreview = document.getElementById('coverPreview');
    const dropHint   = document.getElementById('dropHint');

    dropArea && (dropArea.onclick = ()=>coverInput.click());
    ['dragenter','dragover'].forEach(evt=>dropArea?.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation();dropArea.classList.add('ring');}));
    ['dragleave','drop'].forEach(evt=>dropArea?.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation();dropArea.classList.remove('ring');}));
    dropArea?.addEventListener('drop', e=>{
      const f = e.dataTransfer.files?.[0]; if (!f) return;
      if (f.size > 5*1024*1024){ alert('Max file size is 5 MB'); return; }
      coverInput.files = e.dataTransfer.files;
      const r=new FileReader();
      r.onload=()=>{
        coverPreview.src=r.result;
        coverPreview.classList.remove('d-none');
        dropHint.classList.add('d-none');
        dropArea.classList.add('compact');
      };
      r.readAsDataURL(f);
    });
    document.getElementById('btnChangeImage')?.addEventListener('click', ()=>coverInput.click());
    document.getElementById('btnRemoveImage')?.addEventListener('click', ()=>{
      coverPreview.src='';
      coverPreview.classList.add('d-none');
      dropHint.classList.remove('d-none');
      coverInput.value='';
      dropArea.classList.remove('compact');
    });
    coverInput && (coverInput.onchange = ()=>{
      const f=coverInput.files?.[0]; if (!f) return;
      if (f.size>5*1024*1024){ alert('Max file size is 5 MB'); coverInput.value=''; return; }
      const r=new FileReader();
      r.onload=()=>{
        coverPreview.src=r.result;
        coverPreview.classList.remove('d-none');
        dropHint.classList.add('d-none');
        dropArea.classList.add('compact');
      };
      r.readAsDataURL(f);
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!canManage()){ alert('Only librarians can add/edit books.'); return; }
      form.classList.add('was-validated');
      if (!form.checkValidity()) return;

      const isEditing = !!editingId;
      const url = isEditing ? API_EDIT : API_CREATE;

      const fd = new FormData(form);
      fd.set('quantity', String(Math.max(1, parseInt(fd.get('quantity') || '0', 10))));
      if (isEditing) fd.set('id', String(editingId));

      try{
        const res = await fetch(url, {method:'POST', body:fd, credentials:'include'});
        const raw = await res.text();
        let data = null;
        try{ data = JSON.parse(raw); }catch{ alert(`HTTP ${res.status} ${res.statusText}\n\n${raw.slice(0,800)}`); return; }
        if (!res.ok || !data.ok){ alert(data.error || `Save failed (HTTP ${res.status})`); return; }

        editingId = null;
        document.getElementById('btnSaveText').textContent = 'Save Book';
        toastMsg.textContent = isEditing ? 'Book updated.' : 'Book saved.';
        toastSaved.show();

        form.reset(); form.classList.remove('was-validated');
        coverPreview.src=''; coverPreview.classList.add('d-none'); dropHint.classList.remove('d-none');
        dropArea.classList.remove('compact');

        tabDiscover.click();
        state.page=1; await loadGrid(); await loadRecommended();
      }catch(err){ alert('Network/server error: '+err.message); }
    });
  }

  renderChips(); loadRecommended(); loadGrid(); showDiscover();
}
</script>
</body>
</html>
