<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack - Books</title>

  <!-- Fonts & Vendor CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

  <!-- App CSS -->
  <link href="assets/css/sidebar.css" rel="stylesheet">
  <link href="assets/css/librarian-add-book.css" rel="stylesheet">
  <link href="assets/css/books.css" rel="stylesheet">
  <link href="assets/css/responsive.css" rel="stylesheet">
  <link rel="icon" href="assets/img/logo.png" type="image/png">

  <script src="assets/js/sidebar.js?v=2025-11-19-FINAL-NO-SEARCH-NO-NOTIFICATIONS-V2"></script>

  <!-- Small inline overrides -->
  <style>
    :root{
      --brand-gold:#a68604;
      --gold-dark:#8d7003;
      --sidebar-bg:#111;
      --text-primary:#212529;
      --text-secondary:#6b7280;
      --border-radius:12px;
      --border-radius-sm:8px;
      --border-radius-lg:16px;
      --shadow-sm:0 2px 4px rgba(0,0,0,.04);
      --card-border:#e5e7eb;
      --table-header-bg:#f8f9fa;
    }
    
    /* Consistent Header Design */
    .admin-header-gold {
      background: #fff !important;
      color: var(--text-primary) !important;
      border-bottom:1px solid var(--card-border);
      box-shadow:var(--shadow-sm);
      padding:12px 0;
    }
    .admin-header-gold .fw-bold,
    .admin-header-gold .h5,
    .admin-header-gold #pageTitle {
      color: var(--text-primary) !important;
      font-weight:700;
      font-size:1.25rem;
      letter-spacing:0.01em;
    }
    
    /* Skeleton Loaders for Book Cards */
    .skeleton-book-card {
      animation: skeleton-pulse 1.5s ease-in-out infinite;
    }
    @keyframes skeleton-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .skeleton-cover {
      width: 100%;
      height: 240px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 8px;
    }
    @keyframes skeleton-shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-line {
      height: 16px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .skeleton-line.short {
      width: 60%;
    }
    .skeleton-line.medium {
      width: 80%;
    }
    .skeleton-line.long {
      width: 100%;
    }
    .skeleton-button {
      width: 40px;
      height: 40px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 6px;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Consistent Search Bar Design */
    .search-bar-custom {
      height: 42px;
    }
    .search-bar-custom .input-group-text,
    .search-bar-custom .form-control {
      height: 42px;
      padding: 10px 16px;
      font-size:0.875rem;
    }
    .search-bar-custom .input-group-text {
      border-top-left-radius: var(--border-radius-sm);
      border-bottom-left-radius: var(--border-radius-sm);
      background: var(--table-header-bg) !important;
      border: 1px solid var(--card-border);
      border-right: none !important;
      color:var(--text-secondary);
    }
    .search-bar-custom .form-control {
      border-top-right-radius: var(--border-radius-sm);
      border-bottom-right-radius: var(--border-radius-sm);
      background: var(--table-header-bg) !important;
      border: 1px solid var(--card-border);
      border-left: none !important;
      color: var(--text-primary);
    }
    .search-bar-custom:focus-within {
      box-shadow: 0 0 0 3px rgba(166, 134, 4, 0.15);
      border-radius: var(--border-radius-sm);
    }
    .search-bar-custom:focus-within .input-group-text {
      border-color: var(--brand-gold);
      background: #fff !important;
    }
    .search-bar-custom:focus-within .form-control {
      border-color: var(--brand-gold);
      background: #fff !important;
    }
    
    /* Main content search bar - Match other pages */
    .search-bar-custom {
      height: 42px;
      border-radius: var(--border-radius-sm);
      overflow: hidden;
    }
    .search-bar-custom .input-group-text {
      height: 42px;
      padding: 10px 16px;
      font-size: 0.875rem;
      border-top-left-radius: var(--border-radius-sm) !important;
      border-bottom-left-radius: var(--border-radius-sm) !important;
      background: var(--table-header-bg) !important;
      border: 1px solid var(--card-border);
      border-right: none !important;
      color: var(--text-secondary);
    }
    .search-bar-custom .form-control {
      height: 42px;
      padding: 10px 16px;
      font-size: 0.875rem;
      border-top-right-radius: var(--border-radius-sm) !important;
      border-bottom-right-radius: var(--border-radius-sm) !important;
      background: var(--table-header-bg) !important;
      border: 1px solid var(--card-border);
      border-left: none !important;
      color: var(--text-primary);
      outline: none !important;
      box-shadow: none !important;
    }
    .search-bar-custom .form-control:focus {
      outline: none !important;
      box-shadow: none !important;
      border-color: var(--brand-gold) !important;
    }
    .search-bar-custom:focus-within {
      box-shadow: 0 0 0 3px rgba(166, 134, 4, 0.15) !important;
      border-radius: var(--border-radius-sm);
    }
    .search-bar-custom:focus-within .input-group-text {
      border-color: var(--brand-gold) !important;
      background: #fff !important;
      color: var(--text-primary) !important;
      outline: none !important;
      box-shadow: none !important;
    }
    .search-bar-custom:focus-within .form-control {
      border-color: var(--brand-gold) !important;
      background: #fff !important;
      outline: none !important;
      box-shadow: none !important;
    }
    
    /* Notification button styling */
    .admin-btn-custom {
      padding:0 !important;
      width:44px !important;
      height:44px !important;
      border-radius:var(--border-radius-sm) !important;
      border:1px solid var(--card-border) !important;
      background:#fff !important;
      display:flex !important;
      align-items:center !important;
      justify-content:center !important;
    }
    .admin-btn-custom:hover {
      background:#f8f9fa !important;
    }
    .admin-btn-custom:focus,
    .admin-btn-custom:active,
    .admin-btn-custom.show {
      background: var(--brand-gold) !important;
      border-color: var(--brand-gold) !important;
      color: #fff !important;
      box-shadow: 0 0 0 0.2rem rgba(166, 134, 4, 0.25) !important;
    }
    .avatar-32 {
      width:32px;
      height:32px;
      border-radius:50%;
      object-fit:cover;
    }
    
    /* Gold Star Ratings */
    .stars .bi-star-fill,
    .stars .bi-star-half{
      color:#a68604 !important;
    }
    .stars .bi-star{
      color:#d3d3d3 !important;
    }
    
    /* Tabs - Black with white text */
    .tabs-container {
      padding: 0 0 20px 0;
    }
    .nav-pills .nav-link {
      border-radius: var(--border-radius-sm);
      padding: 10px 20px;
      font-weight: 600;
      color: #fff !important;
      transition: all 0.2s ease;
      border: none;
      background: #111 !important;
      margin-right: 8px;
    }
    .nav-pills .nav-link:hover {
      color: #fff !important;
      background-color: #333 !important;
    }
    .nav-pills .nav-link.active {
      background-color: #111 !important;
      color: #fff !important;
      border: none;
    }
    
    /* Add Book Form Styling - Modern Design */
    .add-edit-section {
      padding: 32px;
      max-width: 1400px;
      margin: 0 auto;
      background: transparent;
      min-height: 100vh;
    }
    .add-edit-section .page-header {
      margin-bottom: 40px;
      padding: 0;
    }
    .add-edit-section #pageHeaderTitle {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
      letter-spacing: -0.03em;
    }
    
    /* Form Card Container - Extended Panel */
    .add-edit-section form {
      background: #fff;
      border-radius: 20px;
      border: 1px solid rgba(229, 231, 235, 0.8);
      box-shadow: 0 10px 40px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
      padding: 40px;
      position: relative;
      overflow: hidden;
    }
    .add-edit-section form::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--brand-gold) 0%, #d4af37 100%);
    }
    
    /* Cover Card - Modern Design */
    .cover-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 1px solid rgba(229, 231, 235, 0.6);
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06), 0 2px 8px rgba(0,0,0,0.04);
      height: fit-content;
      position: sticky;
      top: 32px;
      transition: all 0.3s ease;
    }
    .cover-card:hover {
      box-shadow: 0 12px 32px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.06);
      transform: translateY(-2px);
    }
    .cover-card .section-header {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #fff;
      margin-bottom: 24px;
      padding: 10px 18px;
      background: #111;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      position: relative;
    }
    .cover-card .section-header i {
      color: #fff;
      font-size: 0.875rem;
      margin-right: 10px;
    }
    .cover-drop-area {
      width: 100%;
      min-height: 320px;
      aspect-ratio: 3/4;
      border: 2.5px dashed rgba(166, 134, 4, 0.3);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 50%, #f0f4f8 100%);
      position: relative;
      overflow: hidden;
    }
    .cover-drop-area::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(166, 134, 4, 0.08) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .cover-drop-area:hover {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #e8f0f4 100%);
      border-color: var(--brand-gold);
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 12px 32px rgba(166, 134, 4, 0.2), 0 4px 16px rgba(166, 134, 4, 0.1);
    }
    .cover-drop-area:hover::before {
      opacity: 1;
    }
    .cover-drop-area:focus {
      outline: 4px solid rgba(166, 134, 4, 0.2);
      border-color: var(--brand-gold);
      box-shadow: 0 0 0 4px rgba(166, 134, 4, 0.15);
    }
    .cover-drop-area .drop-hint i {
      font-size: 3rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
      opacity: 0.6;
    }
    .cover-drop-area .drop-hint .fw-medium {
      font-size: 0.9375rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .cover-drop-area .drop-hint small {
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }
    .cover-preview {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: var(--border-radius);
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: block;
      margin: 0 auto;
    }
    .drop-hint {
      color: var(--text-secondary);
      z-index: 1;
      position: relative;
    }
    .cover-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .cover-actions .btn {
      border-radius: var(--border-radius-sm);
      font-weight: 600;
      font-size: 0.875rem;
      padding: 10px 20px;
      flex: 1;
      transition: all 0.2s ease;
    }
    .cover-actions .btn-outline-secondary {
      background: #f3f4f6;
      border-color: #e5e7eb;
      color: var(--text-secondary);
    }
    .cover-actions .btn-outline-secondary:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      color: var(--text-primary);
      transform: translateY(-1px);
    }
    
    /* Back to Books button styling - Match Back to Discover */
    .back-button {
      background: #f3f4f6 !important;
      border: 1px solid #e5e7eb !important;
      color: var(--text-secondary) !important;
      font-weight: 600 !important;
      padding: 10px 20px !important;
      border-radius: var(--border-radius-sm) !important;
      transition: all 0.2s ease !important;
    }
    .back-button:hover {
      background: #e5e7eb !important;
      border-color: #d1d5db !important;
      color: var(--text-primary) !important;
    }
    .back-button:active {
      background: #d1d5db !important;
    }
    .cover-actions .btn-outline-danger {
      background: #dc3545;
      border-color: #dc3545;
      color: #fff;
    }
    .cover-actions .btn-outline-danger:hover {
      background: #c82333;
      border-color: #c82333;
      color: #fff;
      transform: translateY(-1px);
    }
    
    /* Form Container */
    .form-container {
      background: transparent;
    }
    .form-section {
      margin-bottom: 48px;
      padding-bottom: 36px;
      border-bottom: 1px solid #e5e7eb;
      position: relative;
    }
    .form-section:last-of-type {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .form-section .section-header {
      font-size: 0.8125rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #fff;
      margin-bottom: 28px;
      padding: 10px 18px;
      background: #111;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      position: relative;
    }
    .form-section .section-header i {
      color: #fff;
      font-size: 0.9375rem;
      margin-right: 10px;
    }
    
    /* Form Controls - Modern Style */
    .form-control-enhanced {
      border: 1.5px solid rgba(229, 231, 235, 0.8);
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 0.9375rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: #fff;
      color: var(--text-primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .form-control-enhanced::placeholder {
      color: var(--text-secondary);
      opacity: 0.5;
    }
    .form-control-enhanced:hover {
      border-color: rgba(166, 134, 4, 0.3);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .form-control-enhanced:focus {
      border-color: var(--brand-gold);
      box-shadow: 0 0 0 4px rgba(166, 134, 4, 0.12), 0 4px 12px rgba(166, 134, 4, 0.1);
      outline: none;
      background: #fff;
      transform: translateY(-1px);
    }
    .form-control-enhanced:disabled,
    .form-control-enhanced[readonly] {
      background: #f3f4f6 !important;
      cursor: not-allowed !important;
      opacity: 0.8;
      border-color: #d1d5db;
    }
    .form-control-enhanced:disabled:focus,
    .form-control-enhanced[readonly]:focus {
      border-color: #d1d5db;
      box-shadow: none;
      outline: none;
    }
    
    /* Date picker dropdown positioning */
    input[type="date"] {
      position: relative;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.6;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }
    /* Force date picker dropdown to appear below */
    input[type="date"]:focus {
      z-index: 1;
    }
    /* For Firefox */
    input[type="date"]::-moz-calendar-picker-indicator {
      cursor: pointer;
    }
    /* Select Dropdown - Single Chevron Icon */
    .form-select.form-control-enhanced,
    select.form-control-enhanced {
      appearance: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      -ms-appearance: none !important;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") !important;
      background-repeat: no-repeat !important;
      background-position: right 12px center !important;
      background-size: 16px 12px !important;
      border: 1.5px solid rgba(229, 231, 235, 0.8);
      border-radius: 12px;
      padding: 14px 40px 14px 18px;
      font-size: 0.9375rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background-color: #fff !important;
      color: var(--text-primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      position: relative;
      z-index: 1;
    }
    /* Force dropdown to open downward */
    .form-select.form-control-enhanced:focus,
    select.form-control-enhanced:focus {
      z-index: 1000;
      position: relative;
    }
    /* Ensure parent containers don't clip the dropdown */
    .form-section,
    .form-container,
    .col-12,
    .col-md-8 {
      overflow: visible !important;
    }
    /* Remove any Bootstrap default select styling */
    .form-select.form-control-enhanced::before,
    .form-select.form-control-enhanced::after {
      display: none !important;
    }
    .form-select.form-control-enhanced:focus {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a68604' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") !important;
      border-color: var(--brand-gold);
      box-shadow: 0 0 0 4px rgba(166, 134, 4, 0.12), 0 4px 12px rgba(166, 134, 4, 0.1);
      outline: none;
      background-color: #fff;
      transform: translateY(-1px);
    }
    .form-select.form-control-enhanced:hover {
      border-color: rgba(166, 134, 4, 0.3);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    
    /* Sort dropdown button - Black styling */
    .sort-dropdown {
      background: #111 !important;
      border: 1px solid #111 !important;
      color: #fff !important;
    }
    .sort-dropdown:hover {
      background: #333 !important;
      border-color: #333 !important;
      color: #fff !important;
    }
    .sort-dropdown:focus {
      background: #111 !important;
      border-color: var(--brand-gold) !important;
      color: #fff !important;
      box-shadow: 0 0 0 3px rgba(166, 134, 4, 0.15) !important;
    }
    .sort-dropdown option {
      background: #fff;
      color: var(--text-primary);
    }
    .form-label {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    .form-label .text-danger {
      color: #dc3545;
      margin-left: 4px;
      font-weight: 700;
    }
    .invalid-feedback {
      font-size: 0.8125rem;
      color: #dc3545;
      margin-top: 6px;
      display: none; /* Hide by default */
    }
    /* Only show invalid feedback when form is validated and field is invalid */
    .was-validated .form-control-enhanced:invalid ~ .invalid-feedback,
    .was-validated .form-select.form-control-enhanced:invalid ~ .invalid-feedback,
    .was-validated .form-control-enhanced.is-invalid ~ .invalid-feedback,
    .was-validated .form-select.form-control-enhanced.is-invalid ~ .invalid-feedback {
      display: block;
    }
    .form-control-enhanced.is-invalid,
    .was-validated .form-control-enhanced:invalid {
      border-color: #dc3545;
    }
    .form-control-enhanced.is-invalid:focus,
    .was-validated .form-control-enhanced:invalid:focus {
      border-color: #dc3545;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
    }
    
    /* Status Badge */
    .status-display {
      padding-top: 8px;
    }
    .status-display .badge {
      font-size: 0.875rem;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .status-display .badge.bg-success {
      background-color: #22c55e !important;
      color: #fff !important;
    }
    .status-display small {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-top: 8px;
      display: block;
    }
    
    /* Book Details Drawer - Similar to Borrow Request Panel */
    .request-drawer { 
      width: 520px; 
      max-width: 90vw; 
    }
    .request-drawer .offcanvas-header {
      background: var(--sidebar-bg);
      color: #fff;
      border-bottom: none;
      padding: 24px;
    }
    .request-drawer .offcanvas-title {
      color: #fff;
      font-weight: 700;
      font-size: 1.25rem;
    }
    .request-drawer .offcanvas-header .btn-close {
      filter: invert(1) grayscale(1);
      opacity: 0.8;
    }
    .request-drawer .offcanvas-body { 
      padding: 24px;
      background: #fff;
    }
    .book-cover-small { 
      width: 100px; 
      height: 140px; 
      object-fit: cover; 
      border-radius: var(--border-radius-sm);
      background: #f3f4f6;
      box-shadow: var(--shadow-sm);
    }
    /* Borrow Modal Enhanced Styling */
    .borrow-modal-body {
      padding: 24px;
    }
    .borrow-cover-section {
      position: sticky;
      top: 20px;
    }
    .borrow-modal-cover {
      width: 100%;
      max-width: 180px;
      height: auto;
      aspect-ratio: 2/3;
      object-fit: cover;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      background: var(--card-bg);
      border: 2px solid var(--card-border);
      margin: 0 auto;
      transition: all 0.2s ease;
      display: block;
    }
    .borrow-modal-cover:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--gold);
    }
    .book-cover-wrapper {
      position: relative;
      margin-bottom: 16px;
    }
    .cover-overlay {
      display: none;
    }
    
    /* Availability Card - Consistent Colors */
    .availability-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: var(--border-radius-sm);
      background: #d1fae5;
      border: 1.5px solid rgba(5,150,105,0.2);
      box-shadow: var(--shadow-sm);
    }
    .availability-card.warning {
      background: #fef3c7;
      border-color: rgba(146,64,14,0.2);
    }
    .availability-card.danger {
      background: #fee2e2;
      border-color: rgba(153,27,27,0.2);
    }
    .availability-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      font-size: 1.125rem;
      color: #065f46;
    }
    .availability-card.warning .availability-icon {
      color: #92400e;
    }
    .availability-card.danger .availability-icon {
      color: #991b1b;
    }
    .availability-content {
      flex: 1;
    }
    .availability-label {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 2px;
    }
    .availability-text {
      font-size: 0.875rem;
      font-weight: 700;
      color: #065f46;
    }
    .availability-card.warning .availability-text {
      color: #92400e;
    }
    .availability-card.danger .availability-text {
      color: #991b1b;
    }
    
    /* Rating Display - Consistent Colors */
    .rating-display {
      text-align: center;
      padding: 10px;
      background: var(--card-bg);
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--card-border);
    }
    .rating-label {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }
    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 3px;
      font-size: 1rem;
    }
    .rating-stars .bi-star-fill {
      color: #fbbf24;
    }
    .rating-stars .bi-star {
      color: #d1d5db;
    }
    
    /* Borrow Book Header - Consistent Colors */
    .borrow-book-header {
      margin-bottom: 20px;
    }
    .book-title-section {
      padding-bottom: 16px;
      border-bottom: 2px solid var(--card-border);
    }
    .borrow-book-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.3;
      margin: 0 0 8px 0;
    }
    .borrow-book-author {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .borrow-book-author::before {
      content: 'by';
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 400;
    }
    
    /* Borrow Details Container - Consistent Colors */
    .borrow-details-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    .borrow-details-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      border: 1.5px solid var(--card-border);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }
    .borrow-details-card:hover {
      border-color: var(--gold);
      box-shadow: var(--shadow-md);
    }
    .card-header-section {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1.5px solid var(--card-border);
    }
    .card-header-section i {
      color: var(--gold);
      font-size: 1.125rem;
    }
    .borrow-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    .borrow-detail-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .borrow-detail-item.full-width {
      grid-column: 1 / -1;
    }
    .borrow-detail-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .borrow-detail-label i {
      color: var(--gold);
      font-size: 0.875rem;
      width: 18px;
      text-align: center;
    }
    .borrow-detail-value {
      font-size: 0.9375rem;
      color: var(--text-primary);
      font-weight: 500;
      padding: 10px 14px;
      background: #f3f4f6;
      border-radius: var(--border-radius-sm);
      border: 1.5px solid #e5e7eb;
      min-height: 42px;
      display: flex;
      align-items: center;
      transition: all 0.2s ease;
    }
    .borrow-detail-value:hover {
      background: #e5e7eb;
    }
    .borrow-detail-value:empty::before {
      content: 'Not available';
      color: var(--text-muted);
      font-style: italic;
      font-weight: 400;
    }
    .quantity-display {
      font-size: 0.875rem !important;
      font-weight: 700 !important;
      color: #065f46 !important;
      text-align: center;
      background: #d1fae5 !important;
      border-color: #10b981 !important;
    }
    
    /* Borrow Duration Card - Consistent Colors */
    .borrow-duration-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      border: 1.5px solid var(--card-border);
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }
    .duration-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .borrow-duration-select {
      padding: 12px 16px;
      font-size: 0.9375rem;
      font-weight: 600;
      border: 1.5px solid var(--gold);
      border-radius: var(--border-radius-sm);
      background: var(--card-bg);
      color: var(--text-primary);
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .borrow-duration-select:hover {
      border-color: var(--gold-dark);
    }
    .borrow-duration-select:focus {
      border-color: var(--gold-dark);
      box-shadow: 0 0 0 3px rgba(166,134,4,0.1);
      outline: none;
    }
    .duration-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .duration-option {
      flex: 1;
      min-width: 90px;
      padding: 10px 14px;
      border-radius: var(--border-radius-sm);
      border: 1.5px solid var(--card-border);
      background: var(--card-bg);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .duration-option:hover {
      border-color: #a68604;
      background: #fffef0;
    }
    .duration-option.active {
      border-color: #a68604 !important;
      background: #a68604 !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(166,134,4,0.3) !important;
    }
    .duration-option.active i {
      color: #fff !important;
    }
    .duration-option.active span {
      color: #fff !important;
    }
    .duration-option i {
      font-size: 1.25rem;
      color: var(--text-primary);
      transition: color 0.2s ease;
    }
    .duration-option span {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-primary);
      transition: color 0.2s ease;
    }
    .borrow-duration-help {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      padding: 8px 12px;
      background: var(--card-bg);
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--card-border);
    }
    .borrow-duration-help i {
      color: var(--gold);
      font-size: 0.9375rem;
    }
    
    /* Borrow Action Section */
    .borrow-action-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid var(--card-border);
      text-align: center;
    }
    .btn-borrow-request {
      padding: 12px 32px;
      font-size: 0.9375rem;
      font-weight: 700;
      border-radius: var(--border-radius-sm);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: #a68604 !important;
      border: 2px solid #a68604 !important;
      color: #fff !important;
    }
    .btn-borrow-request:not(:hover):not(:active):not(:focus):not(:disabled) {
      background: #a68604 !important;
      border-color: #a68604 !important;
      color: #fff !important;
    }
    .btn-borrow-request:hover:not(:disabled) {
      background: #8d7003 !important;
      border-color: #8d7003 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(166,134,4,0.3);
      color: #fff !important;
    }
    .btn-borrow-request:active:not(:disabled) {
      transform: translateY(0);
      background: #8d7003 !important;
      border-color: #8d7003 !important;
      color: #fff !important;
    }
    .btn-borrow-request:focus {
      background: #a68604 !important;
      border-color: #a68604 !important;
      color: #fff !important;
      box-shadow: 0 0 0 3px rgba(166,134,4,0.25);
    }
    .btn-borrow-request:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: var(--text-muted) !important;
      border-color: var(--text-muted) !important;
      color: #fff !important;
    }
    .borrow-action-help {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-top: 12px;
      text-align: center;
    }
    .borrow-action-help i {
      color: var(--gold);
      font-size: 0.9375rem;
    }
    
    @media (min-width: 992px) {
      .borrow-modal-cover {
        max-width: 160px;
      }
      .borrow-details-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 991.98px) {
      .borrow-modal-body {
        padding: 20px;
      }
      .borrow-cover-section {
        position: relative;
        top: 0;
      }
      .borrow-details-grid {
        grid-template-columns: 1fr;
      }
      .borrow-book-title {
        font-size: 1.25rem;
      }
      .duration-options {
        flex-direction: column;
      }
      .duration-option {
        width: 100%;
      }
    }
    .request-section {
      margin-bottom: 28px;
    }
    .request-section:last-child {
      margin-bottom: 0;
    }
    .request-section-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: var(--sidebar-bg);
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
    }
    .request-section-title i {
      color: #fff;
      font-size: 1rem;
    }
    .book-info-card {
      background: #f8f9fa;
      border-radius: var(--border-radius);
      padding: 16px;
      border: 1px solid #eef0f3;
    }
    .book-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .book-meta {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .book-meta i {
      color: var(--text-secondary);
      font-size: 0.875rem;
      width: 16px;
    }
    .info-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid #eef0f3;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
      min-width: 120px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .info-label i {
      color: var(--text-secondary);
      font-size: 0.875rem;
      width: 16px;
    }
    .info-value {
      color: var(--text-primary);
      font-size: 0.9375rem;
      font-weight: 500;
    }
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
      align-items: center;
    }
    .action-buttons .btn {
      padding: 12px 24px;
      font-weight: 600;
      border-radius: var(--border-radius-sm);
      transition: all 0.2s ease;
      width: auto;
      min-width: 200px;
      max-width: 280px;
    }
    .action-buttons .btn-success {
      background: var(--brand-gold);
      border-color: var(--brand-gold);
      color: #fff;
    }
    .action-buttons .btn-success:hover {
      background: var(--gold-dark);
      border-color: var(--gold-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(166,134,4,0.3);
    }
    .action-buttons .btn-secondary {
      background: #6c757d;
      border-color: #6c757d;
      color: #fff;
    }
    .action-buttons .btn-secondary:hover {
      background: #5a6268;
      border-color: #5a6268;
    }
    .action-buttons .btn-primary {
      background: #0d6efd;
      border-color: #0d6efd;
      color: #fff;
    }
    .action-buttons .btn-primary:hover {
      background: #0b5ed7;
      border-color: #0a58ca;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(13,110,253,0.3);
    }
    .action-buttons .btn-danger {
      background: #dc3545;
      border-color: #dc3545;
      color: #fff;
    }
    .action-buttons .btn-danger:hover {
      background: #bb2d3b;
      border-color: #b02a37;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(220,53,69,0.3);
    }
    
    /* Form Actions - Modern Buttons */
    .form-actions {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-top: 48px;
      padding-top: 36px;
      border-top: 1px solid #e5e7eb;
      flex-wrap: wrap;
      position: relative;
    }
    .form-actions .btn-primary {
      background: var(--brand-gold);
      border: none;
      color: #fff;
      font-weight: 600;
      padding: 16px 36px;
      border-radius: 12px;
      transition: transform 0.2s ease;
      font-size: 0.9375rem;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.02em;
    }
    .form-actions .btn-primary:hover {
      background: var(--gold-dark);
      transform: translateY(-2px);
    }
    .form-actions .btn-primary:active {
      transform: translateY(0);
    }
    .form-actions .btn-ghost {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      color: var(--text-secondary);
      font-weight: 600;
      padding: 16px 36px;
      border-radius: 12px;
      transition: all 0.2s ease;
      font-size: 0.9375rem;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .form-actions .btn-ghost:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      color: var(--text-primary);
    }
    .form-actions .btn-ghost:active {
      background: #d1d5db;
    }
    
    /* Responsive adjustments */
    @media (max-width: 991px) {
      .add-edit-section form {
        padding: 24px;
      }
      .cover-card {
        position: static;
        margin-bottom: 32px;
      }
      .cover-drop-area {
        min-height: 280px;
      }
      .form-section {
        margin-bottom: 32px;
        padding-bottom: 24px;
      }
    }
    
    /* Category Chips - Active State Black */
    .chips-container .chip.active {
      background: #111 !important;
      color: #fff !important;
      border-color: #111 !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Image error handling */
    img[src*="cover"], img[src*="uploads"]{
      object-fit:cover;
      background:#f0f0f0;
    }
    img[src*="cover"]:not([src*="default"]):not([src*="avatar"]):not([src*="book"]){
      background:linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
    }
    
    /* All Books Modal - Center content and reduce margins */
    #allBooksModal .modal-body {
      padding: 20px !important;
    }
    #allBooksModal .book-grid {
      justify-content: center !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
    }
    #allBooksModal .chips-container {
      justify-content: center !important;
    }
    #allBooksModal .nav-tabs {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 24px;
      border-bottom: 2px solid #e5e7eb !important;
    }
    #allBooksModal .nav-tabs .nav-link {
      background: transparent !important;
      color: var(--text-secondary) !important;
      border: none !important;
      border-bottom: 3px solid transparent !important;
      padding: 12px 20px !important;
      font-weight: 600 !important;
      font-size: 0.9375rem !important;
      transition: all 0.2s ease;
      margin-bottom: -2px;
    }
    #allBooksModal .nav-tabs .nav-link:hover {
      color: var(--text-primary) !important;
      border-bottom-color: rgba(166, 134, 4, 0.3) !important;
    }
    #allBooksModal .nav-tabs .nav-link.active {
      color: var(--text-primary) !important;
      border-bottom-color: var(--brand-gold) !important;
      background: transparent !important;
    }
    #allBooksModal .tab-content {
      min-height: 300px;
    }

    /* Borrow Modal Styling - Matching Add Student Modal */
    #borrowModal .modal-content{
      border-radius:var(--border-radius-lg);
      border:none;
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      overflow:visible !important;
    }
    #borrowModal .modal-header-dark{
      background:var(--sidebar-bg) !important;
      color:#fff !important;
      border-bottom:none !important;
      border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0 !important;
      padding:24px 32px !important;
      min-height:64px !important;
    }
    #borrowModal .modal-header-dark .modal-title{
      color:#fff !important;
      font-weight:700 !important;
      font-size:1.25rem;
      letter-spacing:-0.01em;
    }
    #borrowModal .modal-header-dark .btn-close,
    #borrowModal .modal-header-dark .btn-close-custom{
      filter:invert(1) grayscale(1);
      opacity:0.8;
      transition:opacity 0.2s ease;
      padding:4px;
      background:none !important;
      border:none !important;
      box-shadow:none !important;
      width:1.25rem;
      height:1.25rem;
      background-size:1rem 1rem !important;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #borrowModal .modal-header-dark .btn-close::before,
    #borrowModal .modal-header-dark .btn-close-custom::before{
      content:'×';
      font-size:1.5rem;
      line-height:1;
      font-weight:300;
    }
    #borrowModal .modal-header-dark .btn-close:hover,
    #borrowModal .modal-header-dark .btn-close-custom:hover{
      opacity:1;
      background:none !important;
      box-shadow:none !important;
    }

    /* Modern Form Styling */
    #borrowModal .modal-body{
      padding:32px !important;
      background:#fff;
      overflow:visible !important;
    }
    #borrowModal .modal-content{
      overflow:visible !important;
    }
    #borrowModal .modal-dialog{
      overflow:visible !important;
    }
    #borrowModal .form-label{
      font-weight:600;
      font-size:0.875rem;
      color:#374151;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    #borrowModal .form-control,
    #borrowModal .form-select{
      padding:10px 14px;
      font-size:0.9375rem;
      border:1.5px solid #e5e7eb;
      border-radius:8px;
      background:#fff;
      color:#111827;
      transition:all 0.2s ease;
    }
    #borrowModal .form-control:focus,
    #borrowModal .form-select:focus{
      border-color:var(--brand-gold);
      box-shadow:0 0 0 3px rgba(166,134,4,0.1);
      outline:none;
    }
    #borrowModal .form-control:hover:not(:focus),
    #borrowModal .form-select:hover:not(:focus){
      border-color:#d1d5db;
    }
    #borrowModal .form-control::placeholder{
      color:#9ca3af;
      font-size:0.875rem;
    }
    #borrowModal .form-control.is-invalid,
    #borrowModal .form-select.is-invalid{
      border-color:#dc3545;
      background-color:#fef2f2;
    }
    #borrowModal .form-control.is-invalid:focus,
    #borrowModal .form-select.is-invalid:focus{
      border-color:#dc3545;
      box-shadow:0 0 0 3px rgba(220,53,69,0.1);
    }
    #borrowModal .modal-footer{
      padding:20px 32px;
      border-top:1px solid #e5e7eb;
      background:#f9fafb;
      border-radius:0 0 var(--border-radius-lg) var(--border-radius-lg);
      display:flex;
      justify-content:flex-end;
      gap:12px;
    }
    #borrowModal .modal-footer .btn{
      border-radius:8px;
      font-weight:600;
      font-size:0.9375rem;
      padding:10px 24px;
      min-width:100px;
      transition:all 0.2s ease;
      border-width:1.5px;
    }
    #borrowModal .modal-footer .btn-light,
    #borrowModal .modal-footer .btn-secondary{
      background:#fff !important;
      border-color:#d1d5db !important;
      color:#374151 !important;
    }
    #borrowModal .modal-footer .btn-light:hover,
    #borrowModal .modal-footer .btn-secondary:hover{
      background:#f9fafb !important;
      border-color:#9ca3af !important;
      color:#111827 !important;
      transform:translateY(-1px);
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    #borrowModal .modal-footer .btn-primary{
      background:var(--brand-gold) !important;
      border-color:var(--brand-gold) !important;
      color:#fff !important;
      box-shadow:0 2px 4px rgba(166,134,4,0.2);
    }
    #borrowModal .modal-footer .btn-primary:hover{
      background:var(--gold-dark) !important;
      border-color:var(--gold-dark) !important;
      color:#fff !important;
      transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(166,134,4,0.3);
    }
    #borrowModal .modal-footer .btn:active{
      transform:translateY(0);
    }
    /* Book Info Display Styling */
    #borrowModal .book-info-item{
      margin-bottom:20px;
    }
    #borrowModal .book-info-item .info-label{
      font-size:0.75rem;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-weight:600;
      margin-bottom:6px;
    }
    #borrowModal .book-info-item .info-value{
      font-size:0.9375rem;
      color:#111827;
      font-weight:500;
    }
    #borrowModal .book-info-item .info-value.fw-semibold{
      font-weight:600;
      color:#111827;
    }
  </style>
</head>

<body class="sb-body loading">
<div id="sidebar-root"></div>

<div class="sb-wrapper">
  <nav class="sb-topbar navbar navbar-expand sticky-top admin-header-gold">
    <div class="container-fluid">
      <button id="sidebarToggle" class="btn btn-link text-dark me-2" aria-label="Toggle sidebar">
        <i class="bi bi-list fs-4"></i>
      </button>
      <div class="fw-bold h5 mb-0" id="pageTitle">Books</div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <div class="dropdown">
          <button class="btn btn-light border btn-icon admin-btn-custom" data-bs-toggle="dropdown" id="userBtn" style="padding:0; width:44px; height:44px; border-radius:50%;">
            <img src="assets/img/default-avatar.png" alt="Profile" class="avatar-32" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li class="px-3 py-2 small text-muted" id="whoChip">—</li>
            <li><a class="dropdown-item" href="student-profile.html"><i class="bi bi-gear me-2"></i>Profile</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
          </ul>
  </div>
      </div>
    </div>
  </nav>

  <main class="sb-content container-fluid py-4" style="padding:24px!important;">
    <!-- DISCOVER -->
    <section id="panelDiscover" class="card" style="border-radius:var(--border-radius-lg); box-shadow:var(--shadow-sm); border:1px solid var(--card-border);">
      <div class="card-body p-4">
    <!-- Tabs with Icons -->
    <div class="tabs-container mb-4">
      <div class="nav nav-pills" role="tablist">
        <button id="tabDiscover" class="nav-link active" role="tab" aria-selected="true">
          <i class="bi bi-book me-2"></i> Discover
        </button>
        <button id="tabAdd" class="nav-link" role="tab" aria-selected="false">
          <i class="bi bi-plus-circle me-2"></i> Add Book
        </button>
      </div>
    </div>
      <!-- Search and Sort Bar -->
      <div class="row g-3 align-items-center mb-4">
        <div class="col-lg-6">
          <div class="input-group search-bar-custom" style="max-width:520px;">
            <span class="input-group-text">
              <i class="bi bi-search"></i>
            </span>
            <input id="q" class="form-control" placeholder="Search title, author, ISBN…">
          </div>
        </div>
        <div class="col-lg-6 d-flex justify-content-end align-items-center gap-3 flex-wrap">
          <div class="d-flex align-items-center gap-2 flex-nowrap">
            <label class="text-muted small mb-0 fw-semibold" style="color:var(--text-secondary); white-space:nowrap;">
              <i class="bi bi-arrow-down-up me-1"></i>Sort by:
            </label>
            <select id="sortBy" class="form-select form-select-sm sort-dropdown" style="min-width:160px;border-radius:var(--border-radius-sm); border:1px solid #111; background:#111; color:#fff; font-size:0.875rem; padding:8px 32px 8px 12px;">
              <option value="title_asc">Title (A–Z)</option>
              <option value="author_asc">Author</option>
              <option value="borrowed_desc">Most Borrowed</option>
              <option value="newest">Newest Added</option>
            </select>
            <span class="badge px-3 py-2" style="background:var(--brand-gold); color:#fff; font-size:0.875rem; font-weight:600; border-radius:999px; white-space:nowrap;" id="countInfo">0 total</span>
          </div>
        </div>
      </div>

      <!-- Categories Section -->
      <div class="section-spacing">
        <hr style="border:none; border-top:1px solid var(--card-border); margin:24px 0;">
        <div class="mb-3">
          <span class="badge" style="background:var(--brand-gold); color:#fff; padding:8px 16px; font-size:0.875rem; font-weight:600; border-radius:999px;">Categories</span>
        </div>
        <div id="catChips" class="chips-container"></div>
      </div>

      <!-- Book Grid Section -->
      <div class="section-spacing">
        <div class="mb-3">
          <span class="badge" style="background:var(--brand-gold); color:#fff; padding:8px 16px; font-size:0.875rem; font-weight:600; border-radius:999px;">Book List Grid</span>
        </div>
        <div id="grid" class="book-grid"></div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-4 pt-3" style="border-top:1px solid var(--card-border);">
        <div class="small text-muted" id="pageInfo"></div>
        <div class="btn-group">
          <button id="prev" class="btn btn-outline-secondary btn-sm" style="border-radius:var(--border-radius-sm); border-color:var(--card-border);"><i class="bi bi-chevron-left"></i></button>
          <button id="next" class="btn btn-outline-secondary btn-sm" style="border-radius:var(--border-radius-sm); border-color:var(--card-border);"><i class="bi bi-chevron-right"></i></button>
        </div>
        </div>
      </div>
    </section>

    <!-- ADD/EDIT (librarian only) -->
    <section id="panelAdd" class="add-edit-section d-none">
      <form id="bookForm" novalidate enctype="multipart/form-data">
        <!-- Title Bar Inside Form -->
      <div class="page-header mb-4">
          <div>
        <h4 class="mb-0 fw-bold" id="pageHeaderTitle">Add New Book</h4>
            <p class="text-muted mb-0 mt-2" style="font-size: 0.9375rem;">Fill in the details below to add a new book to the library</p>
      </div>
        </div>
        <div class="row g-5">
          <!-- Left Column: Cover -->
          <div class="col-12 col-lg-4">
            <div class="cover-card">
              <h6 class="section-header mb-3">
                <i class="bi bi-image me-2"></i> Cover
              </h6>
              <div id="dropArea" class="cover-drop-area" role="button" tabindex="0">
                <input id="coverInput" name="cover" type="file" accept="image/*" class="d-none">
                <img id="coverPreview" alt="" class="cover-preview d-none">
                <div id="dropHint" class="drop-hint text-center">
                  <i class="bi bi-image fs-1 d-block mb-2 text-muted"></i>
                  <div class="fw-medium">Click to choose or drop an image</div>
                  <small class="text-muted d-block mt-1">Max 5 MB · JPG/PNG/WebP/GIF</small>
                </div>
              </div>
              <div class="cover-actions mt-3">
                <button type="button" id="btnChangeImage" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-upload me-1"></i> Change
                </button>
                <button type="button" id="btnRemoveImage" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-x-lg me-1"></i> Remove
                </button>
              </div>
            </div>
          </div>

          <!-- Right Column: Form -->
          <div class="col-12 col-lg-8" style="overflow: visible;">
            <div class="form-container" style="overflow: visible;">
              <!-- Book Information Section -->
              <div class="form-section">
                <h6 class="section-header mb-3">
                  <i class="bi bi-journal-text me-2"></i> Book Information
                </h6>
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label fw-medium">Title</label>
                    <input id="title" name="title" type="text" class="form-control form-control-enhanced" placeholder="Enter book title" required>
                    <div class="invalid-feedback">Title is required.</div>
                  </div>

                  <div class="col-12 col-md-6">
                    <label class="form-label fw-medium">Author</label>
                    <input id="author" name="author" type="text" class="form-control form-control-enhanced" placeholder="Enter author name" required>
                    <div class="invalid-feedback">Author is required.</div>
                  </div>

                  <div class="col-12 col-md-6">
                    <label class="form-label fw-medium">ISBN</label>
                    <input id="isbn" name="isbn" type="text" class="form-control form-control-enhanced" placeholder="9780452284234" maxlength="20" required>
                    <div class="invalid-feedback" id="isbnError">ISBN is required.</div>
                    <small id="isbnFormatHelp" class="form-text text-muted">Enter ISBN-13 (13 digits, e.g., 9780123456789)</small>
                    <small id="isbnHelpText" class="form-text text-muted" style="display: none;">
                      <i class="bi bi-lock-fill me-1"></i>ISBN cannot be changed when editing a book.
                    </small>
                  </div>

                  <div class="col-12 col-md-8">
                    <label class="form-label fw-medium">Category</label>
                    <select id="category" name="category" class="form-select form-control-enhanced" required style="max-width: 100%;">
                      <option value="" selected disabled>Select category</option>
                      <option>Action and Adventure</option>
                      <option>Biography</option>
                      <option>Children's Books</option>
                      <option>Computer Science</option>
                      <option>Fantasy</option>
                      <option>History</option>
                      <option>Mystery</option>
                      <option>Romance</option>
                      <option>Science</option>
                    </select>
                    <div class="invalid-feedback">Category is required.</div>
                  </div>
                </div>
              </div>

              <!-- Publishing Details Section -->
              <div class="form-section">
                <h6 class="section-header mb-3">
                  <i class="bi bi-file-earmark-text me-2"></i> Publishing Details
                </h6>
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label class="form-label fw-medium">Publisher</label>
                    <input id="publisher" name="publisher" type="text" class="form-control form-control-enhanced" placeholder="Enter publisher name" required>
                    <div class="invalid-feedback">Publisher is required.</div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label fw-medium">Date Published <span class="text-danger">*</span></label>
                    <input id="publishedAt" name="date_published" type="date" class="form-control form-control-enhanced" required>
                    <div class="invalid-feedback">Date Published is required.</div>
                    <small id="datePublishedHelpText" class="form-text text-muted" style="display: none;">
                      <i class="bi bi-lock-fill me-1"></i>Date Published cannot be changed when editing a book.
                    </small>
                  </div>
                </div>
              </div>

              <!-- Inventory Section -->
              <div class="form-section">
                <h6 class="section-header mb-3">
                  <i class="bi bi-box-seam me-2"></i> Inventory
                </h6>
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label class="form-label fw-medium">Quantity</label>
                    <input id="quantity" name="quantity" type="number" min="1" step="1" class="form-control form-control-enhanced" placeholder="Enter quantity" required>
                    <div class="invalid-feedback">Quantity is required.</div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label fw-medium">Status</label>
                    <div class="status-display">
                      <span class="badge bg-success" id="statusBadge">
                        <i class="bi bi-check-circle me-1"></i> In Stock
                      </span>
                      <small class="text-muted d-block mt-1">Auto-calculated based on quantity</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Form Actions -->
              <div class="form-actions mt-4 pt-3 border-top">
                <button id="btnSave" type="submit" class="btn btn-primary btn-lg">
                  <i class="bi bi-save me-2"></i> <span id="btnSaveText">Save Book</span>
                </button>
                <button type="button" id="btnGoDiscover" class="btn btn-ghost btn-lg">
                  <i class="bi bi-arrow-left me-2"></i> Back to Books
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </section>

    <!-- Cover Preview Modal -->
    <div class="modal fade" id="coverPreviewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title">Cover Preview</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center p-4">
            <img id="coverPreviewFull" src="" alt="Book cover preview" class="img-fluid rounded shadow" style="max-height: 600px;">
          </div>
        </div>
      </div>
    </div>

    <!-- Book details offcanvas -->
    <div class="offcanvas offcanvas-end request-drawer" tabindex="-1" id="bookDetails" aria-labelledby="bookDetailsLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="bookDetailsLabel">Book</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body" id="detailsBody"></div>
    </div>

    <!-- All Books Modal -->
    <div class="modal fade" id="allBooksModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content" style="border-radius:var(--border-radius-lg);">
          <div class="modal-header" style="background:var(--sidebar-bg); color:#fff; border-bottom:0; padding:20px 24px;">
            <h5 class="modal-title" style="color:#fff; font-weight:700;">All Books</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="padding:24px; max-height:85vh; overflow-y:auto;">
            <!-- Categories Section -->
            <div class="mb-4">
              <div class="mb-3">
                <span class="badge" style="background:var(--brand-gold); color:#fff; padding:8px 16px; font-size:0.875rem; font-weight:600; border-radius:999px;">Categories</span>
              </div>
              <div id="modalCatChips" class="chips-container"></div>
            </div>

            <!-- Book List Grid -->
            <div id="modalBookGrid" class="book-grid" style="gap:16px; justify-content:center;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Borrow Request Modal (Student only) -->
    <div class="modal fade" id="borrowModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header modal-header-dark">
            <h5 class="modal-title">Request to Borrow Book</h5>
            <button type="button" class="btn-close btn-close-custom" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body borrow-modal-body">
            <div class="row g-4">
              <!-- Book Cover Column -->
              <div class="col-12 col-lg-4">
                <div class="borrow-cover-section">
                  <div class="book-cover-wrapper mb-4">
                    <img id="borrowBookCover" src="assets/img/no-cover.png" alt="Book cover" class="borrow-modal-cover" onerror="this.src='assets/img/no-cover.png'; this.onerror=null;">
                    <div class="cover-overlay">
                      <i class="bi bi-book"></i>
                    </div>
                  </div>
                  <div class="availability-card" id="borrowAvailabilityBadge">
                    <div class="availability-icon">
                      <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="availability-content">
                      <div class="availability-label">Status</div>
                      <div class="availability-text" id="borrowAvailabilityText">Available for Request</div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Book Info Column -->
              <div class="col-12 col-lg-8">
                <!-- Main Book Info -->
                <div class="borrow-book-header">
                  <div class="book-title-section">
                    <h4 class="borrow-book-title" id="borrowBookTitle">—</h4>
                    <div class="borrow-book-author" id="borrowBookAuthor">—</div>
                  </div>
                </div>

                <!-- Book Details Cards -->
                <div class="borrow-details-container">
                  <div class="borrow-details-card">
                    <div class="card-header-section">
                      <i class="bi bi-info-circle-fill"></i>
                      <span>Book Information</span>
                    </div>
                    <div class="borrow-details-grid">
                      <div class="borrow-detail-item">
                        <div class="borrow-detail-label">
                          <i class="bi bi-upc-scan"></i>
                          <span>ISBN</span>
                        </div>
                        <div class="borrow-detail-value" id="borrowBookIsbn">—</div>
                      </div>
                      <div class="borrow-detail-item">
                        <div class="borrow-detail-label">
                          <i class="bi bi-tag-fill"></i>
                          <span>Category</span>
                        </div>
                        <div class="borrow-detail-value" id="borrowBookCategory">—</div>
                      </div>
                      <div class="borrow-detail-item">
                        <div class="borrow-detail-label">
                          <i class="bi bi-building"></i>
                          <span>Publisher</span>
                        </div>
                        <div class="borrow-detail-value" id="borrowBookPublisher">—</div>
                      </div>
                      <div class="borrow-detail-item">
                        <div class="borrow-detail-label">
                          <i class="bi bi-calendar3"></i>
                          <span>Published Date</span>
                        </div>
                        <div class="borrow-detail-value" id="borrowBookPublished">—</div>
                      </div>
                    </div>
                  </div>

                  <div class="borrow-details-card">
                    <div class="card-header-section">
                      <i class="bi bi-box-seam-fill"></i>
                      <span>Availability</span>
                    </div>
                    <div class="borrow-details-grid">
                      <div class="borrow-detail-item full-width">
                        <div class="borrow-detail-label">
                          <i class="bi bi-stack"></i>
                          <span>Copies Available</span>
                        </div>
                        <div class="borrow-detail-value quantity-display" id="borrowBookQuantity">—</div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Requested Borrow Duration Section -->
                <div class="borrow-duration-card">
                  <div class="card-header-section">
                    <i class="bi bi-clock-history"></i>
                    <span>Requested Borrow Duration</span>
                  </div>
                  <div class="duration-content">
                    <select id="borrowDuration" class="form-select borrow-duration-select" required>
                      <option value="3">3 days</option>
                      <option value="7" selected>7 days</option>
                      <option value="14">14 days</option>
                    </select>
                    <div class="duration-options">
                      <div class="duration-option" data-days="3">
                        <i class="bi bi-calendar-day"></i>
                        <span>3 Days</span>
                      </div>
                      <div class="duration-option active" data-days="7">
                        <i class="bi bi-calendar-week"></i>
                        <span>7 Days</span>
                      </div>
                      <div class="duration-option" data-days="14">
                        <i class="bi bi-calendar-month"></i>
                        <span>14 Days</span>
                      </div>
                    </div>
                    <small class="borrow-duration-help">
                      <i class="bi bi-info-circle me-1"></i>
                      Select your preferred borrow duration. Final approval and due date will be confirmed by the librarian.
                    </small>
                  </div>
                </div>

                <!-- Primary Action Button -->
                <div class="borrow-action-section">
                  <button type="button" class="btn btn-borrow-request" id="btnSubmitBorrowRequest" style="background: #a68604 !important; border-color: #a68604 !important; color: #fff !important;">
                    <i class="bi bi-book me-2"></i>
                    <span>Request to Borrow</span>
                  </button>
                  <small class="borrow-action-help">
                    <i class="bi bi-shield-check me-1"></i>
                    Your request will be reviewed by a librarian before approval.
                  </small>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer d-none">
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center py-4">
            <div class="mb-3">
              <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
            </div>
            <h5 class="modal-title mb-3" id="successModalTitle">Success!</h5>
            <p class="mb-0" id="successModalMessage">Operation completed successfully.</p>
          </div>
          <div class="modal-footer border-0 justify-content-center">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center py-4">
            <div class="mb-3">
              <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 4rem;"></i>
            </div>
            <h5 class="modal-title mb-3" id="errorModalTitle">Error</h5>
            <p class="mb-0" id="errorModalMessage">An error occurred.</p>
          </div>
          <div class="modal-footer border-0 justify-content-center">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
      <div id="toastSaved" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body"><i class="bi bi-check2-circle me-2"></i><span id="toastMsg">Book saved.</span></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Confirm Delete Modal -->
<div class="modal" id="deleteConfirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm-fixed">
    <div class="modal-content lt-modal text-center">
      <div class="lt-icon lt-icon-danger">
        <i class="bi bi-exclamation-triangle-fill"></i>
      </div>
      <h5 class="lt-title">Delete Book</h5>
      <p class="lt-text" id="deleteConfirmText">
        Are you sure you want to delete this book? This action cannot be undone.
      </p>
      <div class="lt-actions">
        <button type="button" class="btn lt-btn lt-btn-neutral" data-bs-dismiss="modal">Cancel</button>
        <button id="btnConfirmDelete" type="button" class="btn lt-btn lt-btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Success Modal -->
<div class="modal fade" id="deleteSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm-fixed">
    <div class="modal-content lt-modal text-center">
      <div class="lt-icon lt-icon-success">
        <i class="bi bi-check-circle-fill"></i>
      </div>
      <h5 class="lt-title">Book Deleted Successfully</h5>
      <div class="lt-actions">
        <button type="button" class="btn lt-btn lt-btn-neutral" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Book Update Success Modal -->
<div class="modal fade" id="bookUpdateSuccessModal" tabindex="-1" aria-hidden="false">
  <div class="modal-dialog modal-dialog-centered modal-sm-fixed">
    <div class="modal-content lt-modal text-center">
      <div class="lt-icon lt-icon-success">
        <i class="bi bi-check-circle-fill"></i>
      </div>
      <h5 class="lt-title" id="bookUpdateSuccessTitle">Book Updated Successfully</h5>
      <div class="lt-actions">
        <button type="button" class="btn lt-btn lt-btn-danger" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Error Modal -->
<div class="modal" id="deleteErrorModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-sm-fixed">
    <div class="modal-content lt-modal text-center">
      <div class="lt-icon lt-icon-danger">
        <i class="bi bi-exclamation-triangle-fill"></i>
      </div>
      <h5 class="lt-title">Cannot Delete Book</h5>
      <p class="lt-text" id="deleteErrorMessage">An error occurred while deleting the book.</p>
      <div class="lt-actions">
        <button type="button" class="btn lt-btn lt-btn-danger" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Vendor JS -->
<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/logout.js"></script>

<script>
async function getMe(){
  try{
    const res = await fetch('/api/check-auth', {credentials:'include'});
    if (!res.ok) return null;
    const data = await res.json().catch(()=>null);
    return data?.user || null;
  }catch{ return null; }
}

(async ()=>{
  const me = await getMe();
  const role = (me?.role || 'student').toLowerCase();

  if (typeof renderSidebar === 'function') renderSidebar('books', role);
  document.getElementById('sidebarToggle')?.addEventListener('click', ()=>{
    if (typeof toggleSidebar === 'function') toggleSidebar();
    else document.body.classList.toggle('sb-collapsed');
  });

  initBooks(role);
  document.body.classList.remove('loading');
})();

function initBooks(role){
  const API_LIST     = '/api/books';
  const API_CREATE   = '/api/books';
  const API_EDIT     = '/api/books';
  const API_DELETE   = '/api/books';
  const API_FAVORITE = '/api/favorites/toggle';

  const canManage = () => role === 'librarian';

  // ISBN Validation Functions (ISBN-13 only)
  function validateISBN(isbn) {
    // 1. Required Field
    if (!isbn || !isbn.trim()) {
      return { valid: false, error: 'ISBN is required.' };
    }

    // Auto-trim whitespace
    isbn = isbn.trim();

    // 2. Allowed Characters (only digits, hyphens, and spaces - no X allowed for ISBN-13)
    if (!/^[0-9\s\-]+$/.test(isbn)) {
      return { valid: false, error: 'ISBN must contain only digits.' };
    }

    // 3. Clean Format: Remove hyphens and spaces
    let cleaned = isbn.replace(/[\s\-]/g, '');

    // 4. Check length (must be exactly 13 digits)
    // Note: Hyphens and spaces are NOT counted - only digits matter
    const digitCount = cleaned.length;
    if (digitCount !== 13) {
      return { valid: false, error: `ISBN must contain exactly 13 digits (you have ${digitCount} digit${digitCount !== 1 ? 's' : ''}). Hyphens are not counted.` };
    }

    // 5. Validate ISBN-13
    return validateISBN13(cleaned);
  }

  function validateISBN13(isbn) {
    // Character rules: ISBN-13 must be digits only (no X allowed)
    if (!/^[0-9]{13}$/.test(isbn)) {
      return { valid: false, error: 'Invalid character in ISBN. ISBN-13 must contain only digits.' };
    }

    // Checksum validation for ISBN-13
    let sum = 0;
    for (let i = 0; i < 12; i++) {
      const digit = parseInt(isbn[i]);
      const multiplier = (i % 2 === 0) ? 1 : 3;
      sum += digit * multiplier;
    }

    const checkDigit = (10 - (sum % 10)) % 10;
    const actualCheckDigit = parseInt(isbn[12]);

    if (checkDigit !== actualCheckDigit) {
      return { valid: false, error: 'Please enter a valid ISBN-13.' };
    }

    return { valid: true, error: null };
  }

  const tabDiscover = document.getElementById('tabDiscover');
  const tabAdd      = document.getElementById('tabAdd');
  const panelDiscover = document.getElementById('panelDiscover');
  const panelAdd      = document.getElementById('panelAdd');
  const btnGoDiscover = document.getElementById('btnGoDiscover');

  if (!canManage()) tabAdd.classList.add('d-none');

  function showDiscover(){ 
    tabDiscover.classList.add('active'); 
    tabAdd.classList.remove('active'); 
    panelDiscover.classList.remove('d-none'); 
    panelAdd.classList.add('d-none'); 
    tabDiscover.setAttribute('aria-selected', 'true');
    tabAdd.setAttribute('aria-selected', 'false');
  }
  function showAdd(){ 
    if (!canManage()) return; 
    tabAdd.classList.add('active'); 
    tabDiscover.classList.remove('active'); 
    panelAdd.classList.remove('d-none'); 
    panelDiscover.classList.add('d-none'); 
    tabAdd.setAttribute('aria-selected', 'true');
    tabDiscover.setAttribute('aria-selected', 'false');
    
    // Clear validation state when switching to Add mode
    const form = document.getElementById('bookForm');
    if (form) {
      form.classList.remove('was-validated');
      // Remove is-invalid classes from all fields
      form.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
      });
    }
    
    // Reset header for new book
    if (!editingId) {
      document.getElementById('pageHeaderTitle').textContent = 'Add New Book';
      const pageHeaderSubtitle = document.querySelector('.page-header p.text-muted');
      if (pageHeaderSubtitle) {
        pageHeaderSubtitle.textContent = 'Fill in the details below to add a new book to the library';
      }
      document.getElementById('statusBadge').className = 'badge bg-success';
      document.getElementById('statusBadge').innerHTML = '<i class="bi bi-check-circle me-1"></i> In Stock';
    }
  }
  
  // Make showDiscover available globally
  window.showDiscover = showDiscover;
  tabDiscover.onclick = showDiscover; 
  tabAdd.onclick = showAdd; 
  btnGoDiscover && (btnGoDiscover.onclick = showDiscover);

  const qInput    = document.getElementById('q');
  const grid      = document.getElementById('grid');
  const catChips  = document.getElementById('catChips');

  const state = { page:1, pagesize:12, q:'', cat:'', sort:'newest' };
  let ALL_CATS = ["All"]; // Will be populated from API
  const esc = (s='') => s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

  // Default fallback categories (used if API fails or returns empty)
  const DEFAULT_CATEGORIES = [
    "Action and Adventure",
    "Biography",
    "Children's Books",
    "Computer Science",
    "Fantasy",
    "History",
    "Mystery",
    "Romance",
    "Science",
    "Thriller"
  ];

  // Load categories from API
  async function loadCategories() {
    try {
      const res = await fetch('/api/categories', { credentials: 'include' });
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();
      if (data.success && data.categories && Array.isArray(data.categories)) {
        // Extract category names from API
        const apiCategoryNames = data.categories.map(cat => cat.name || cat).filter(Boolean);
        
        // Merge API categories with defaults (API categories take priority, defaults fill gaps)
        // Create a Set to avoid duplicates (case-insensitive)
        const categorySet = new Set();
        const lowerToOriginal = new Map();
        
        // Add API categories first (these are admin-added, so they take priority)
        apiCategoryNames.forEach(name => {
          const lower = name.toLowerCase();
          categorySet.add(lower);
          lowerToOriginal.set(lower, name);
        });
        
        // Add default categories that aren't already in the set
        DEFAULT_CATEGORIES.forEach(name => {
          const lower = name.toLowerCase();
          if (!categorySet.has(lower)) {
            categorySet.add(lower);
            lowerToOriginal.set(lower, name);
          }
        });
        
        // Convert back to array of original names, sorted
        const categoriesToUse = Array.from(categorySet)
          .map(lower => lowerToOriginal.get(lower))
          .sort();
        
        ALL_CATS = ["All", ...categoriesToUse];
        
        // Update category dropdown in add book form
        const categorySelect = document.getElementById('category');
        if (categorySelect) {
          const currentValue = categorySelect.value;
          categorySelect.innerHTML = '<option value="" selected disabled>Select category</option>' +
            categoriesToUse.map(name => `<option value="${esc(name)}">${esc(name)}</option>`).join('');
          if (currentValue) {
            categorySelect.value = currentValue;
          }
        }
        
        // Re-render chips if they exist (wait for DOM to be ready)
        setTimeout(() => {
          if (catChips || document.getElementById('catChips')) {
            renderChips();
          }
        }, 100);
        
        return true;
      } else {
        console.warn('Categories API returned unexpected format:', data);
        // Fallback to defaults
        useDefaultCategories();
        return false;
      }
    } catch (e) {
      console.error('Failed to load categories:', e);
      // Fallback to defaults on error
      useDefaultCategories();
      return false;
    }
  }

  // Helper function to use default categories
  function useDefaultCategories() {
    ALL_CATS = ["All", ...DEFAULT_CATEGORIES];
    
    const categorySelect = document.getElementById('category');
    if (categorySelect) {
      const currentValue = categorySelect.value;
      categorySelect.innerHTML = '<option value="" selected disabled>Select category</option>' +
        DEFAULT_CATEGORIES.map(name => `<option value="${esc(name)}">${esc(name)}</option>`).join('');
      if (currentValue) {
        categorySelect.value = currentValue;
      }
    }
    
    setTimeout(() => {
      if (catChips || document.getElementById('catChips')) {
        renderChips();
      }
    }, 100);
  }

  const renderStars = (rating=0)=>{
    const r = Math.max(0, Math.min(5, Math.round(Number(rating)||0)));
    return Array.from({length:5},(_,i)=>`<i class="bi ${i<r?'bi-star-fill':'bi-star'}"></i>`).join('');
  };
  
  // Helper function to fix cover URLs
  const fixCoverUrl = (url) => {
    if (!url) return 'assets/img/no-cover.png';
    // If already a full URL or starts with /, use as-is
    if (url.startsWith('http') || url.startsWith('/')) {
      // Add a tiny cache-buster to ensure updated covers appear immediately
      const cb = `cb=${Date.now()}`;
      return url.includes('?') ? `${url}&${cb}` : `${url}?${cb}`;
    }
    // Otherwise, assume it's a filename and prepend the path
    return `/uploads/covers/${url}?cb=${Date.now()}`;
  };
  const renderHeart = (book)=>{
    if (role!=='student') return '';
    const cls = book.is_favorite ? 'bi-heart-fill text-danger' : 'bi-heart';
    return `<button class="btn-fav" title="${book.is_favorite?'Remove from favorites':'Add to favorites'}" data-id="${book.id}">
              <i class="bi ${cls}"></i>
            </button>`;
  };

  function renderChips(){
    const container = document.getElementById('catChips') || catChips;
    container.innerHTML = ALL_CATS.map(c=>{
      const v = c==='All' ? '' : c;
      return `<button class="chip ${state.cat===v?'active':''}" data-cat="${v}">${c}</button>`;
    }).join('');
    container.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click',()=>{ state.cat = btn.dataset.cat||''; state.page=1; loadGrid(); renderChips(); });
    });
  }


  // Sort items based on state.sort
  function sortItems(items) {
    const sorted = [...items];
    switch(state.sort) {
      case 'title_asc':
        return sorted.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
      case 'author_asc':
        return sorted.sort((a, b) => (a.author || '').localeCompare(b.author || ''));
      case 'borrowed_desc':
        return sorted.sort((a, b) => (b.borrowed || 0) - (a.borrowed || 0));
      case 'newest':
      default:
        return sorted.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
    }
  }

  // Render skeleton book cards
  function renderSkeletonCards(count = 8) {
    return Array.from({length: count}, () => `
      <div class="grid-item">
        <div class="book-card p-2 skeleton-book-card">
          <div class="cover-wrap position-relative">
            <div class="skeleton-cover"></div>
          </div>
          <div class="p-2 details">
            <div class="skeleton-line long"></div>
            <div class="skeleton-line medium"></div>
            <div class="skeleton-line short"></div>
            <div class="skeleton-line short" style="width: 50%; margin-top: 4px;"></div>
          </div>
          ${canManage() ? `
          <div class="card-actions">
            <div class="skeleton-button"></div>
            <div class="skeleton-button"></div>
          </div>` : ''}
        </div>
      </div>
    `).join('');
  }

  async function loadGrid(){
    // Show skeleton loaders while fetching
    grid.innerHTML = renderSkeletonCards(8);
    
    const url = `${API_LIST}?page=${state.page}&pagesize=${state.pagesize}&q=${encodeURIComponent(state.q)}&category=${encodeURIComponent(state.cat)}`;
    const data = await fetch(url,{credentials:'include'}).then(r=>r.json()).catch(()=>({ok:false}));
    if (!data.ok){ grid.innerHTML = `<div class="empty w-100">Failed to load.</div>`; return; }
    let items = data.items||[];
    
    // Apply sorting
    items = sortItems(items);

    grid.innerHTML = items.length ? items.map(b=>{
      const cover = fixCoverUrl(b.cover_url);
      const t = esc(b.title||''), a = esc(b.author||''), c = esc(b.category||''), i = esc(b.isbn||'');
      return `
        <div class="grid-item fade-in">
          <div class="book-card p-2">
            <div class="cover-wrap position-relative" role="button" onclick='showDetails(${b.id})'>
              <img class="thumb-lg" src="${cover}" alt="${t}" onerror="this.src='assets/img/no-cover.png'; this.onerror=null;">
              ${renderHeart(b)}
            </div>
            <div class="p-2 details">
              <div class="title clamp-2" title="${t}">${t}</div>
              <div class="meta author">${a||'Unknown author'}</div>
              <div class="meta genre">${c||'—'}</div>
              ${i ? `<div class="meta isbn">ISBN: ${i}</div>` : ''}
            </div>
            ${canManage() ? `
            <div class="card-actions">
              <button class="icon-btn btn-edit" data-id="${b.id}" title="Edit"><i class="bi bi-pencil-square" style="font-size:18px;"></i></button>
              <button class="icon-btn btn-delete" data-id="${b.id}" data-title="${t}" title="Delete"><i class="bi bi-trash3"></i></button>
            </div>` : ''}
          </div>
        </div>`;
    }).join('') : `<div class="empty w-100 fade-in">No books found.</div>`;

    document.getElementById('countInfo').textContent = `${data.total.toLocaleString()} total`;
    const start=(data.page-1)*data.pagesize+1, end=Math.min(data.total, data.page*data.pagesize);
    document.getElementById('pageInfo').textContent = data.total ? `Showing ${start}-${end} of ${data.total}` : '';
    document.getElementById('prev').disabled = data.page<=1;
    document.getElementById('next').disabled = data.page>=data.pages;

    bindFavoriteButtons();
    if (canManage()) bindManageButtons(items);
  }

  function setFavStateForId(bookId, favorited){
    document.querySelectorAll(`.btn-fav[data-id="${bookId}"]`).forEach(b=>{
      const icon = b.querySelector('i');
      if (!icon) return;
      // Directly set classes instead of toggling to avoid border heart flash
      if (favorited) {
        icon.className = 'bi bi-heart-fill text-danger';
      } else {
        icon.className = 'bi bi-heart';
      }
      b.title = favorited ? 'Remove from favorites' : 'Add to favorites';
    });
  }

  function bindFavoriteButtons(){
    if (role!=='student') return;
    document.querySelectorAll('.btn-fav').forEach(btn=>{
btn.onclick = async (e)=>{
  e.stopPropagation();
  const id = btn.dataset.id;
        const icon = btn.querySelector('i');
        if (!icon) return;
        
        // Optimistically update UI immediately (before API call)
        const isCurrentlyFavorited = icon.classList.contains('bi-heart-fill');
        const willBeFavorited = !isCurrentlyFavorited;
        
        // Directly set classes instead of toggling to avoid border heart flash
        if (willBeFavorited) {
          icon.className = 'bi bi-heart-fill text-danger';
        } else {
          icon.className = 'bi bi-heart';
        }
        btn.title = willBeFavorited ? 'Remove from favorites' : 'Add to favorites';
        
        // Disable button during request to prevent double-clicks
        btn.disabled = true;
        
        try{
          const res = await fetch(API_FAVORITE,{
            method:'POST', 
            credentials:'include',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({book_id: id})
          });
          
          // Check if response is ok
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          
          // Try to parse JSON response
          let data;
          try {
            const text = await res.text();
            data = text ? JSON.parse(text) : null;
          } catch (parseErr) {
            console.error('Failed to parse JSON response:', parseErr);
            throw new Error('Invalid response from server');
          }
          
          // Check if response indicates success
          if (data && data.ok === true && typeof data.favorited === 'boolean') {
            // Success - update all instances of this book's heart icon
            setFavStateForId(id, data.favorited);
          } else {
            // API returned error
            const errorMsg = data?.error || 'Failed to update favorites';
            console.error('API error:', errorMsg, data);
            
            // Revert on error
            setFavStateForId(id, isCurrentlyFavorited);
            alert(errorMsg);
          }
        }catch(err){
          // Network or other error - revert
          console.error('Favorite toggle error:', err);
          setFavStateForId(id, isCurrentlyFavorited);
          alert('Network error: ' + (err.message || 'Unable to update favorites. Please try again.'));
        } finally {
          // Re-enable button
          btn.disabled = false;
        }
      };
    });
  }

  // ---- Confirm modal helper
  function confirmDeleteModal(title) {
    return new Promise((resolve) => {
      const modalEl = document.getElementById('deleteConfirmModal');
      const textEl  = document.getElementById('deleteConfirmText');
      const okBtn   = document.getElementById('btnConfirmDelete');

      if (!modalEl || !textEl || !okBtn) {
        console.error('Delete modal elements not found');
        resolve(false);
        return;
      }

      textEl.textContent = `Are you sure you want to delete "${title}"? This action cannot be undone.`;

      // Remove any existing event listeners by cloning and replacing the button
      const newOkBtn = okBtn.cloneNode(true);
      okBtn.parentNode.replaceChild(newOkBtn, okBtn);
      
      // Update the reference to the new button
      const confirmBtn = document.getElementById('btnConfirmDelete');

      // Get or create modal instance
      let modal;
      try {
        modal = bootstrap.Modal.getOrCreateInstance(modalEl, {
          backdrop: true,
          keyboard: true,
          focus: true
        });
      } catch (e) {
        console.error('Error creating modal instance:', e);
        resolve(false);
        return;
      }
      
      // Set up event handlers
      let resolved = false;
      
      const handleConfirm = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!resolved) {
          resolved = true;
          modal.hide();
          resolve(true);
        }
      };
      
      // Attach click handler to the confirm button
      confirmBtn.addEventListener('click', handleConfirm, { once: true });
      
      // Handle cancel button
      const cancelBtn = modalEl.querySelector('[data-bs-dismiss="modal"]');
      if (cancelBtn) {
        const handleCancel = () => {
          if (!resolved) {
            resolved = true;
            resolve(false);
          }
        };
        cancelBtn.addEventListener('click', handleCancel, { once: true });
      }
      
      // Handle modal hidden event (when closed via backdrop, ESC, or any other way)
      const handleHidden = () => {
        if (!resolved) {
          resolved = true;
          resolve(false);
        }
      };
      modalEl.addEventListener('hidden.bs.modal', handleHidden, { once: true });
      
      // Show modal
      try {
        modal.show();
      } catch (e) {
        console.error('Error showing modal:', e);
        resolve(false);
      }
    });
  }

  let editingId = null;
  let currentPanelBookId = null; // Track which book is currently shown in the panel

  function bindManageButtons(items){
    document.querySelectorAll('.btn-edit').forEach(btn=>{
      btn.onclick = async ()=>{
        const id = +btn.dataset.id;
        // Always fetch fresh data from API when editing
        await startEdit(id);
      };
    });

    document.querySelectorAll('.btn-delete').forEach(btn=>{
      btn.onclick = async ()=>{
        const id = +btn.dataset.id;
        const t  = btn.dataset.title || 'this book';

        // Bootstrap confirm modal (no native confirm)
        const ok = await confirmDeleteModal(t);
        if (!ok) return;

        try{
          // Use DELETE method with ID in URL path
          const res  = await fetch(`${API_DELETE}/${id}`, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });
          
          const data = await res.json().catch(()=>null);

          if (data?.ok){
            await loadGrid();

            // success modal
            const modalEl = document.getElementById('deleteSuccessModal');
            bootstrap.Modal.getOrCreateInstance(modalEl).show();
          } else {
            // Show error modal instead of alert
            const errorModal = document.getElementById('deleteErrorModal');
            const errorMessage = document.getElementById('deleteErrorMessage');
            if (errorModal && errorMessage) {
              errorMessage.textContent = data?.error || 'Delete failed';
              bootstrap.Modal.getOrCreateInstance(errorModal).show();
            } else {
              alert(data?.error || 'Delete failed');
            }
          }
        }catch(err){
          console.error('Delete error:', err);
          // Show error modal instead of alert
          const errorModal = document.getElementById('deleteErrorModal');
          const errorMessage = document.getElementById('deleteErrorMessage');
          if (errorModal && errorMessage) {
            errorMessage.textContent = 'Network/server error: ' + (err.message || 'Unknown error');
            bootstrap.Modal.getOrCreateInstance(errorModal).show();
          } else {
            alert('Network/server error: ' + (err.message || 'Unknown error'));
          }
        }
      };
    });
  }

  async function startEdit(b){
    // If b is a number (ID), fetch fresh data from API
    if (typeof b === 'number' || (typeof b === 'string' && /^\d+$/.test(b))) {
      // Convert to number and validate
      const bookId = typeof b === 'number' ? b : parseInt(b, 10);
      if (isNaN(bookId) || bookId <= 0) {
        alert('Error: Invalid book ID. Please try again.');
        console.error('Invalid book ID in startEdit:', b);
        return;
      }
      try {
        const bookRes = await fetch(`${API_EDIT}/${bookId}`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        if (!bookRes.ok) {
          throw new Error(`HTTP ${bookRes.status}: ${bookRes.statusText}`);
        }
        const bookData = await bookRes.json();
        if (bookData.ok && bookData.data) {
          b = bookData.data;
        } else {
          alert('Failed to load book data: ' + (bookData.error || 'Unknown error'));
          return;
        }
      } catch (err) {
        alert('Failed to load book data: ' + err.message);
        console.error('Error fetching book data:', err);
        return;
      }
    }
    
    tabAdd.click();
    editingId = b.id;

    const form = document.getElementById('bookForm');
    form.classList.remove('was-validated');

    // Update header
    document.getElementById('pageHeaderTitle').textContent = `Editing Book: ${b.title || 'Untitled'}`;
    const pageHeaderSubtitle = document.querySelector('.page-header p.text-muted');
    if (pageHeaderSubtitle) {
      pageHeaderSubtitle.textContent = 'Update the book details below';
    }

    // Populate form fields - when editing, all fields are optional (librarian can update any field)
    const titleField = document.getElementById('title');
    if (titleField) {
      titleField.value = b.title || '';
      // Remove required attribute when editing - fields are optional
      titleField.removeAttribute('required');
      // Ensure field is enabled and editable
      titleField.disabled = false;
      titleField.removeAttribute('disabled');
      titleField.readOnly = false;
      titleField.removeAttribute('readonly');
    }
    const isbnField = document.getElementById('isbn');
    const isbnHelpText = document.getElementById('isbnHelpText');
    const isbnFormatHelp = document.getElementById('isbnFormatHelp');
    isbnField.value = b.isbn || '';
    // Disable ISBN field when editing - ISBN cannot be changed
    isbnField.readOnly = true;
    isbnField.setAttribute('readonly', 'readonly');
    isbnField.classList.add('bg-light');
    isbnField.style.backgroundColor = '#f3f4f6';
    isbnField.style.cursor = 'not-allowed';
    isbnField.style.opacity = '0.8';
    // Remove required attribute when editing since ISBN cannot be changed
    isbnField.removeAttribute('required');
    // Hide format help text when editing
    if (isbnFormatHelp) {
      isbnFormatHelp.style.display = 'none';
    }
    // Show helper text
    if (isbnHelpText) {
      isbnHelpText.style.display = 'block';
    }
    const authorField = document.getElementById('author');
    if (authorField) {
      authorField.value = b.author || '';
      // Remove required attribute when editing - fields are optional
      authorField.removeAttribute('required');
      // Ensure field is enabled and editable
      authorField.disabled = false;
      authorField.removeAttribute('disabled');
      authorField.readOnly = false;
      authorField.removeAttribute('readonly');
    }
    const categoryField = document.getElementById('category');
    if (categoryField) {
      categoryField.value = b.category || '';
      // Remove required attribute when editing - fields are optional
      categoryField.removeAttribute('required');
      // Ensure field is enabled and editable
      categoryField.disabled = false;
      categoryField.removeAttribute('disabled');
    }
    const quantityField = document.getElementById('quantity');
    if (quantityField) {
      quantityField.value = b.quantity ?? 1;
      // Remove required attribute when editing - fields are optional
      quantityField.removeAttribute('required');
      // Ensure field is enabled and editable
      quantityField.disabled = false;
      quantityField.removeAttribute('disabled');
      quantityField.readOnly = false;
      quantityField.removeAttribute('readonly');
    }
    const publisherField = document.getElementById('publisher');
    if (publisherField) {
      publisherField.value = b.publisher || '';
      // Remove required attribute when editing - fields are optional
      publisherField.removeAttribute('required');
      // Ensure field is enabled and editable
      publisherField.disabled = false;
      publisherField.removeAttribute('disabled');
      publisherField.readOnly = false;
      publisherField.removeAttribute('readonly');
    }
    const datePublishedField = document.getElementById('publishedAt');
    const datePublishedHelpText = document.getElementById('datePublishedHelpText');
    datePublishedField.value = (b.published_at || '').slice(0,10);
    // Disable Date Published field when editing - Date Published cannot be changed
    datePublishedField.readOnly = true;
    datePublishedField.setAttribute('readonly', 'readonly');
    datePublishedField.removeAttribute('required'); // Remove required when editing
    datePublishedField.classList.add('bg-light');
    datePublishedField.style.backgroundColor = '#f3f4f6';
    datePublishedField.style.cursor = 'not-allowed';
    datePublishedField.style.opacity = '0.8';
    // Show helper text
    if (datePublishedHelpText) {
      datePublishedHelpText.style.display = 'block';
    }

    // Update status badge
    const qty = b.quantity ?? 0;
    const statusBadge = document.getElementById('statusBadge');
    if (qty > 5) {
      statusBadge.className = 'badge bg-success';
      statusBadge.innerHTML = '<i class="bi bi-check-circle me-1"></i> In Stock';
    } else if (qty > 0) {
      statusBadge.className = 'badge bg-warning';
      statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i> Low Stock';
    } else {
      statusBadge.className = 'badge bg-danger';
      statusBadge.innerHTML = '<i class="bi bi-x-circle me-1"></i> Out of Stock';
    }

    // Update cover preview
    const coverPreview = document.getElementById('coverPreview');
    const dropHint     = document.getElementById('dropHint');
    const dropArea     = document.getElementById('dropArea');
    if (b.cover_url){
      const coverUrl = fixCoverUrl(b.cover_url);
      coverPreview.src = coverUrl;
      coverPreview.classList.remove('d-none');
      dropHint.classList.add('d-none');
      // Make cover clickable for preview
      coverPreview.style.cursor = 'pointer';
      coverPreview.onerror = function() {
        this.src = 'assets/img/no-cover.png';
        this.onerror = null;
      };
      coverPreview.onclick = () => {
        const coverPreviewFull = document.getElementById('coverPreviewFull');
        if (coverPreviewFull) {
          coverPreviewFull.src = coverUrl;
          coverPreviewFull.onerror = function() {
            this.src = 'assets/img/no-cover.png';
            this.onerror = null;
          };
        }
        bootstrap.Modal.getOrCreateInstance('#coverPreviewModal').show();
      };
    }else{
      coverPreview.classList.add('d-none');
      dropHint.classList.remove('d-none');
    }

    document.getElementById('btnSaveText').textContent = 'Update Book';
  }

  // Sort handler
  const sortSelect = document.getElementById('sortBy');
  if (sortSelect) {
    sortSelect.value = state.sort;
    sortSelect.addEventListener('change', (e) => {
      state.sort = e.target.value;
      loadGrid();
    });
  }

  // paging/search
  document.getElementById('prev').onclick = ()=>{ state.page=Math.max(1,state.page-1); loadGrid(); };
  document.getElementById('next').onclick = ()=>{ state.page+=1; loadGrid(); };
  // Modal state for filtering
  let modalState = { category: '' };
    let modalAllBooks = [];

  // Load all books into modal
  async function loadAllBooksModal() {
    const modalBookGrid = document.getElementById('modalBookGrid');
    const modalCatChips = document.getElementById('modalCatChips');
    
    // Render category chips
    renderModalChips();
    
    // Load all books
    try {
      const allUrl = `${API_LIST}?page=1&pagesize=1000&q=&category=`;
      const allData = await fetch(allUrl, {credentials:'include'}).then(r=>r.json()).catch(()=>({ok:false}));
      if (allData.ok && allData.items) {
        modalAllBooks = allData.items;
        renderModalBooks();
        bindFavoriteButtons();
      } else {
        modalBookGrid.innerHTML = '<div class="empty w-100">No books found.</div>';
      }
    } catch (e) {
      modalBookGrid.innerHTML = '<div class="empty w-100">Failed to load books.</div>';
    }
  }

  function renderModalBooks() {
    const modalBookGrid = document.getElementById('modalBookGrid');
    let filtered = modalAllBooks;
    if (modalState.category) {
      filtered = modalAllBooks.filter(b => b.category === modalState.category);
    }
    
    if (filtered.length === 0) {
      modalBookGrid.innerHTML = '<div class="empty w-100">No books found.</div>';
      return;
    }
    
    modalBookGrid.innerHTML = filtered.map(b=>{
      const cover = fixCoverUrl(b.cover_url);
      const t = esc(b.title||''), a = esc(b.author||'');
      const c = esc(b.category||''), i = esc(b.isbn||'');
      return `
        <div class="grid-item">
          <div class="book-card p-2">
            <div class="cover-wrap position-relative" role="button" onclick='showDetails(${b.id}); bootstrap.Modal.getInstance("#allBooksModal")?.hide();'>
              <img class="thumb-lg" src="${cover}" alt="${t}" onerror="this.src='assets/img/no-cover.png'; this.onerror=null;">
              ${renderHeart(b)}
            </div>
            <div class="p-2">
              <div class="title text-truncate" title="${t}">${t}</div>
              <div class="meta text-truncate">${a||'Unknown author'}</div>
              <div class="meta">${c}${c&&i?' • ':''}${i?('ISBN: '+i):''}</div>
            </div>
          </div>
        </div>`;
    }).join('');
    bindFavoriteButtons();
  }

  function renderModalChips() {
    const modalCatChips = document.getElementById('modalCatChips');
    if (!modalCatChips) return;
    // Ensure categories are loaded
    if (ALL_CATS.length === 1) {
      loadCategories().then(() => {
        renderModalChips();
      });
      return;
    }
    modalCatChips.innerHTML = ALL_CATS.map(c=>{
      const v = c==='All' ? '' : c;
      return `<button class="chip ${modalState.category===v?'active':''}" data-cat="${v}">${c}</button>`;
    }).join('');
    modalCatChips.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click',()=>{
        modalState.category = btn.dataset.cat||'';
        filterModalBooks();
      });
    });
  }

  function filterModalBooks() {
    renderModalBooks();
    renderModalChips();
  }

  qInput.addEventListener('input', e=>{ state.q=e.target.value.trim(); state.page=1; loadGrid(); });

  // details offcanvas
  // If b is a number (ID), fetch fresh data from API
  // Otherwise, use the provided book object
  window.showDetails = async function(b){
    // If b is a number (ID), fetch fresh data from API
    if (typeof b === 'number' || (typeof b === 'string' && /^\d+$/.test(b))) {
      // Convert to number and validate
      const bookId = typeof b === 'number' ? b : parseInt(b, 10);
      if (isNaN(bookId) || bookId <= 0) {
        console.error('Invalid book ID in showDetails:', b);
        alert('Error: Invalid book ID. Please try again.');
        return;
      }
      try {
        const bookRes = await fetch(`${API_EDIT}/${bookId}`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        if (!bookRes.ok) {
          throw new Error(`HTTP ${bookRes.status}: ${bookRes.statusText}`);
        }
        const bookData = await bookRes.json();
        if (bookData.ok && bookData.data) {
          b = bookData.data; // Use fresh data from API
        } else {
          console.error('Failed to fetch book details:', bookData.error || 'Unknown error');
          alert('Failed to load book details: ' + (bookData.error || 'Unknown error'));
          return;
        }
      } catch (err) {
        console.error('Error fetching book details:', err);
        alert('Failed to load book details: ' + err.message);
        return;
      }
    }
    
    // Validate that b has an id property
    if (!b || !b.id) {
      console.error('Invalid book object in showDetails:', b);
      alert('Error: Invalid book data. Please try again.');
      return;
    }
    
    const cover = fixCoverUrl(b.cover_url);
    const quantityStatus = (b.quantity ?? 0) > 5 ? 'success' : (b.quantity ?? 0) > 0 ? 'warning' : 'danger';
    const quantityText = (b.quantity ?? 0) > 5 ? 'In Stock' : (b.quantity ?? 0) > 0 ? 'Low Stock' : 'Out of Stock';
    
    const borrowButton = role === 'student' ? `
      <div class="action-buttons">
        <button class="btn ${(b.quantity ?? 0) > 0 ? 'btn-success' : 'btn-secondary'}" id="btnBorrow" data-book-id="${b.id}" data-book-title="${esc(b.title||'')}" ${(b.quantity ?? 0) === 0 ? 'disabled' : ''}>
          <i class="bi bi-book me-2"></i> ${(b.quantity ?? 0) > 0 ? 'Borrow' : 'Not Available'}
        </button>
      </div>` : '';
    
    const manageButtons = canManage() ? `
      <div class="card-actions" style="margin-top: 24px;">
        <button class="icon-btn btn-edit" id="btnEditBook" data-book-id="${b.id}" title="Edit"><i class="bi bi-pencil-square" style="font-size:18px;"></i></button>
        <button class="icon-btn btn-delete" id="btnDeleteBook" data-book-id="${b.id}" data-book-title="${esc(b.title||'')}" title="Delete"><i class="bi bi-trash3"></i></button>
      </div>` : '';
    
    const body = `
      <!-- Book Information -->
      <div class="request-section">
        <div class="request-section-title">
          <i class="bi bi-journal-text"></i> Book Information
        </div>
        <div class="book-info-card">
          <div class="d-flex gap-3 mb-3">
            <img src="${cover}" alt="${esc(b.title)}" class="book-cover-small" onerror="this.src='assets/img/no-cover.png'; this.onerror=null;">
            <div class="flex-grow-1">
              <div class="book-title">${esc(b.title||'')}</div>
              <div class="book-meta">
                <i class="bi bi-person"></i> ${esc(b.author||'—')}
      </div>
              <div class="book-meta">
                <i class="bi bi-tag"></i> ${esc(b.category||'—')}
              </div>
              ${b.isbn ? `<div class="book-meta">
                <i class="bi bi-upc-scan"></i> ISBN: ${esc(b.isbn)}
              </div>` : ''}
              <div class="mt-2">
                <span class="badge" style="background:${quantityStatus === 'success' ? '#d1fae5' : quantityStatus === 'warning' ? '#fef3c7' : '#fee2e2'}; color:${quantityStatus === 'success' ? '#065f46' : quantityStatus === 'warning' ? '#92400e' : '#991b1b'}; font-weight:600; padding:6px 12px;">
                  <i class="bi bi-box-seam me-1"></i>Quantity: ${b.quantity??0} (${quantityText})
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Publishing Details -->
      <div class="request-section">
        <div class="request-section-title">
          <i class="bi bi-info-circle"></i> Publishing Details
        </div>
        <div class="info-row">
          <div class="info-label">
            <i class="bi bi-calendar3"></i> Published
          </div>
          <div class="info-value">${b.published_at ? new Date(b.published_at).toLocaleDateString() : '—'}</div>
        </div>
        <div class="info-row">
          <div class="info-label">
            <i class="bi bi-building"></i> Publisher
          </div>
          <div class="info-value">${esc(b.publisher||'—')}</div>
        </div>
      </div>
      
      ${borrowButton}
      ${manageButtons}`;
    document.getElementById('bookDetailsLabel').textContent = b.title || 'Book';
    document.getElementById('detailsBody').innerHTML = body;
    
    // Store the current book ID being shown in the panel
    currentPanelBookId = b.id;
    
    // Bind borrow button click handler if it exists
    if (role === 'student') {
      const btnBorrow = document.getElementById('btnBorrow');
      if (btnBorrow) {
        btnBorrow.onclick = function() {
          const bookId = btnBorrow.dataset.bookId;
          const bookTitle = btnBorrow.dataset.bookTitle;
          
          // Populate borrow modal
          const cover = fixCoverUrl(b.cover_url);
          const quantity = b.quantity ?? 0;
          
          // Set cover image
          document.getElementById('borrowBookCover').src = cover || 'assets/img/no-cover.png';
          
          // Set main info
          document.getElementById('borrowBookTitle').textContent = bookTitle;
          document.getElementById('borrowBookAuthor').textContent = b.author || '—';
          
          // Set additional details
          document.getElementById('borrowBookIsbn').textContent = b.isbn || '—';
          document.getElementById('borrowBookCategory').textContent = b.category || '—';
          document.getElementById('borrowBookPublisher').textContent = b.publisher || '—';
          if (b.published_at || b.date_published) {
            const pubDate = new Date(b.published_at || b.date_published);
            document.getElementById('borrowBookPublished').textContent = pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
          } else {
            document.getElementById('borrowBookPublished').textContent = '—';
          }
          document.getElementById('borrowBookQuantity').textContent = `${quantity} ${quantity === 1 ? 'copy' : 'copies'} available`;
          
          // Set availability badge
          const availabilityBadge = document.getElementById('borrowAvailabilityBadge');
          const availabilityText = document.getElementById('borrowAvailabilityText');
          const availabilityIcon = availabilityBadge.querySelector('.availability-icon i');
          const submitButton = document.getElementById('btnSubmitBorrowRequest');
          
          if (quantity > 5) {
            availabilityBadge.className = 'availability-card';
            availabilityText.textContent = 'Available for Request';
            if (availabilityIcon) {
              availabilityIcon.className = 'bi bi-check-circle-fill';
            }
            if (submitButton) {
              submitButton.disabled = false;
            }
          } else if (quantity > 0) {
            availabilityBadge.className = 'availability-card warning';
            availabilityText.textContent = 'Low Stock (Request Required)';
            if (availabilityIcon) {
              availabilityIcon.className = 'bi bi-exclamation-triangle-fill';
            }
            if (submitButton) {
              submitButton.disabled = false;
            }
          } else {
            availabilityBadge.className = 'availability-card danger';
            availabilityText.textContent = 'Not Available';
            if (availabilityIcon) {
              availabilityIcon.className = 'bi bi-x-circle-fill';
            }
            if (submitButton) {
              submitButton.disabled = true;
              submitButton.innerHTML = '<i class="bi bi-x-circle me-2"></i><span>Not Available</span>';
            }
          }
          
          // Check if student already has an active loan for this book
          // This would need to be checked via API call
          // For now, we'll enable/disable based on quantity only
          
          // Duration option click handlers
          const durationOptions = document.querySelectorAll('.duration-option');
          const durationSelect = document.getElementById('borrowDuration');
          durationOptions.forEach(option => {
            option.addEventListener('click', function() {
              const days = this.dataset.days;
              durationSelect.value = days;
              durationOptions.forEach(opt => opt.classList.remove('active'));
              this.classList.add('active');
            });
          });
          
          // Update active state when select changes
          durationSelect.addEventListener('change', function() {
            durationOptions.forEach(opt => {
              opt.classList.toggle('active', opt.dataset.days === this.value);
            });
          });
          
          // Reset duration to default
          document.getElementById('borrowDuration').value = '7';
          durationOptions.forEach(opt => {
            opt.classList.toggle('active', opt.dataset.days === '7');
          });
          
          // Submit borrow request button handler - attach to new button
          const newSubmitButton = document.getElementById('btnSubmitBorrowRequest');
          if (newSubmitButton) {
            newSubmitButton.addEventListener('click', async function() {
              const bookId = modalEl?.dataset.currentBookId;
              if (!bookId) return;
              
              const duration = parseInt(document.getElementById('borrowDuration').value);
              if (!duration || duration < 1) {
                alert('Please select a valid borrow duration.');
                return;
              }
              
              // Disable button during request
              newSubmitButton.disabled = true;
              const originalText = newSubmitButton.innerHTML;
              newSubmitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
              
              try {
                const fd = new FormData();
                fd.set('book_id', bookId);
                fd.set('duration_days', String(duration));
                
                const res = await fetch('/api/borrow-requests', {
                  method: 'POST',
                  body: fd,
                  credentials: 'include'
                });
                
                const data = await res.json().catch(() => null);
                if (data?.ok) {
                  bootstrap.Modal.getInstance('#borrowModal')?.hide();
                  bootstrap.Offcanvas.getInstance('#bookDetails')?.hide();
                  showSuccess('Borrow request submitted successfully! The librarian will review your request.');
                  // Reload page or update UI
                  if (typeof loadGrid === 'function') {
                    loadGrid();
                  }
                } else {
                  showError(data?.error || 'Failed to submit borrow request. Please try again.');
                  newSubmitButton.disabled = false;
                  newSubmitButton.innerHTML = originalText;
                }
              } catch (err) {
                console.error('Error submitting borrow request:', err);
                alert('Network error: ' + err.message);
                newSubmitButton.disabled = false;
                newSubmitButton.innerHTML = originalText;
              }
            });
          }
          
          // Store book data for submit
          const borrowModal = new bootstrap.Modal('#borrowModal');
          borrowModal.show();
          
          // Store book ID for the confirm handler
          const modalEl = document.getElementById('borrowModal');
          modalEl.dataset.currentBookId = bookId;
        };
      }
    }
    
    // Bind edit and delete buttons for librarians/admins
    if (canManage()) {
      const btnEdit = document.getElementById('btnEditBook');
      if (btnEdit) {
        btnEdit.onclick = async function() {
          const bookId = btnEdit.dataset.bookId;
          // Validate bookId before proceeding
          if (!bookId || bookId === 'undefined' || bookId === 'null' || isNaN(bookId)) {
            console.error('Invalid book ID:', bookId);
            alert('Error: Invalid book ID. Please try again.');
            return;
          }
          // Convert to number for consistency
          const bookIdNum = parseInt(bookId, 10);
          if (isNaN(bookIdNum) || bookIdNum <= 0) {
            console.error('Invalid book ID:', bookId);
            alert('Error: Invalid book ID. Please try again.');
            return;
          }
          // Store that we're editing from the panel before closing it
          // This helps the refresh logic know to reopen the panel after edit
          window.editingFromPanel = true;
          window.editingPanelBookId = bookIdNum;
          bootstrap.Offcanvas.getInstance('#bookDetails')?.hide();
          // Fetch fresh data from API before editing
          await startEdit(bookIdNum);
        };
      }
      
      const btnDelete = document.getElementById('btnDeleteBook');
      if (btnDelete) {
        btnDelete.onclick = async function() {
          const bookId = +btnDelete.dataset.bookId;
          const bookTitle = btnDelete.dataset.bookTitle || 'this book';
          
          // Bootstrap confirm modal
          const ok = await confirmDeleteModal(bookTitle);
          if (!ok) return;
          
          try {
            // Use DELETE method with ID in URL path
            const res = await fetch(`${API_DELETE}/${bookId}`, {
              method: 'DELETE',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              }
            });
            
            const data = await res.json().catch(() => null);
            
            if (data?.ok) {
              bootstrap.Offcanvas.getInstance('#bookDetails')?.hide();
              await loadGrid();
              
              // success modal
              const modalEl = document.getElementById('deleteSuccessModal');
              bootstrap.Modal.getOrCreateInstance(modalEl).show();
            } else {
              // Show error modal instead of alert
              const errorModal = document.getElementById('deleteErrorModal');
              const errorMessage = document.getElementById('deleteErrorMessage');
              if (errorModal && errorMessage) {
                errorMessage.textContent = data?.error || 'Delete failed';
                bootstrap.Modal.getOrCreateInstance(errorModal).show();
              } else {
                alert(data?.error || 'Delete failed');
              }
            }
          } catch (err) {
            console.error('Delete error:', err);
            alert('Network/server error: ' + (err.message || 'Unknown error'));
          }
        };
      }
    }
    
    bootstrap.Offcanvas.getOrCreateInstance('#bookDetails').show();
  };

  // add/edit form
  const form = document.getElementById('bookForm');
  if (form){
    const toastSaved = new bootstrap.Toast(document.getElementById('toastSaved'));
    const toastMsg   = document.getElementById('toastMsg');
    const dropArea   = document.getElementById('dropArea');
    const coverInput = document.getElementById('coverInput');
    const coverPreview = document.getElementById('coverPreview');
    const dropHint   = document.getElementById('dropHint');

    dropArea && (dropArea.onclick = ()=>coverInput.click());
    ['dragenter','dragover'].forEach(evt=>dropArea?.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation();dropArea.classList.add('ring');}));
    ['dragleave','drop'].forEach(evt=>dropArea?.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation();dropArea.classList.remove('ring');}));
    dropArea?.addEventListener('drop', e=>{
      const f = e.dataTransfer.files?.[0]; if (!f) return;
      if (f.size > 5*1024*1024){ alert('Max file size is 5 MB'); return; }
      coverInput.files = e.dataTransfer.files;
      const r=new FileReader();
      r.onload=()=>{
        coverPreview.src=r.result;
        coverPreview.classList.remove('d-none');
        dropHint.classList.add('d-none');
        // Make preview clickable
        coverPreview.style.cursor = 'pointer';
        coverPreview.onclick = () => {
          document.getElementById('coverPreviewFull').src = r.result;
          bootstrap.Modal.getOrCreateInstance('#coverPreviewModal').show();
        };
      };
      r.readAsDataURL(f);
    });
    document.getElementById('btnChangeImage')?.addEventListener('click', ()=>coverInput.click());
    document.getElementById('btnRemoveImage')?.addEventListener('click', ()=>{
      coverPreview.src='';
      coverPreview.classList.add('d-none');
      dropHint.classList.remove('d-none');
      coverInput.value='';
      coverPreview.onclick = null;
    });
    coverInput && (coverInput.onchange = ()=>{
      const f=coverInput.files?.[0]; if (!f) return;
      if (f.size>5*1024*1024){ alert('Max file size is 5 MB'); coverInput.value=''; return; }
      const r=new FileReader();
      r.onload=()=>{
        coverPreview.src=r.result;
        coverPreview.classList.remove('d-none');
        dropHint.classList.add('d-none');
        // Make preview clickable
        coverPreview.style.cursor = 'pointer';
        coverPreview.onclick = () => {
          document.getElementById('coverPreviewFull').src = r.result;
          bootstrap.Modal.getOrCreateInstance('#coverPreviewModal').show();
        };
      };
      r.readAsDataURL(f);
    });
    
    // Update status badge on quantity change
    const quantityInput = document.getElementById('quantity');
    if (quantityInput) {
      quantityInput.addEventListener('input', (e) => {
        const qty = parseInt(e.target.value) || 0;
        const statusBadge = document.getElementById('statusBadge');
        if (qty > 5) {
          statusBadge.className = 'badge bg-success';
          statusBadge.innerHTML = '<i class="bi bi-check-circle me-1"></i> In Stock';
        } else if (qty > 0) {
          statusBadge.className = 'badge bg-warning';
          statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i> Low Stock';
        } else {
          statusBadge.className = 'badge bg-danger';
          statusBadge.innerHTML = '<i class="bi bi-x-circle me-1"></i> Out of Stock';
        }
      });
    }

    // Real-time ISBN validation (count only digits, ignore hyphens)
    const isbnField = document.getElementById('isbn');
    const isbnError = document.getElementById('isbnError');
    const isbnFormatHelp = document.getElementById('isbnFormatHelp');
    let duplicateCheckTimeout = null;
    
    // Function to check for duplicate ISBN
    // Only checks against books added by the current user
    // Only shows error if ALL 13 digits match exactly
    async function checkDuplicateISBN(isbn) {
      if (!isbn || !canManage() || editingId) return false;
      
      const cleanedIsbn = isbn.replace(/[\s\-]/g, '');
      // Only check if we have exactly 13 digits
      if (cleanedIsbn.length !== 13) return false;
      
      try {
        // The API_LIST already filters by added_by for librarians
        // So we only check against books the current user added
        const checkRes = await fetch(`${API_LIST}?q=${encodeURIComponent(cleanedIsbn)}&pagesize=50`, {
          credentials: 'include'
        });
        if (checkRes.ok) {
          const checkData = await checkRes.json();
          if (checkData.ok && checkData.data && checkData.data.length > 0) {
            // Only return true if ALL 13 digits match exactly
            const hasDuplicate = checkData.data.some(book => {
              const bookIsbn = (book.isbn || '').replace(/[\s\-]/g, '');
              // Exact match: all 13 digits must be identical
              return bookIsbn.length === 13 && bookIsbn === cleanedIsbn;
            });
            return hasDuplicate;
          }
        }
      } catch (err) {
        console.warn('ISBN duplicate check failed:', err);
      }
      return false;
    }
    
    if (isbnField && isbnError) {
      isbnField.addEventListener('input', async (e) => {
        const isbn = e.target.value.trim();
        
        // Count only digits (excluding hyphens and spaces)
        const digitCount = isbn.replace(/[\s\-]/g, '').length;
        
        // Clear previous validation state
        isbnField.setCustomValidity('');
        isbnField.classList.remove('is-invalid', 'is-valid');
        isbnError.textContent = '';
        
        // Clear any pending duplicate check
        if (duplicateCheckTimeout) {
          clearTimeout(duplicateCheckTimeout);
          duplicateCheckTimeout = null;
        }
        
        if (isbn === '') {
          // Empty field - show default help text
          isbnFormatHelp.style.display = 'block';
          return;
        }
        
        // Real-time validation
        const isbnValidation = validateISBN(isbn);
        
        if (!isbnValidation.valid) {
          isbnField.setCustomValidity(isbnValidation.error);
          isbnField.classList.add('is-invalid');
          isbnField.classList.remove('is-valid');
          isbnError.textContent = isbnValidation.error;
          isbnFormatHelp.style.display = 'none';
        } else {
          // Format is valid, but don't mark as valid yet - check for duplicates first
          // Debounce duplicate check to avoid too many API calls
          duplicateCheckTimeout = setTimeout(async () => {
            const hasDuplicate = await checkDuplicateISBN(isbn);
            if (hasDuplicate) {
              isbnField.setCustomValidity('A book with this ISBN already exists.');
              isbnField.classList.add('is-invalid');
              isbnField.classList.remove('is-valid');
              isbnError.textContent = 'A book with this ISBN already exists.';
              isbnFormatHelp.style.display = 'none';
            } else {
              isbnField.setCustomValidity('');
              isbnField.classList.add('is-valid');
              isbnField.classList.remove('is-invalid');
              isbnError.textContent = '';
              isbnFormatHelp.style.display = 'block';
            }
          }, 500); // Wait 500ms after user stops typing
        }
      });
      
      // Also validate on blur and check for duplicates
      isbnField.addEventListener('blur', async (e) => {
        // Clear any pending timeout
        if (duplicateCheckTimeout) {
          clearTimeout(duplicateCheckTimeout);
          duplicateCheckTimeout = null;
        }
        
        const isbn = e.target.value.trim();
        if (isbn !== '') {
          const isbnValidation = validateISBN(isbn);
          if (!isbnValidation.valid) {
            isbnField.setCustomValidity(isbnValidation.error);
            isbnField.classList.add('is-invalid');
            isbnField.classList.remove('is-valid');
            isbnError.textContent = isbnValidation.error;
            isbnFormatHelp.style.display = 'none';
          } else {
            // ISBN format is valid, check for duplicates immediately on blur
            const hasDuplicate = await checkDuplicateISBN(isbn);
            if (hasDuplicate) {
              isbnField.setCustomValidity('A book with this ISBN already exists.');
              isbnField.classList.add('is-invalid');
              isbnField.classList.remove('is-valid');
              isbnError.textContent = 'A book with this ISBN already exists.';
              isbnFormatHelp.style.display = 'none';
            } else {
              isbnField.setCustomValidity('');
              isbnField.classList.add('is-valid');
              isbnField.classList.remove('is-invalid');
              isbnError.textContent = '';
              isbnFormatHelp.style.display = 'block';
            }
          }
        }
      });
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!canManage()){ alert('Only librarians can add/edit books.'); return; }
      
      const isEditing = !!editingId;
      
      // Only validate form when creating new books (all fields required)
      // When editing, fields are optional - librarian can update any field they want
      if (!isEditing) {
        // Validate ISBN before form submission
        const isbnField = document.getElementById('isbn');
        if (isbnField) {
          const isbnValidation = validateISBN(isbnField.value);
          if (!isbnValidation.valid) {
            isbnField.setCustomValidity(isbnValidation.error);
            isbnField.classList.add('is-invalid');
            const isbnError = document.getElementById('isbnError');
            if (isbnError) {
              isbnError.textContent = isbnValidation.error;
            }
            form.classList.add('was-validated');
            return;
          } else {
            isbnField.setCustomValidity('');
            isbnField.classList.remove('is-invalid');
          }
        }
        form.classList.add('was-validated');
        if (!form.checkValidity()) return;
      }
      
      const url = isEditing ? `${API_EDIT}/${editingId}` : API_CREATE;

      // Get all form fields directly
      const titleField = document.getElementById('title');
      const authorField = document.getElementById('author');
      const categoryField = document.getElementById('category');
      const publisherField = document.getElementById('publisher');
      const quantityField = document.getElementById('quantity');
      
      // Validate that all required fields exist
      if (!titleField || !authorField || !categoryField || !publisherField || !quantityField) {
        alert('Error: Form fields not found. Please refresh the page.');
        console.error('Missing fields:', {
          title: !!titleField,
          author: !!authorField,
          category: !!categoryField,
          publisher: !!publisherField,
          quantity: !!quantityField
        });
        return;
      }
      
      // For editing: use FormData with _method=PUT so Laravel parses fields; for creating: FormData with file
      let fd = new FormData();
      
      if (isEditing) {
        // Collect all editable fields
        const titleValue = (titleField.value || '').trim();
        const authorValue = (authorField.value || '').trim();
        const categoryValue = (categoryField.value || '').trim();
        const publisherValue = (publisherField.value || '').trim();
        let quantityValue = 0;
        const quantityInput = quantityField.value.trim();
        if (quantityInput !== '') {
          const parsed = parseInt(quantityInput, 10);
          if (!isNaN(parsed) && parsed >= 0) quantityValue = parsed;
        }
        // Send all editable fields
        fd.set('title', titleValue);
        fd.set('author', authorValue);
        fd.set('category', categoryValue);
        fd.set('publisher', publisherValue);
        fd.set('quantity', String(quantityValue));
        // Include cover if user selected a new one during edit
        const coverInput = document.getElementById('coverInput');
        if (coverInput && coverInput.files && coverInput.files.length > 0) {
          fd.set('cover', coverInput.files[0]);
        }
        // Method spoofing for Laravel
        fd.set('_method', 'PUT');
        console.log('Sending FormData for update:');
        for (let [k,v] of fd.entries()) console.log(' ', k, v);
      } else {
        // For creating: all fields are required (form validation handles this)
        const titleValue = (titleField.value || '').trim();
        const authorValue = (authorField.value || '').trim();
        const categoryValue = (categoryField.value || '').trim();
        const publisherValue = (publisherField.value || '').trim();
        const quantityValue = parseInt(quantityField.value) || 0;
        
        fd.set('title', titleValue);
        fd.set('author', authorValue);
        fd.set('category', categoryValue);
        fd.set('publisher', publisherValue);
        fd.set('quantity', String(Math.max(0, quantityValue)));
      }
      
      // Handle cover file if present (only for create)
      const coverInput = document.getElementById('coverInput');
      if (!isEditing && coverInput && coverInput.files && coverInput.files.length > 0) {
        fd.set('cover', coverInput.files[0]);
      }
      
      // For editing: ISBN and date_published are NOT included (they cannot be changed)
      if (!isEditing) {
        // For creating: include ISBN and date_published
        const isbnField = document.getElementById('isbn');
        if (isbnField) fd.set('isbn', (isbnField.value || '').trim());
        const datePublishedField = document.getElementById('publishedAt');
        if (datePublishedField) {
          // Validate that date is required when creating
          if (!datePublishedField.value || datePublishedField.value.trim() === '') {
            datePublishedField.classList.add('is-invalid');
            datePublishedField.focus();
            form.classList.add('was-validated');
            return;
          }
          fd.set('date_published', datePublishedField.value);
        }
      }

      // Debug: Log what we're sending
      if (isEditing) {
        console.log('Updating book with FormData:');
        for (let [key, value] of fd.entries()) {
          console.log(`  ${key}: ${value}`);
        }
      }
      
      try{
        const res = await fetch(url, {
          method: 'POST', // use POST for both; _method=PUT handles updates
          body: fd,
          credentials: 'include',
          headers: {
            'Accept': 'application/json'
            // Don't set Content-Type for FormData - browser sets it automatically with boundary
          }
        });
        const raw = await res.text();
        let data = null;
        try{ data = JSON.parse(raw); }catch{ alert(`HTTP ${res.status} ${res.statusText}\n\n${raw.slice(0,800)}`); return; }
        
        // Log the response for debugging
        console.log(isEditing ? 'Update response:' : 'Create response:', data);
        
        // Handle validation errors (422) and other errors
        if (!res.ok || !data.ok){
          let errorMsg = data.error || `Save failed (HTTP ${res.status})`;
          
          // Special handling for ISBN duplicate error (409)
          if (res.status === 409 && (errorMsg.toLowerCase().includes('isbn') || errorMsg.toLowerCase().includes('already exists'))) {
            const isbnField = document.getElementById('isbn');
            const isbnError = document.getElementById('isbnError');
            if (isbnField && isbnError) {
              isbnField.setCustomValidity(errorMsg);
              isbnField.classList.add('is-invalid');
              isbnField.classList.remove('is-valid');
              isbnError.textContent = errorMsg;
              isbnField.focus();
              form.classList.add('was-validated');
              return;
            }
          }
          
          // If there are validation errors, format them nicely
          if (data.errors && typeof data.errors === 'object') {
            const errorList = [];
            for (const field in data.errors) {
              if (Array.isArray(data.errors[field])) {
                errorList.push(...data.errors[field]);
              } else {
                errorList.push(data.errors[field]);
              }
            }
            if (errorList.length > 0) {
              errorMsg = errorList.join('\n');
            }
          }
          console.error('Book save error:', errorMsg, data);
          showError(errorMsg);
          return;
        }
        
        console.log('Book saved successfully:', data);

        // Save the book ID before clearing editingId (needed for refreshing details panel)
        const updatedBookId = editingId;
        
        editingId = null;
        document.getElementById('btnSaveText').textContent = 'Save Book';
        
        // Refresh the book list to show updated data
        if (isEditing && updatedBookId) {
          // Check if we edited from the panel (panel was closed when edit button was clicked)
          const editedFromPanel = window.editingFromPanel && window.editingPanelBookId === updatedBookId;
          const wasPanelOpen = currentPanelBookId === updatedBookId;
          
          // Always re-fetch fresh data from API to avoid stale values in the panel
          await loadGrid(); // refresh cards
          try {
            await showDetails(updatedBookId); // fetch fresh details from API and render panel
          } catch (err) {
            console.error('Failed to refresh book details after update:', err);
          }
          
          // If we edited from the panel or it was showing this book, reopen it to show fresh data
          if (editedFromPanel || wasPanelOpen) {
            setTimeout(() => {
              const offcanvas = bootstrap.Offcanvas.getInstance('#bookDetails') || new bootstrap.Offcanvas('#bookDetails');
              offcanvas.show();
            }, 100);
          }
          
          // Clear the flags
          window.editingFromPanel = false;
          window.editingPanelBookId = null;
        } else {
          // For new books, reset filters and refresh the grid
          state.q = '';
          state.cat = '';
          state.page = 1;
          qInput.value = '';
          renderChips();
          await loadGrid();
          // Switch back to discover panel to show the updated book list
          showDiscover();
        }
        
        // Show success modal using the same style as borrow request
        const successMessage = isEditing ? 'Book updated successfully!' : 'Book saved successfully!';
        showSuccess(successMessage);

        form.reset(); form.classList.remove('was-validated');
        coverPreview.src=''; coverPreview.classList.add('d-none'); dropHint.classList.remove('d-none');
        coverPreview.onclick = null;
        
        // Re-enable ISBN field (it was disabled during editing)
        const isbnField = document.getElementById('isbn');
        const isbnHelpText = document.getElementById('isbnHelpText');
        const isbnFormatHelp = document.getElementById('isbnFormatHelp');
        isbnField.readOnly = false;
        isbnField.removeAttribute('readonly');
        isbnField.setAttribute('required', 'required'); // Re-add required for new books
        isbnField.classList.remove('bg-light');
        isbnField.style.backgroundColor = '';
        isbnField.style.cursor = '';
        isbnField.style.opacity = '';
        // Show format help text when creating new book
        if (isbnFormatHelp) {
          isbnFormatHelp.style.display = 'block';
        }
        // Hide helper text
        if (isbnHelpText) {
          isbnHelpText.style.display = 'none';
        }
        
        // Re-enable Date Published field (it was disabled during editing)
        const datePublishedField = document.getElementById('publishedAt');
        const datePublishedHelpText = document.getElementById('datePublishedHelpText');
        datePublishedField.readOnly = false;
        datePublishedField.removeAttribute('readonly');
        datePublishedField.setAttribute('required', 'required'); // Re-add required when creating
        datePublishedField.classList.remove('bg-light');
        datePublishedField.style.backgroundColor = '';
        datePublishedField.style.cursor = '';
        datePublishedField.style.opacity = '';
        // Hide helper text
        if (datePublishedHelpText) {
          datePublishedHelpText.style.display = 'none';
        }
        
        // Re-add required attributes for all fields when creating new books
        const titleField = document.getElementById('title');
        const authorField = document.getElementById('author');
        const categoryField = document.getElementById('category');
        const publisherField = document.getElementById('publisher');
        const quantityField = document.getElementById('quantity');
        if (titleField) titleField.setAttribute('required', 'required');
        if (authorField) authorField.setAttribute('required', 'required');
        if (categoryField) categoryField.setAttribute('required', 'required');
        if (publisherField) publisherField.setAttribute('required', 'required');
        if (quantityField) quantityField.setAttribute('required', 'required');
        
        // Reset header
        document.getElementById('pageHeaderTitle').textContent = 'Add New Book';
        const pageHeaderSubtitle = document.querySelector('.page-header p.text-muted');
        if (pageHeaderSubtitle) {
          pageHeaderSubtitle.textContent = 'Fill in the details below to add a new book to the library';
        }
        document.getElementById('statusBadge').className = 'badge bg-success';
        document.getElementById('statusBadge').innerHTML = '<i class="bi bi-check-circle me-1"></i> In Stock';

        tabDiscover.click();
        state.page=1; await loadGrid();
      }catch(err){ alert('Network/server error: '+err.message); }
    });
  }

  // Modal helper functions
  function showSuccess(message, title = 'Success!') {
    document.getElementById('successModalTitle').textContent = title;
    document.getElementById('successModalMessage').textContent = message;
    const modal = new bootstrap.Modal('#successModal');
    modal.show();
  }

  function showError(message, title = 'Error') {
    document.getElementById('errorModalTitle').textContent = title;
    document.getElementById('errorModalMessage').textContent = message;
    const modal = new bootstrap.Modal('#errorModal');
    modal.show();
  }

  // Borrow request handler (student only)
  if (role === 'student') {
    const btnConfirmBorrow = document.getElementById('btnConfirmBorrow');
    if (btnConfirmBorrow) {
      btnConfirmBorrow.addEventListener('click', async function() {
        const modalEl = document.getElementById('borrowModal');
        const bookId = modalEl?.dataset.currentBookId;
        if (!bookId) return;
        
        const duration = parseInt(document.getElementById('borrowDuration').value);
        if (!duration || duration < 1) {
          showError('Please select a valid borrow duration.');
          return;
        }
        
        try {
          const fd = new FormData();
          fd.set('book_id', bookId);
          fd.set('duration_days', String(duration));
          
          const res = await fetch('/api/borrow-requests', {
            method: 'POST',
            body: fd,
            credentials: 'include'
          });
          
          const data = await res.json().catch(() => null);
          if (data?.ok) {
            bootstrap.Modal.getInstance('#borrowModal')?.hide();
            bootstrap.Offcanvas.getInstance('#bookDetails')?.hide();
            showSuccess('Borrow request submitted successfully! The librarian will review your request.');
          } else {
            showError(data?.error || 'Failed to submit borrow request.');
          }
        } catch (err) {
          showError('Network error: ' + err.message);
        }
      });
    }
  }
  
  // Load categories on page load, then initialize page
  loadCategories().then(() => {
    // After categories are loaded, render chips and load content
    if (catChips || document.getElementById('catChips')) {
      renderChips();
    }
    loadGrid();
    showDiscover();
  }).catch(() => {
    // If categories fail to load, still show the page with default categories
    renderChips();
    loadGrid();
    showDiscover();
  });
}
</script>
</body>
</html>
