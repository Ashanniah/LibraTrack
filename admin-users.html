<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack - Users Management</title>

  <!-- Fonts & Vendor CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

  <!-- Your app CSS -->
  <link href="assets/css/sidebar.css" rel="stylesheet">
  <link href="assets/css/admin-users.css" rel="stylesheet">

  <link rel="icon" href="assets/img/LibraTrack-logo.png">

  <style>
    :root{
      --card-pad:24px;
      --cell-pad-y:14px;
      --cell-pad-x:20px;
      --ui-muted:#6b7280;
      --ui-border:#eef0f3;
      --ui-soft:#f6f7f9;
      --brand-black:#111827;
      --brand-gold:#c9a227;
      --brand-border:#3d3d3d;
    }
    html{font-size:14px;}
    body{font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"}

    main.container-fluid{padding-top:24px!important}
    .table-card.card{border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); border:1px solid var(--ui-border); overflow:visible;}
    .table-card .card-header{padding:var(--card-pad); border-bottom:1px solid var(--ui-border)}
    .table-card .card-body{padding:0}
    .table-modern th,.table-modern td{vertical-align:middle; padding:var(--cell-pad-y) var(--cell-pad-x)}
    .th-tight{width:1%;white-space:nowrap}
    .col-actions{width:56px}
    .col-status{width:120px}
    .col-role{width:140px}
    .col-id{width:180px}
    .avatar{width:32px;height:32px;border-radius:50%;object-fit:cover}
    .table-responsive{overflow:visible;}

    .btn-dark{background:var(--brand-black);border-color:var(--brand-black);}
    .btn-dark:hover{background:#000;border-color:#000;}
    .btn-dark:focus,.btn-dark:active{box-shadow:0 0 0 .2rem rgba(201,162,39,.15);}

    #btnPrimary{border-radius:8px;padding:.6rem 1rem;font-weight:600;font-size:.95rem;}

    .filter-btn{display:inline-flex;align-items:center;gap:.45rem}
    .filter-menu{min-width:260px;padding:.5rem;border-radius:12px;border:1px solid var(--ui-border);box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .filter-title{font-weight:600;font-size:.85rem;color:#111;padding:.4rem .5rem .2rem}
    .filter-section{padding:.25rem .5rem .6rem}
    .filter-option{display:flex;align-items:center;gap:.5rem;padding:.35rem .4rem;border-radius:8px;cursor:pointer}
    .filter-option:hover{background:var(--ui-soft)}

    .table-footer{display:flex;align-items:center;justify-content:center;gap:12px;padding:16px var(--card-pad);border-top:1px solid var(--ui-border); position:relative}
    .page-info{font-size:.85rem;color:var(--ui-muted); position:absolute; right:var(--card-pad); padding:.35rem .6rem; background:#f8f9fb; border:1px solid var(--ui-border); border-radius:8px}
    .pagination{gap:.35rem}
    .pagination .page-link{border:1px solid var(--ui-border);border-radius:10px !important;padding:.35rem .6rem;color:#374151;background:#fff;}
    .pagination .page-link:hover{background:#f5f5f5;border-color:#000}
    .pagination .page-item.active .page-link{background:var(--brand-black);color:#fff;border-color:var(--brand-black);}
    .pagination .page-item.disabled .page-link{opacity:.4}

    .empty-row td{padding:40px 16px; text-align:center; color:var(--ui-muted)}

    .pw-wrap{position:relative}
    .pw-toggle{position:absolute; right:.5rem; top:50%; transform:translateY(-50%); border:0; background:transparent}

    .kebab-btn{border:0;background:transparent;padding:.25rem .3rem}
    .kebab-btn i{font-size:1.1rem;color:#222}
    .dropdown-menu.kebab{z-index:1080;border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.08); border:1px solid var(--ui-border); padding:.35rem}
    .dropdown-item{display:flex;align-items:center;gap:.5rem}
    .dropdown-item .bi{opacity:.85}

    .count-pill{font-size:.85rem;color:#374151;background:#f3f4f6;border:1px solid var(--ui-border);padding:.15rem .5rem;border-radius:999px}

    .userview-2col .vu-head{display:flex;gap:16px;align-items:center}
    .userview-2col .vu-avatar img{width:64px;height:64px;border-radius:50%}
    .userview-2col .vu-name{font-weight:700;font-size:1.05rem}
    .userview-2col .vu-sheet{margin-top:16px;border-top:1px solid #eee;border-radius:12px;overflow:hidden}
    .userview-2col .vu-row{display:grid;grid-template-columns:220px 1fr;padding:.7rem .9rem;border-bottom:1px dashed #eee}
    .userview-2col .vu-headrow{font-weight:600;background:var(--brand-black);color:#fff;border-bottom:none}
    .userview-2col .vu-headrow .bi{filter:invert(1)}
    .chip{display:inline-flex;align-items:center;padding:.25rem .5rem;border-radius:999px;font-size:.75rem;font-weight:600}
    .chip-role{background:#eef2ff;color:#4338ca}
    .chip-status.disabled{background:rgba(220,53,69,.12); color:#dc3545}

    .search-group .input-group-text,
    .search-group .form-control{
      background:#fff;border:1px solid var(--brand-border);height:44px;
    }
    .search-group .input-group-text{border-right:0;border-top-left-radius:8px;border-bottom-left-radius:8px;}
    .search-group .form-control{border-left:0;border-top-right-radius:8px;border-bottom-right-radius:8px;}
    .search-group .form-control:focus{box-shadow:none;border-color:#000;}

    .modal-header-dark{background:var(--brand-black);color:#fff;border-bottom:none;}
    .modal-header-dark .modal-title{color:#fff;}
    .modal-header-dark .btn-close{filter:invert(1) grayscale(1);opacity:.8;}
    .modal-header-dark .btn-close:hover{opacity:1;}

    .badge.text-bg-success-soft{background:rgba(25,135,84,.12); color:#198754; font-weight:600}
    .badge.text-bg-danger-soft{background:rgba(220,53,69,.12); color:#dc3545; font-weight:600}
    .role-badge{font-weight:600;border-radius:999px;padding:.2rem .5rem}
    .role-badge.admin{background:rgba(33,37,41,.08); color:#212529}
    .role-badge.librarian{background:rgba(13,110,253,.12); color:#0d6efd}
    .role-badge.student{background:rgba(111,66,193,.12); color:#6f42c1;}

    .name-grid{display:grid;grid-template-columns:1fr 1fr 1fr minmax(130px,180px);gap:12px}
    @media (max-width: 768px){ .name-grid{grid-template-columns:1fr 1fr} }
    .modal .form-label{font-weight:600;margin-bottom:.35rem}
    .modal .form-control,.modal .form-select{padding:.55rem .75rem}
    .modal .modal-body{padding:20px 22px}
    .modal .modal-footer{padding:14px 20px}
    .form-text-hint{font-size:.8rem;color:var(--ui-muted)}
    .field-error{color:#dc3545;font-size:.85rem;margin-top:.35rem}

    .toolbar-44 .form-control,
    .toolbar-44 .input-group-text,
    .toolbar-44 .btn { height:44px; }

    .btn-icon {width:44px;height:44px; display:inline-flex; align-items:center; justify-content:center; padding:0;}
    .avatar-32 {width:32px; height:32px; border-radius:50%; object-fit:cover;}

    .toolbar-44 { flex-wrap: nowrap !important; gap: 8px; }
    .toolbar-44 .form-control,
    .toolbar-44 .input-group-text,
    .toolbar-44 .btn { height:44px; }

    .search-wide { width: 460px; max-width: 48vw; }

    .btn-profile {
      height:44px; display:flex; align-items:center; gap:10px;
      padding:0 12px; background:#fff; border:1px solid var(--ui-border);
      border-radius:8px;
    }
    .btn-profile .avatar-28 { width:28px;height:28px;border-radius:50%;object-fit:cover; }
    .btn-profile .name { max-width:22ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  </style>
</head>
<body class="sb-body">
  <div id="sidebar-root"></div>

  <div class="sb-wrapper">
    <!-- Topbar -->
    <nav class="sb-topbar navbar navbar-expand bg-white sticky-top">
      <div class="container-fluid">
        <button id="sidebarToggle" class="btn btn-link text-dark me-2" aria-label="Toggle sidebar">
          <i class="bi bi-list fs-4"></i>
        </button>

        <div class="fw-bold h5 mb-0">Users Management</div>

        <div class="ms-auto d-flex align-items-center gap-2">
          <div class="dropdown">
            <button class="btn btn-light border btn-icon" data-bs-toggle="dropdown" aria-expanded="false" id="profileBtn">
              <img src="assets/img/default-avatar.png" alt="Profile" class="avatar-32">
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><h6 class="dropdown-header">Signed in</h6></li>
              <li><a class="dropdown-item" href="admin-profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
              <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear me-2"></i>Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="backend/logout.php"><i class="bi bi-box-arrow-right me-2"></i>Sign out</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- Content -->
    <main class="container-fluid">
      <section class="table-card card p-0 position-relative">
        <div class="card-header">
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="d-flex align-items-center gap-3">
              <span class="fw-semibold d-flex align-items-center gap-2">
                <i class="bi bi-people-fill"></i>
                <span id="hdrTitle">Users</span>
                <span class="count-pill" id="acctCount">0</span>
              </span>
            </div>

            <div class="d-flex align-items-center toolbar-44 flex-nowrap">
              <form role="search" class="me-2">
                <div class="input-group search-group search-wide">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="searchInput" class="form-control" type="search" placeholder="Search name, email, ID…">
                </div>
              </form>

              <div class="dropdown me-2">
                <button class="btn btn-outline-secondary filter-btn" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-sliders"></i> Filters
                </button>
                <div class="dropdown-menu dropdown-menu-end filter-menu">
                  <div class="filter-title">Role</div>
                  <div class="filter-section" id="filterRole">
                    <label class="filter-option"><input type="radio" name="role" value="" checked> All</label>
                    <label class="filter-option"><input type="radio" name="role" value="librarian"> Librarian</label>
                    <label class="filter-option"><input type="radio" name="role" value="student"> Student</label>
                  </div>
                  <div class="filter-title">Status</div>
                  <div class="filter-section" id="filterStatus">
                    <label class="filter-option"><input type="radio" name="status" value="" checked> All</label>
                    <label class="filter-option"><input type="radio" name="status" value="active"> Active</label>
                    <label class="filter-option"><input type="radio" name="status" value="disabled"> Disabled</label>
                  </div>
                </div>
              </div>

              <button id="btnPrimary" class="btn btn-dark d-flex align-items-center gap-2">
                <i class="bi bi-person-plus"></i> <span id="btnPrimaryText">Add Librarian</span>
              </button>
            </div>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-modern align-middle mb-0" id="usersTable">
              <thead>
                <tr>
                  <th class="th-tight"><input class="form-check-input" type="checkbox" id="checkAll"></th>
                  <th>Name</th>
                  <th>Email</th>
                  <th class="col-role">Role</th>
                  <th class="d-none d-lg-table-cell col-id">ID / Student No.</th>
                  <th class="th-tight col-status">Status</th>
                  <th class="th-tight text-end col-actions">Actions</th>
                </tr>
              </thead>
              <tbody id="usersBody"></tbody>
            </table>
          </div>
        </div>

        <div class="table-footer">
          <nav><ul class="pagination pagination-sm mb-0" id="pager"></ul></nav>
          <div class="page-info" id="pageInfo">Showing 0–0 of 0</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Add/Edit User Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form id="userForm" class="modal-content" novalidate>
        <div class="modal-header modal-header-dark">
          <h5 class="modal-title" id="userModalTitle">Add Librarian</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label mb-1">Name</label>
              <div class="name-grid">
                <div>
                  <input id="fFirst" type="text" class="form-control" placeholder="First name" required>
                  <div class="field-error d-none" id="errFirst"></div>
                </div>
                <div>
                  <input id="fMiddle" type="text" class="form-control" placeholder="Middle name">
                  <div class="form-text-hint">Optional</div>
                </div>
                <div>
                  <input id="fLast" type="text" class="form-control" placeholder="Last name" required>
                  <div class="field-error d-none" id="errLast"></div>
                </div>
                <div>
                  <select id="fSuffix" class="form-select" aria-label="Suffix">
                    <option value="">No suffix</option>
                    <option>Jr.</option><option>Sr.</option>
                    <option>I</option><option>II</option><option>III</option><option>IV</option>
                    <option>V</option><option>VI</option><option>VII</option><option>VIII</option>
                    <option>IX</option><option>X</option>
                  </select>
                  <div class="form-text-hint">Suffix</div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Email</label>
              <input id="fEmail" type="email" class="form-control" required>
              <div class="field-error d-none" id="errEmail"></div>
            </div>

            <!-- Role removed from dialog -->

            <div class="col-12 col-md-6">
              <label class="form-label">Status</label>
              <select id="fStatus" class="form-select" required>
                <option value="active">Active</option>
                <option value="disabled">Disabled</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Password</label>
              <div class="pw-wrap">
                <input id="fPassword" type="password" class="form-control" placeholder="≥8 chars, 1 uppercase, 1 special">
                <button type="button" class="pw-toggle" id="pwToggle1" aria-label="Show password">
                  <i class="bi bi-eye" id="pwIcon1"></i>
                </button>
              </div>
              <div class="field-error d-none" id="errPassword"></div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Confirm Password</label>
              <div class="pw-wrap">
                <input id="fConfirm" type="password" class="form-control" placeholder="Repeat password">
                <button type="button" class="pw-toggle" id="pwToggle2" aria-label="Show password">
                  <i class="bi bi-eye" id="pwIcon2"></i>
                </button>
              </div>
              <div class="field-error d-none" id="errConfirm"></div>
            </div>

            <!-- ID / Student No. removed from dialog -->

            <div class="col-12">
              <label class="form-label">Notes</label>
              <input id="fNotes" type="text" class="form-control" placeholder="Optional notes…">
            </div>

            <input id="fId" type="hidden">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button id="btnSaveUser" class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View User Modal -->
  <div class="modal fade" id="viewUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content userview-2col">
        <div class="modal-header border-0 pb-0 modal-header-dark">
          <h5 class="modal-title">User Details</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-0">
          <div class="vu-head">
            <div class="vu-avatar"><img id="vuAvatar" src="assets/img/default-avatar.png" alt="Avatar"></div>
            <div class="vu-id">
              <div class="vu-name" id="vuName">—</div>
              <div class="vu-email" id="vuEmail">—</div>
              <div class="vu-chips">
                <span id="vuRole" class="chip chip-role">—</span>
                <span id="vuStatus" class="chip chip-status">—</span>
              </div>
            </div>
            <div class="vu-actions ms-auto">
              <button type="button" class="btn btn-outline-primary btn-sm" id="vuEditBtn"><i class="bi bi-pencil-square me-1"></i>Edit</button>
              <button type="button" class="btn btn-outline-danger btn-sm" id="vuDeleteBtn"><i class="bi bi-trash-fill me-1"></i>Delete</button>
            </div>
          </div>

          <div class="vu-sheet mt-3">
            <div class="vu-row vu-headrow">
              <div class="vu-col vu-field"><i class="bi bi-info-circle me-2"></i> Field</div>
              <div class="vu-col vu-value"><i class="bi bi-clipboard-check me-2"></i> Details</div>
            </div>

            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-person-fill"></i> Full Name</div><div class="vu-col vu-value" id="fldFullName">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-card-text"></i> First Name</div><div class="vu-col vu-value" id="fldFirst">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-card-text"></i> Middle Name</div><div class="vu-col vu-value" id="fldMiddle">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-card-text"></i> Last Name</div><div class="vu-col vu-value" id="fldLast">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-card-text"></i> Suffix</div><div class="vu-col vu-value" id="fldSuffix">—</div></div>

            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-envelope-fill"></i> Email</div><div class="vu-col vu-value" id="fldEmail">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-shield-lock-fill"></i> Role</div><div class="vu-col vu-value" id="fldRole">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-clock-fill"></i> Status</div><div class="vu-col vu-value" id="fldStatus">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-person-vcard-fill"></i> Student No.</div><div class="vu-col vu-value" id="fldStudentNo">—</div></div>

            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-clock-history"></i> Last Active</div><div class="vu-col vu-value" id="fldLastActive">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-calendar-event"></i> Joined</div><div class="vu-col vu-value" id="fldJoined">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-card-text"></i> Notes</div><div class="vu-col vu-value" id="fldNotes">—</div></div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Back to list</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header modal-header-dark">
          <h5 class="modal-title">Delete User</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-1">You’re about to delete:</p>
          <div class="fw-semibold" id="delWho">—</div>
          <div class="text-muted small" id="delEmail">—</div>
          <div class="alert alert-warning mt-3 mb-0">This action can’t be undone.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" id="confirmDeleteBtn"><i class="bi bi-trash me-1"></i>Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    // ---- Auth helper ----
    async function getMe() {
      const res = await fetch('backend/check-auth.php', { credentials: 'include' });
      if (res.status === 401) { location.href = 'login.html'; return null; }
      const data = await res.json();
      if (!data.success) { location.href = 'login.html'; return null; }
      return data.user;
    }

    (async () => {
      const me = await getMe();
      if (!me) return;
      if (me.role !== 'admin') { location.href = 'dashboard.html'; return; }

      // set profile name (optional UI nicety)
      {
        const profileNameEl   = document.getElementById('profileName');
        const profileHeaderEl = document.getElementById('profileHeader');
        const displayName =
          me.full_name ||
          [me.first_name, me.middle_name, me.last_name].filter(Boolean).join(' ') ||
          me.name || me.email || 'Account';

        if (profileNameEl)   profileNameEl.textContent   = displayName;
        if (profileHeaderEl) profileHeaderEl.textContent = 'Signed in as ' + displayName;
      }

      renderSidebar('users', me.role);
      document.getElementById('sidebarToggle')?.addEventListener('click', () => {
        if (typeof toggleSidebar === 'function') toggleSidebar();
        else document.body.classList.toggle('sb-collapsed');
      });

      loadUsers();
    })();

    // ---- Elements ----
    const search       = document.getElementById('searchInput');
    const tbody        = document.getElementById('usersBody');
    const pageInfo     = document.getElementById('pageInfo');
    const pager        = document.getElementById('pager');
    const checkAll     = document.getElementById('checkAll');
    const acctCount    = document.getElementById('acctCount');
    const btnPrimary   = document.getElementById('btnPrimary');

    // Filters
    let roleFilter   = "";
    let statusFilter = "";

    document.querySelectorAll('#filterRole input[name="role"]').forEach(r=>{
      r.addEventListener('change', () => { roleFilter = document.querySelector('#filterRole input:checked').value; render(); });
    });
    document.querySelectorAll('#filterStatus input[name="status"]').forEach(r=>{
      r.addEventListener('change', () => { statusFilter = document.querySelector('#filterStatus input:checked').value; render(); });
    });

    // Modals + form refs
    const userModal = new bootstrap.Modal('#userModal');
    const viewModal = new bootstrap.Modal('#viewUserModal');
    const confirmModal = new bootstrap.Modal('#confirmDeleteModal');

    const form            = document.getElementById('userForm');
    const userModalTitle  = document.getElementById('userModalTitle');

    const fId        = document.getElementById('fId');
    const fFirst     = document.getElementById('fFirst');
    const fMiddle    = document.getElementById('fMiddle');
    const fLast      = document.getElementById('fLast');
    const fSuffix    = document.getElementById('fSuffix');
    const fEmail     = document.getElementById('fEmail');
    const fStatus    = document.getElementById('fStatus');
    const fNotes     = document.getElementById('fNotes');
    const fPassword  = document.getElementById('fPassword');
    const fConfirm   = document.getElementById('fConfirm');

    const errFirst   = document.getElementById('errFirst');
    const errLast    = document.getElementById('errLast');
    const errEmail   = document.getElementById('errEmail');
    const errPassword= document.getElementById('errPassword');
    const errConfirm = document.getElementById('errConfirm');

    // Delete modal refs
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const delWho = document.getElementById('delWho');
    const delEmail = document.getElementById('delEmail');
    let deleteId = null;

    // ---- State ----
    let users = [];
    const pageSize = 10;
    let currentPage = 1;

    // Password toggles
    function setupPwToggle(inputEl, btnId, iconId){
      const btn  = document.getElementById(btnId);
      const icon = document.getElementById(iconId);
      if(!inputEl || !btn || !icon) return;
      btn.addEventListener('click', () => {
        const showing = inputEl.type === 'text';
        inputEl.type = showing ? 'password' : 'text';
        icon.classList.toggle('bi-eye',  showing);
        icon.classList.toggle('bi-eye-slash', !showing);
        btn.setAttribute('aria-label', showing ? 'Show password' : 'Hide password');
      });
    }
    setupPwToggle(fPassword, 'pwToggle1', 'pwIcon1');
    setupPwToggle(fConfirm,  'pwToggle2', 'pwIcon2');

    function fullName(u){
      const parts = [u.firstName, u.middleName, u.lastName].map(v => (v||'').trim()).filter(Boolean);
      const base = parts.join(' ');
      return base + (u.suffix ? ', ' + u.suffix : '');
    }
    const validEmail   = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v||'');
    const strongEnough = pw => /^(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{}|\\:;'"<>,.?/~`]).{8,}$/.test(pw||'');
    const escapeHtml   = s => String(s ?? "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    function clearError(inputEl, errEl){ inputEl?.classList.remove('is-invalid'); if (errEl){ errEl.textContent=''; errEl.classList.add('d-none'); } }
    function setError(inputEl, errEl, msg){ inputEl?.classList.add('is-invalid'); if (errEl){ errEl.textContent=msg; errEl.classList.remove('d-none'); } }

    function applyFilters(){
      const q = (search.value || "").toLowerCase().trim();
      return users.filter(u => {
        const hit = (fullName(u) + " " + (u.email||'') + " " + (u.studentNo || "")).toLowerCase().includes(q);
        const roleOk = roleFilter ? u.role === roleFilter : true;
        const stOk   = statusFilter ? (u.status === statusFilter) : true;
        return hit && roleOk && stOk;
      });
    }

    function actionsMenuHtml(id){
      return `
        <div class="dropdown text-end">
          <button class="kebab-btn" data-bs-toggle="dropdown" data-bs-boundary="viewport" data-bs-auto-close="outside" aria-expanded="false" aria-label="Open actions">
            <i class="bi bi-three-dots-vertical"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end kebab">
            <li><button class="dropdown-item" data-action="view" data-id="${id}"><i class="bi bi-person-badge"></i> View profile</button></li>
            <li><button class="dropdown-item" data-action="edit" data-id="${id}"><i class="bi bi-pencil-square"></i> Edit details</button></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger" data-action="delete" data-id="${id}"><i class="bi bi-trash"></i> Delete user</button></li>
          </ul>
        </div>`;
    }

    function rowHtml(u){
      const statusBadge = u.status === "active"
        ? `<span class="badge text-bg-success-soft">Active</span>`
        : `<span class="badge text-bg-danger-soft">Disabled</span>`;

      const roleBadge = u.role === "admin"
        ? `<span class="role-badge admin">Admin</span>`
        : u.role === "librarian"
          ? `<span class="role-badge librarian">Librarian</span>`
          : `<span class="role-badge student">Student</span>`;

      return `
        <tr>
          <td><input class="form-check-input row-check" type="checkbox" value="${u.id}"></td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <img class="avatar" src="assets/img/default-avatar.png" alt="">
              <div>
                <div class="fw-semibold">${escapeHtml(fullName(u))}</div>
                <div class="small text-muted d-lg-none">${escapeHtml(u.studentNo || "—")}</div>
              </div>
            </div>
          </td>
          <td>${escapeHtml(u.email)}</td>
          <td class="col-role">${roleBadge}</td>
          <td class="d-none d-lg-table-cell col-id">${escapeHtml(u.studentNo || "—")}</td>
          <td class="col-status">${statusBadge}</td>
          <td class="text-end col-actions">${actionsMenuHtml(u.id)}</td>
        </tr>`;
    }

    function buildPager(pages){
      pager.innerHTML = '';
      const add = (label, page, disabled=false, active=false) => {
        const li = document.createElement('li');
        li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
        li.onclick = e => { e.preventDefault(); if(!disabled){ currentPage = page; render(); }};
        pager.appendChild(li);
      };
      const lastPage = Math.max(1, pages);
      add('‹', Math.max(1, currentPage-1), currentPage===1);
      for (let p = 1; p <= lastPage; p++) add(p, p, false, p===currentPage);
      add('›', Math.min(lastPage, currentPage+1), currentPage===lastPage);
    }

    function render(){
      const list = applyFilters();
      const total = list.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > pages) currentPage = pages;

      const start = (currentPage - 1) * pageSize;
      const end   = Math.min(start + pageSize, total);
      const slice = list.slice(start, end);

      acctCount.textContent = String(users.length);

      tbody.innerHTML = slice.length
        ? slice.map(rowHtml).join('')
        : `
          <tr class="empty-row">
            <td colspan="7">
              No users found.
              <div class="mt-2">
                <button class="btn btn-sm btn-dark" id="emptyCta">Add Librarian</button>
              </div>
            </td>
          </tr>`;

      document.getElementById('emptyCta')?.addEventListener('click',()=>btnPrimary.click());

      pageInfo.textContent = total ? `Showing ${start + 1}–${end} of ${total}` : '—';

      buildPager(pages);
      checkAll.checked = false;

      tbody.querySelectorAll('.dropdown-item').forEach(btn=>{
        const id = Number(btn.dataset.id);
        const action = btn.dataset.action;
        btn.onclick = () => {
          if (action==='view')      viewUser(id);
          else if (action==='edit') editUser(id);
          else if (action==='delete') askDelete(id);
        };
      });
    }

    // ---- Load users ----
    async function loadUsers(){
      try {
        const res = await fetch('backend/list-users.php');
        const data = await res.json();
        if (!res.ok || !data.success) {
          alert((data && (data.message || data.error)) || 'Failed to load users.');
          return;
        }
        users = (data.users || []).map(u => ({
          id: Number(u.id),
          firstName: u.first_name,
          middleName: u.middle_name,
          lastName: u.last_name,
          suffix: u.suffix,
          email: u.email,
          role: u.role,
          status: u.status,
          studentNo: u.student_no || "",
          lastActive: u.last_active || null,
          joined: u.joined || null,
          notes: u.notes || ""
        }));
        render();
      } catch (err) {
        alert('Network error while loading users: ' + (err?.message || err));
      }
    }

    // ---- Primary button – Add Librarian ----
    btnPrimary.addEventListener('click', () => {
      userModalTitle.textContent = "Add Librarian";
      fId.value = '';
      fFirst.value = fMiddle.value = fLast.value = fSuffix.value = '';
      fEmail.value = '';
      fStatus.value = 'active';
      fPassword.value = fConfirm.value = '';
      fNotes.value = '';
      [[fFirst,errFirst],[fLast,errLast],[fEmail,errEmail],[fPassword,errPassword],[fConfirm,errConfirm]]
        .forEach(([a,b])=>clearError(a,b));
      userModal.show();
    });

    // ---- Create librarian ----
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      [[fFirst,errFirst],[fLast,errLast],[fEmail,errEmail],[fPassword,errPassword],[fConfirm,errConfirm]]
        .forEach(([a,b])=>clearError(a,b));

      let ok = true;
      if(!(fFirst.value||'').trim()){ setError(fFirst,errFirst,'First name is required.'); ok=false; }
      if(!(fLast.value||'').trim()){  setError(fLast,errLast,'Last name is required.');   ok=false; }
      if(!validEmail(fEmail.value)){  setError(fEmail,errEmail,'Enter a valid email.');   ok=false; }

      const isCreate = !(fId.value||'').trim();
      const pw = fPassword.value || '';
      const cf = fConfirm.value || '';
      if (isCreate){
        if(!pw){ setError(fPassword,errPassword,'Password is required.'); ok=false; }
        if(!cf){ setError(fConfirm,errConfirm,'Please confirm the password.'); ok=false; }
      }
      if (pw){
        if (!strongEnough(pw)){ setError(fPassword,errPassword,'Use ≥8 chars with 1 uppercase & 1 special character.'); ok=false; }
        if (pw !== cf){ setError(fConfirm,errConfirm,'Passwords do not match.'); ok=false; }
      }
      if(!ok) return;

      const model = {
        first_name: (fFirst.value || "").trim(),
        middle_name: (fMiddle.value || "").trim(),
        last_name: (fLast.value || "").trim(),
        suffix: (fSuffix.value || "").trim(),
        email: (fEmail.value || "").trim(),
        password: pw,
        status: fStatus.value
      };

      try {
        const res = await fetch('backend/create-librarian.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(model)
        });

        const raw = await res.text();
        let data;
        try { data = JSON.parse(raw); }
        catch { throw new Error(`Bad response ${res.status}: ${raw.slice(0,400)}`); }

        if (!res.ok || !data || !data.success) {
          const msg = (data && (data.message || data.error)) || `Failed (${res.status}).`;
          if (/email/i.test(msg)) setError(fEmail, errEmail, msg);
          else setError(fPassword, errPassword, msg);
          return;
        }

        const newId = Number(data.id);
        users.unshift({
          id: newId,
          firstName: model.first_name,
          middleName: model.middle_name,
          lastName: model.last_name,
          suffix: model.suffix,
          email: model.email,
          role: 'librarian',
          status: model.status,
          studentNo: '',
          notes: ''
        });

        userModal.hide();
        form.reset();
        render();
        loadUsers(); // refresh from DB
      } catch (err) {
        alert(err.message || 'Network/Server error. Please try again.');
      }
    });

    // Search + select-all
    search.addEventListener('input', () => { currentPage = 1; render(); });
    checkAll.addEventListener('change', () => {
      document.querySelectorAll('.row-check').forEach(cb => cb.checked = checkAll.checked);
    });

    // View/Edit/Delete wiring
    const viewFmt = d => d ? new Date(d).toLocaleString() : '—';
    function setTxt(id, val){ const el=document.getElementById(id); if (el) el.textContent = val ?? '—'; }

    window.viewUser = function(id){
      const u = users.find(x=>x.id===id); if (!u) return;
      document.getElementById('vuAvatar').src = 'assets/img/default-avatar.png';
      document.getElementById('vuName').textContent  = fullName(u);
      document.getElementById('vuEmail').textContent = u.email || '—';

      const roleChip = document.getElementById('vuRole');
      roleChip.textContent = (u.role || '—').replace(/^\w/, c=>c.toUpperCase());
      roleChip.className = 'chip chip-role ' + (u.role || '');

      const stChip = document.getElementById('vuStatus');
      const active = (u.status || '').toLowerCase() === 'active';
      stChip.textContent = active ? 'Active' : 'Disabled';
      stChip.className = 'chip chip-status ' + (active ? '' : 'disabled');

      setTxt('fldFullName', fullName(u));
      setTxt('fldFirst', u.firstName || '—');
      setTxt('fldMiddle', u.middleName || '—');
      setTxt('fldLast', u.lastName || '—');
      setTxt('fldSuffix', u.suffix || '—');
      setTxt('fldEmail', u.email);
      setTxt('fldRole', roleChip.textContent);
      setTxt('fldStatus', stChip.textContent);
      setTxt('fldStudentNo', u.studentNo || '—');
      setTxt('fldLastActive', viewFmt(u.lastActive));
      setTxt('fldJoined', viewFmt(u.joined));
      setTxt('fldNotes', u.notes || '—');

      document.getElementById('vuEditBtn').onclick   = () => { viewModal.hide(); editUser(u.id); };
      document.getElementById('vuDeleteBtn').onclick = () => { viewModal.hide(); askDelete(u.id); };

      viewModal.show();
    };

    window.editUser = function(id){
      const u = users.find(x=>x.id===id); if (!u) return;
      userModalTitle.textContent = "Edit User";
      fId.value = u.id;
      fFirst.value = u.firstName || "";
      fMiddle.value= u.middleName || "";
      fLast.value  = u.lastName || "";
      fSuffix.value= u.suffix || "";
      fEmail.value = u.email || "";
      fStatus.value= u.status || "active";
      fNotes.value  = u.notes || "";
      fPassword.value = '';
      fConfirm.value  = '';
      [[fFirst,errFirst],[fLast,errLast],[fEmail,errEmail],[fPassword,errPassword],[fConfirm,errConfirm]]
        .forEach(([a,b])=>clearError(a,b));
      userModal.show();
    };

    // --- Delete flow ---
    function askDelete(id){
      const u = users.find(x=>x.id===id);
      if(!u) return;
      deleteId = id;
      delWho.textContent = fullName(u) || '(no name)';
      delEmail.textContent = u.email || '';
      confirmModal.show();
    }

    async function performDelete(){
      if(!deleteId) return;
      try{
        const res = await fetch('backend/delete-user.php', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id: deleteId })
        });
        const data = await res.json();
        if(!res.ok || !data?.success){
          alert(data?.message || 'Failed to delete user.');
          return;
        }
        users = users.filter(u => u.id !== deleteId);
        render();
        confirmModal.hide();
      }catch(err){
        alert('Network/Server error while deleting: ' + (err?.message || err));
      }finally{
        deleteId = null;
      }
    }
    confirmDeleteBtn.addEventListener('click', performDelete);
  </script>
</body>
</html>
