<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack - Overdue Books</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/sidebar.css" rel="stylesheet">`n  <link href="assets/css/responsive.css" rel="stylesheet">
  <link rel="icon" href="assets/img/logo.png" type="image/png">
  <style>
    .loan-drawer { width: 480px; max-width: 90vw; }
    .loan-drawer .offcanvas-body { padding: 1.5rem; }
    .book-cover-small { width: 80px; height: 110px; object-fit: cover; border-radius: 8px; background: #f3f4f6; }

    /* Header */
    .page-title { font-weight: 700; font-size: 1.25rem; }
    .page-subtitle { color: #6b7280; font-size: .9rem; margin-top: -6px; }

    /* Themed cards */
    .od-card { border: 1px solid #e5e7eb; border-left-width: 6px; border-radius: 12px; padding: 16px; background: #fff; }
    .od-card .value { font-weight: 700; font-size: 1.4rem; }
    .od-total { background: #FEE2E2; border-left-color: #ef4444; }
    .od-1to7 { background: #FEF3C7; border-left-color: #f59e0b; }
    .od-8to30 { background: #FFEDD5; border-left-color: #fb923c; }
    .od-30plus { background: #E5E7EB; border-left-color: #1f2937; }

    /* Filters bar */
    .filter-bar { background: #F9FAFB; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 16px; }
    .filter-bar .form-select { border-radius: 10px; padding: 10px 12px; }

    /* Table readability */
    .table-overdue thead th { font-weight: 600; }
    .table-overdue tbody tr { transition: background .15s ease; }
    .table-overdue tbody tr:hover { background: #F9FAFA; }
    .table-overdue tbody td { vertical-align: middle; padding-top: .8rem; padding-bottom: .8rem; }

    .pill { display: inline-block; padding: 4px 10px; border-radius: 9999px; font-weight: 600; font-size: .8rem; }
    .pill-late-a { background: #FEF3C7; color: #92400e; }
    .pill-late-b { background: #FFEDD5; color: #9a3412; }
    .pill-late-c { background: #FEE2E2; color: #991b1b; }

    /* Empty state */
    .empty-box { background: #F1F5F9; border: 1px dashed #cbd5e1; border-radius: 12px; padding: 48px 16px; text-align: center; }
    .empty-box h6 { color: #2563eb; font-weight: 700; }
    .empty-box p { color: #64748b; margin: 0; }
  </style>
</head>
<body class="sb-body">
  <div id="sidebar-root"></div>

  <div class="sb-wrapper">
    <!-- Topbar -->
    <div class="topbar">
      <div class="page-head d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <div class="d-flex align-items-center gap-2">
            <button id="sidebarToggle" class="btn btn-link text-dark p-0 me-2" aria-label="Toggle sidebar">
              <i class="bi bi-list fs-4"></i>
            </button>
            <div>
              <div class="page-title">Overdue</div>
              <div class="page-subtitle">Manage all overdue loans</div>
            </div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 tools-wrap">
          <div class="search-wrap flex-grow-1">
            <i class="bi bi-search"></i>
            <input id="loanSearch" type="search" placeholder="Search member, book title, ISBN…">
          </div>
          <div class="btn-group">
            <button id="btnExport" class="btn btn-outline-secondary d-flex align-items-center gap-2">
              <i class="bi bi-download"></i> Export CSV
            </button>
            <button id="btnBulkEmail" class="btn btn-primary d-flex align-items-center gap-2">
              <i class="bi bi-envelope"></i> Send Email Reminders
            </button>
          </div>
        </div>
      </div>
    </div>

    <main class="container-fluid py-4">
      <!-- Focused cards -->
      <section class="row g-3 mb-3">
        <div class="col-6 col-md-3">
          <div class="od-card od-total">
            <div class="d-flex align-items-center gap-2 mb-1">
              <i class="bi bi-exclamation-triangle-fill text-danger"></i>
              <span class="fw-semibold">Overdue</span>
            </div>
            <div class="value" id="statOverdue">0</div>
            <div class="small text-muted">Total overdue loans</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="od-card od-1to7">
            <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-hourglass text-warning"></i><span class="fw-semibold">1–7 Days Late</span></div>
            <div class="value" id="statLateA">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="od-card od-8to30">
            <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-hourglass-split text-warning"></i><span class="fw-semibold">8–30 Days Late</span></div>
            <div class="value" id="statLateB">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="od-card od-30plus">
            <div class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-clock-history text-primary"></i><span class="fw-semibold">30+ Days Late</span></div>
            <div class="value" id="statLateC">0</div>
          </div>
        </div>
      </section>

      <!-- Filters -->
      <section class="filter-bar mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label">Days Late</label>
            <select id="filterLate" class="form-select">
              <option value="">All</option>
              <option value="1-7">1–7 days late</option>
              <option value="8-30">8–30 days late</option>
              <option value="over30">Over 30 days late</option>
            </select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Due Date</label>
            <select id="filterDue" class="form-select">
              <option value="">Any</option>
              <option value="thisweek">Due this week</option>
              <option value="lastweek">Due last week</option>
              <option value="last30">Due last 30 days</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Overdue Table -->
      <section class="card p-0">
        <div class="table-responsive">
          <table class="table table-overdue align-middle mb-0">
            <thead>
              <tr>
                <th style="width:38px"><input class="form-check-input" type="checkbox" id="checkAll"></th>
                <th>Member</th>
                <th>Book</th>
                <th>Borrowed On</th>
                <th>Due Date</th>
                <th>Days Late</th>
                <th>Status</th>
                <th class="text-end" style="width:160px">Actions</th>
              </tr>
            </thead>
            <tbody id="loanBody"><!-- JS --></tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center p-3 gap-2 flex-wrap">
          <div class="text-muted small" id="pageInfo">Showing 1–10 of 0</div>
          <nav><ul class="pagination pagination-sm mb-0" id="pager"></ul></nav>
        </div>

        <div id="emptyState" class="empty-box d-none">
          <h6><i class="bi bi-check-circle me-2"></i>All clear!</h6>
          <p>No overdue loans. All books are returned on time. 🎉</p>
        </div>
      </section>
    </main>
  </div>

  <!-- Return Book Confirmation Modal -->
  <div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Return</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="returnModalMessage">Are you sure you want to mark this loan as returned?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="btnConfirmReturn">Mark as Returned</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    let allLoans = [];
    let currentPage = 1;
    const pageSize = 20;

    const esc = (s='') => s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const daysBetween = (from, to) => Math.max(0, Math.floor((new Date(to) - new Date(from)) / (1000*60*60*24)));
    const todayStr = () => new Date().toISOString().slice(0,10);

    (async () => {
      const res = await fetch('/api/check-auth', {credentials:'include'});
      if (!res.ok) { location.href = 'login.html'; return; }
      const data = await res.json().catch(()=>null);
      const role = (data?.user?.role || '').toLowerCase();
      if (role !== 'librarian' && role !== 'admin') { location.href = 'dashboard.html'; return; }

      renderSidebar('overdue', role);
      document.getElementById('sidebarToggle')?.addEventListener('click', toggleSidebar);

      // Events
      document.getElementById('loanSearch').addEventListener('input', ()=>{ currentPage=1; render(); });
      document.getElementById('filterLate').addEventListener('change', ()=>{ currentPage=1; render(); });
      document.getElementById('filterDue').addEventListener('change', ()=>{ currentPage=1; render(); });
      document.getElementById('checkAll').addEventListener('change', (e)=>{
        document.querySelectorAll('.row-check').forEach(cb => cb.checked = e.target.checked);
      });
      document.getElementById('btnExport').addEventListener('click', exportCsv);
      document.getElementById('btnBulkEmail').addEventListener('click', sendBulkEmails);

      await loadLoans();
    })();

    async function loadLoans(){
      const url = `/api/loans?active_only=1&overdue_only=1&page=1&pagesize=1000`;
      const res = await fetch(url, {credentials:'include'});
      const data = await res.json().catch(()=>({ok:false}));
      if (!data.ok) { alert('Failed to load overdue loans'); return; }
      allLoans = (data.items||[]).map(l => ({
        ...l,
        days_late: l.due_at ? daysBetween(l.due_at, todayStr()) : 0
      }));
      updateCards();
      render();
    }

    function updateCards(){
      const total = allLoans.length;
      const a = allLoans.filter(l => l.days_late >=1 && l.days_late <=7).length;
      const b = allLoans.filter(l => l.days_late >=8 && l.days_late <=30).length;
      const c = allLoans.filter(l => l.days_late > 30).length;
      document.getElementById('statOverdue').textContent = total;
      document.getElementById('statLateA').textContent = a;
      document.getElementById('statLateB').textContent = b;
      document.getElementById('statLateC').textContent = c;
    }

    function applyFilters(){
      const q = (document.getElementById('loanSearch').value||'').toLowerCase().trim();
      const fLate = document.getElementById('filterLate').value;
      const fDue = document.getElementById('filterDue').value;

      return allLoans.filter(l => {
        const hit = (`${l.student_name} ${l.student_no||''} ${l.book_title} ${l.isbn||''}`).toLowerCase().includes(q);
        let lateOk = true;
        if (fLate === '1-7') lateOk = l.days_late >=1 && l.days_late <=7;
        else if (fLate === '8-30') lateOk = l.days_late >=8 && l.days_late <=30;
        else if (fLate === 'over30') lateOk = l.days_late > 30;

        let dueOk = true;
        if (fDue) {
          const due = l.due_at ? new Date(l.due_at) : null;
          if (!due) dueOk = false;
          else {
            const now = new Date();
            const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate()-now.getDay());
            const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate()+6);
            if (fDue === 'thisweek') dueOk = due >= startOfWeek && due <= endOfWeek;
            else if (fDue === 'lastweek') {
              const ls = new Date(startOfWeek); ls.setDate(ls.getDate()-7);
              const le = new Date(endOfWeek); le.setDate(le.getDate()-7);
              dueOk = due >= ls && due <= le;
            } else if (fDue === 'last30') {
              const last30 = new Date(now); last30.setDate(last30.getDate()-30);
              dueOk = due >= last30 && due <= now;
            }
          }
        }
        return hit && lateOk && dueOk;
      });
    }

    function render(){
      const list = applyFilters();
      const tbody = document.getElementById('loanBody');
      const empty = document.getElementById('emptyState');
      const pageInfo = document.getElementById('pageInfo');
      const pager = document.getElementById('pager');

      if (!list.length){
        tbody.innerHTML='';
        empty.classList.remove('d-none');
        pageInfo.textContent = 'Showing 0 of 0';
        pager.innerHTML = '';
        return;
      }
      empty.classList.add('d-none');

      const total = list.length;
      const pages = Math.max(1, Math.ceil(total/pageSize));
      if (currentPage > pages) currentPage = pages;
      const start = (currentPage-1)*pageSize;
      const end = Math.min(start+pageSize, total);
      const slice = list.slice(start, end);

      tbody.innerHTML = slice.map(rowHtml).join('');
      pageInfo.textContent = `Showing ${total? start+1:0}–${end} of ${total}`;

      pager.innerHTML = '';
      const addP = (lbl,p,dis=false,act=false)=>{
        const li=document.createElement('li');
        li.className=`page-item ${dis?'disabled':''} ${act?'active':''}`;
        li.innerHTML=`<a class="page-link" href="#">${lbl}</a>`;
        li.onclick=(e)=>{e.preventDefault(); if(!dis){currentPage=p; render();}};
        pager.appendChild(li);
      };
      addP('«',1,currentPage===1);
      addP('‹',Math.max(1,currentPage-1),currentPage===1);
      for(let p=1;p<=pages;p++) addP(p,p,false,p===currentPage);
      addP('›',Math.min(pages,currentPage+1),currentPage===pages);
      addP('»',pages,currentPage===pages);
    }

    function rowHtml(l){
      const borrowed = l.borrowed_at ? new Date(l.borrowed_at).toLocaleDateString() : '—';
      const due = l.due_at ? new Date(l.due_at).toLocaleDateString() : '—';
      let sevClass = 'pill-late-a';
      if (l.days_late >=1 && l.days_late <=7) sevClass = 'pill-late-a';
      else if (l.days_late >=8 && l.days_late <=30) sevClass = 'pill-late-b';
      else if (l.days_late > 30) sevClass = 'pill-late-c';
      return `
        <tr>
          <td><input class="form-check-input row-check" type="checkbox" value="${l.loan_id}"></td>
          <td>
            <div class="fw-semibold">${esc(l.student_name)}</div>
            <div class="small text-muted">${esc(l.student_no || '—')}</div>
          </td>
          <td>
            <div class="fw-semibold">${esc(l.book_title)}</div>
            <div class="small text-muted">${esc(l.isbn || '—')}</div>
          </td>
          <td>${borrowed}</td>
          <td>${due}</td>
          <td><span class="pill ${sevClass}">${l.days_late}</span></td>
          <td><span class="badge text-bg-secondary-soft">Overdue</span></td>
          <td class="text-end">
            <div class="d-inline-flex gap-1">
              <button class="btn btn-outline-primary btn-sm" title="View" onclick="viewLoan(${l.loan_id})"><i class="bi bi-eye"></i></button>
              <button class="btn btn-outline-success btn-sm" title="Return" onclick="markReturned(${l.loan_id})"><i class="bi bi-box-arrow-in-left"></i></button>
              <button class="btn btn-outline-secondary btn-sm" title="Email Reminder" onclick="sendReminder(${l.loan_id})"><i class="bi bi-envelope"></i></button>
            </div>
          </td>
        </tr>
      `;
    }

    function exportCsv(){
      const rows = applyFilters().map(l => [
        l.loan_id, l.student_name, l.student_no||'', l.book_title, l.isbn||'',
        l.borrowed_at||'', l.due_at||'', l.days_late
      ]);
      const csv = ["loan_id,member,studentNo,book,isbn,borrowed,due,days_late", ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(","))].join("\n");
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download='overdue.csv'; a.click(); URL.revokeObjectURL(a.href);
    }

    async function markReturned(loanId){
      const loan = allLoans.find(l => l.loan_id == loanId);
      if (!loan) return;
      
      // Show confirmation modal
      const bookTitle = loan.book_title || 'this book';
      document.getElementById('returnModalMessage').textContent = `Mark "${esc(bookTitle)}" as returned?`;
      const modal = new bootstrap.Modal('#returnModal');
      modal.show();
      
      // Set up confirm button handler
      document.getElementById('btnConfirmReturn').onclick = async function() {
        const fd = new FormData(); 
        fd.set('loan_id', String(loanId));
        const res = await fetch('/api/loans/return', {method:'POST', body:fd, credentials:'include'});
        const data = await res.json().catch(()=>({ok:false}));
        modal.hide();
        if (data.ok){ 
          await loadLoans(); 
        } else {
          alert(data.error || 'Failed to mark returned');
        }
      };
    }

    function sendReminder(loanId){
      alert('Email reminder queued for loan #' + loanId + '. (Hook up backend send-mail when ready)');
    }
    function sendBulkEmails(){
      const ids = []; document.querySelectorAll('.row-check:checked').forEach(cb => ids.push(Number(cb.value)));
      if (!ids.length){ alert('Select at least one overdue loan.'); return; }
      alert(`Email reminders queued for ${ids.length} loan(s). (Hook up backend send-mail when ready)`);
    }

    function viewLoan(id){
      const l = allLoans.find(x=>x.loan_id==id); if(!l) return;
      alert(`${l.book_title}\nMember: ${l.student_name}\nBorrowed: ${l.borrowed_at||'—'}\nDue: ${l.due_at||'—'}\nDays late: ${l.days_late}`);
    }

    window.viewLoan = viewLoan;
    window.markReturned = markReturned;
    window.sendReminder = sendReminder;
    window.sendBulkEmails = sendBulkEmails;
  </script>
</body>
</html>
