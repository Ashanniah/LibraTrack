<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack - Borrow / Return</title>

  <!-- Fonts / Icons / Bootstrap -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

  <!-- Shared + page styles -->
  <link href="assets/css/sidebar.css" rel="stylesheet">
  <link href="assets/css/librarian-borrow-return.css" rel="stylesheet">

  <link rel="icon" href="assets/img/LibraTrack-logo.png">
</head>

<body class="sb-body">
  <!-- Shared Sidebar -->
  <div id="sidebar-root"></div>

  <div class="sb-wrapper">
    <!-- Topbar -->
    <div class="topbar">
      <div class="page-head d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-2">
          <button id="sidebarToggle" class="btn btn-link text-dark p-0 me-2" aria-label="Toggle sidebar">
            <i class="bi bi-list fs-4"></i>
          </button>
          <div class="page-title">Borrow / Return</div>
        </div>

        <div class="d-flex align-items-center gap-2 tools-wrap">
          <div class="search-wrap flex-grow-1">
            <i class="bi bi-search"></i>
            <input id="txSearch" type="search" placeholder="Search member, book title, ISBN…">
          </div>
          <button class="btn btn-primary d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#borrowModal">
            <i class="bi bi-box-arrow-up-right"></i> New Borrow
          </button>
        </div>
      </div>
    </div>

    <main class="container-fluid py-4">
      <!-- Quick Stats -->
      <section class="row g-3 mb-3">
        <div class="col-6 col-md-3">
          <div class="card stat">
            <div class="icon bg-primary-subtle text-primary"><i class="bi bi-journal-arrow-up"></i></div>
            <div class="meta"><div class="label">Active Loans</div><div id="statActive" class="value">0</div></div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card stat">
            <div class="icon bg-danger-subtle text-danger"><i class="bi bi-exclamation-triangle"></i></div>
            <div class="meta"><div class="label">Overdue</div><div id="statOverdue" class="value">0</div></div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card stat">
            <div class="icon bg-success-subtle text-success"><i class="bi bi-clipboard-check"></i></div>
            <div class="meta"><div class="label">Returned (today)</div><div id="statReturnedToday" class="value">0</div></div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card stat">
            <div class="icon bg-warning-subtle text-warning"><i class="bi bi-hourglass-split"></i></div>
            <div class="meta"><div class="label">Due Today</div><div id="statDueToday" class="value">0</div></div>
          </div>
        </div>
      </section>

      <!-- Filters -->
      <section class="card p-3 mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-6 col-md-3">
            <label class="form-label">Status</label>
            <select id="filterStatus" class="form-select">
              <option value="">All</option>
              <option value="borrowed">Borrowed</option>
              <option value="overdue">Overdue</option>
              <option value="returned">Returned</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Date</label>
            <select id="filterDate" class="form-select">
              <option value="">Any</option>
              <option value="today">Today</option>
              <option value="thisweek">This Week</option>
              <option value="thismonth">This Month</option>
            </select>
          </div>
          <div class="col-12 col-md-6 text-md-end">
            <div class="btn-group">
              <button id="btnExport" class="btn btn-outline-secondary"><i class="bi bi-download me-2"></i>Export CSV</button>
              <button id="btnMarkReturned" class="btn btn-outline-success"><i class="bi bi-box-arrow-in-left me-1"></i>Return</button>
              <button id="btnDelete" class="btn btn-outline-danger">Delete</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Transactions table -->
      <section class="card p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th style="width:38px"><input class="form-check-input" type="checkbox" id="checkAll"></th>
                <th>Member</th>
                <th>Book</th>
                <th class="d-none d-lg-table-cell">ISBN</th>
                <th>Borrowed</th>
                <th>Due</th>
                <th>Returned</th>
                <th>Status</th>
                <th class="text-end" style="width:140px">Actions</th>
              </tr>
            </thead>
            <tbody id="txBody"><!-- JS --></tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center p-3 gap-2 flex-wrap">
          <div class="text-muted small" id="pageInfo">Showing 1–10 of 0</div>
          <nav><ul class="pagination pagination-sm mb-0" id="pager"></ul></nav>
        </div>

        <div id="emptyState" class="empty d-none">
          <i class="bi bi-journal-arrow-up fs-2 d-block mb-2"></i>
          No transactions found.
        </div>
      </section>
    </main>
  </div>

  <!-- Borrow Modal -->
  <div class="modal fade" id="borrowModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form id="borrowForm" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Record Borrow</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Member</label>
              <input id="bMember" type="text" class="form-control" placeholder="Juan Dela Cruz (2025-12345)" required>
              <div class="invalid-feedback">Member is required.</div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Book (Title – ISBN)</label>
              <input id="bBook" type="text" class="form-control" placeholder="Clean Code — 978-0132350884" required>
              <div class="invalid-feedback">Book is required.</div>
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label">Borrowed Date</label>
              <input id="bBorrowed" type="date" class="form-control" required>
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label">Due Date</label>
              <input id="bDue" type="date" class="form-control" required>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Notes</label>
              <input id="bNotes" type="text" class="form-control" placeholder="Optional…">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button id="btnSaveBorrow" class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Return Modal -->
  <div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <form id="returnForm" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">Record Return</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-2">Confirm the return date for the selected transaction.</p>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Return Date</label>
              <input id="rReturned" type="date" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Condition / Notes</label>
              <input id="rNotes" type="text" class="form-control" placeholder="Good condition, etc.">
            </div>
            <input id="rTxId" type="hidden">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button id="btnSaveReturn" class="btn btn-success" type="submit">Mark as Returned</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Details Modal (Field / Details) -->
  <div class="modal fade" id="viewTxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content txview">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">Transaction Details</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-0">
          <div class="tv-head">
            <div class="tv-icon"><i class="bi bi-journal-bookmark"></i></div>
            <div class="tv-id">
              <div class="tv-title" id="vtBook">—</div>
              <div class="tv-sub small text-muted" id="vtMember">—</div>
              <div class="tv-chips">
                <span id="vtStatus" class="chip chip-status">Borrowed</span>
                <span id="vtIsbn" class="chip chip-neutral">ISBN —</span>
              </div>
            </div>
            <div class="tv-actions">
              <button class="btn btn-outline-success btn-sm" id="vtReturnBtn"><i class="bi bi-box-arrow-in-left me-1"></i>Return</button>
            </div>
          </div>

          <div class="tv-sheet">
            <div class="tv-row tv-headrow">
              <div class="tv-col tv-field"><i class="bi bi-info-circle me-2"></i> Field</div>
              <div class="tv-col tv-value"><i class="bi bi-clipboard-check me-2"></i> Details</div>
            </div>

            <div class="tv-row"><div class="tv-col tv-field"><i class="bi bi-calendar-plus"></i> Borrowed</div><div class="tv-col tv-value" id="vfBorrowed">—</div></div>
            <div class="tv-row"><div class="tv-col tv-field"><i class="bi bi-hourglass-split"></i> Due</div><div class="tv-col tv-value" id="vfDue">—</div></div>
            <div class="tv-row"><div class="tv-col tv-field"><i class="bi bi-calendar-check"></i> Returned</div><div class="tv-col tv-value" id="vfReturned">—</div></div>
            <div class="tv-row"><div class="tv-col tv-field"><i class="bi bi-bookmark"></i> Notes</div><div class="tv-col tv-value" id="vfNotes">—</div></div>
          </div>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    // Sidebar + highlight
    renderSidebar('borrowreturn');
    document.getElementById('sidebarToggle')?.addEventListener('click', toggleSidebar);

    // ===== Demo Data (hook to PHP later) =====
    // books referenced by title/isbn to make UI realistic
    const books = [
      {isbn:"978-0132350884", title:"Clean Code"},
      {isbn:"978-0135957059", title:"The Pragmatic Programmer"},
      {isbn:"978-1408855652", title:"Harry Potter and the Philosopher's Stone"}
    ];
    const members = [
      {studNo:"2025-12345", name:"Juan Dela Cruz"},
      {studNo:"2025-10322", name:"Ana Santos"},
      {studNo:"2024-88231", name:"Mark Reyes"}
    ];
    let AUTOINC = 5;
    // transaction model: {id, memberName, memberNo, bookTitle, isbn, borrowedAt, dueAt, returnedAt?, notes}
    let tx = [
      {id:1, memberName:"Juan Dela Cruz", memberNo:"2025-12345", bookTitle:"Clean Code", isbn:"978-0132350884", borrowedAt:"2025-09-08", dueAt:"2025-09-15", notes:""},
      {id:2, memberName:"Ana Santos", memberNo:"2025-10322", bookTitle:"The Pragmatic Programmer", isbn:"978-0135957059", borrowedAt:"2025-09-10", dueAt:"2025-09-17", returnedAt:"2025-09-12", notes:""},
      {id:3, memberName:"Mark Reyes", memberNo:"2024-88231", bookTitle:"Harry Potter and the Philosopher's Stone", isbn:"978-1408855652", borrowedAt:"2025-09-01", dueAt:"2025-09-05", notes:"Follow up email sent"}
    ];

    // ===== Elements =====
    const txBody = document.getElementById('txBody');
    const empty = document.getElementById('emptyState');
    const search = document.getElementById('txSearch');
    const fStatus = document.getElementById('filterStatus');
    const fDate = document.getElementById('filterDate');
    const checkAll = document.getElementById('checkAll');
    const pageInfo = document.getElementById('pageInfo');
    const pager = document.getElementById('pager');

    const statActive = document.getElementById('statActive');
    const statOverdue = document.getElementById('statOverdue');
    const statReturnedToday = document.getElementById('statReturnedToday');
    const statDueToday = document.getElementById('statDueToday');

    // modals
    const borrowModal = new bootstrap.Modal('#borrowModal');
    const returnModal = new bootstrap.Modal('#returnModal');
    const viewTxModal = new bootstrap.Modal('#viewTxModal');

    // forms
    const borrowForm = document.getElementById('borrowForm');
    const bMember = document.getElementById('bMember');
    const bBook = document.getElementById('bBook');
    const bBorrowed = document.getElementById('bBorrowed');
    const bDue = document.getElementById('bDue');
    const bNotes = document.getElementById('bNotes');

    const returnForm = document.getElementById('returnForm');
    const rReturned = document.getElementById('rReturned');
    const rNotes = document.getElementById('rNotes');
    const rTxId = document.getElementById('rTxId');

    // view refs
    const vtBook = document.getElementById('vtBook');
    const vtMember = document.getElementById('vtMember');
    const vtStatus = document.getElementById('vtStatus');
    const vtIsbn = document.getElementById('vtIsbn');
    const vtReturnBtn = document.getElementById('vtReturnBtn');
    const vfBorrowed = document.getElementById('vfBorrowed');
    const vfDue = document.getElementById('vfDue');
    const vfReturned = document.getElementById('vfReturned');
    const vfNotes = document.getElementById('vfNotes');

    // ===== Helpers =====
    const pageSize = 10;
    let currentPage = 1;

    const todayStr = () => new Date().toISOString().slice(0,10);
    function isOverdue(rec){ return !rec.returnedAt && rec.dueAt < todayStr(); }
    function statusOf(rec){
      if(rec.returnedAt) return 'returned';
      if(isOverdue(rec)) return 'overdue';
      return 'borrowed';
    }
    function inDateRange(rec, filter){
      const d = rec.borrowedAt;
      const now = new Date();
      const weekStart = new Date(now); weekStart.setDate(now.getDate()-now.getDay());
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      if(filter==='today') return d === todayStr();
      if(filter==='thisweek') return new Date(d) >= weekStart;
      if(filter==='thismonth') return new Date(d) >= monthStart;
      return true;
    }

    function applyFilters(){
      const q = (search.value||"").toLowerCase().trim();
      const st = fStatus.value;
      const dr = fDate.value;

      return tx.filter(t=>{
        const hit = (t.memberName+" "+t.memberNo+" "+t.bookTitle+" "+t.isbn).toLowerCase().includes(q);
        const stOk = st ? statusOf(t)===st : true;
        const drOk = inDateRange(t, dr);
        return hit && stOk && drOk;
      });
    }

    function render(){
      const list = applyFilters();

      // stats
      const active = list.filter(r=>statusOf(r)==='borrowed').length;
      const overdue = list.filter(r=>statusOf(r)==='overdue').length;
      const returnedToday = list.filter(r=>r.returnedAt===todayStr()).length;
      const dueToday = list.filter(r=>!r.returnedAt && r.dueAt===todayStr()).length;
      statActive.textContent = active;
      statOverdue.textContent = overdue;
      statReturnedToday.textContent = returnedToday;
      statDueToday.textContent = dueToday;

      // paging
      const total = list.length;
      const pages = Math.max(1, Math.ceil(total/pageSize));
      if(currentPage>pages) currentPage = pages;
      const start = (currentPage-1)*pageSize;
      const end = Math.min(start+pageSize,total);
      const slice = list.slice(start,end);

      empty.classList.toggle('d-none', !!slice.length);
      txBody.innerHTML = slice.map(rowHtml).join('');
      pageInfo.textContent = `Showing ${total? start+1:0}–${end} of ${total}`;

      pager.innerHTML = '';
      const addItem=(label, page, disabled=false, active=false)=>{
        const li = document.createElement('li');
        li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
        li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
        li.onclick = (e)=>{e.preventDefault(); if(!disabled){ currentPage=page; render(); }};
        pager.appendChild(li);
      };
      addItem('«',1,currentPage===1); addItem('‹',Math.max(1,currentPage-1),currentPage===1);
      for(let p=1;p<=pages;p++) addItem(p,p,false,p===currentPage);
      addItem('›',Math.min(pages,currentPage+1),currentPage===pages); addItem('»',pages,currentPage===pages);

      checkAll.checked = false;
    }

    function rowHtml(r){
      const st = statusOf(r);
      const badge = st==='returned'
        ? `<span class="badge text-bg-success-soft">Returned</span>`
        : st==='overdue'
          ? `<span class="badge text-bg-danger-soft">Overdue</span>`
          : `<span class="badge text-bg-primary-soft">Borrowed</span>`;
      return `
      <tr>
        <td><input class="form-check-input row-check" type="checkbox" value="${r.id}"></td>
        <td><div class="fw-medium">${escape(r.memberName)}</div><div class="small text-muted">${escape(r.memberNo)}</div></td>
        <td>${escape(r.bookTitle)}</td>
        <td class="d-none d-lg-table-cell">${escape(r.isbn)}</td>
        <td>${r.borrowedAt}</td>
        <td>${r.dueAt}</td>
        <td>${r.returnedAt || '—'}</td>
        <td>${badge}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" title="View" onclick="viewTx(${r.id})"><i class="bi bi-eye"></i></button>
            ${st!=='returned' ? `<button class="btn btn-outline-success" title="Return" onclick="openReturn(${r.id})"><i class="bi bi-box-arrow-in-left"></i></button>`:''}
            <button class="btn btn-outline-danger" title="Delete" onclick="deleteTx(${r.id})"><i class="bi bi-trash3"></i></button>
          </div>
        </td>
      </tr>`;
    }
    const escape = s => String(s??'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));

    // ===== Events =====
    search.addEventListener('input', ()=>{ currentPage=1; render(); });
    fStatus.addEventListener('change', ()=>{ currentPage=1; render(); });
    fDate.addEventListener('change', ()=>{ currentPage=1; render(); });
    checkAll.addEventListener('change', ()=>{ document.querySelectorAll('.row-check').forEach(cb=>cb.checked=checkAll.checked); });

    document.getElementById('btnMarkReturned').onclick = ()=>{
      const ids = selectedIds(); if(!ids.length) return alert('Select transactions first.');
      const first = tx.find(t=>ids.includes(t.id) && !t.returnedAt);
      if(!first) return alert('Selected transactions are already returned.');
      // open modal prefilled with today for the first one
      rTxId.value = first.id; rReturned.value = todayStr(); rNotes.value="";
      returnModal.show();
    };
    document.getElementById('btnDelete').onclick = ()=>{
      const ids = selectedIds(); if(!ids.length) return alert('Select transactions first.');
      if(!confirm('Delete selected transactions?')) return;
      tx = tx.filter(t=>!ids.includes(t.id)); render();
    };
    document.getElementById('btnExport').onclick = ()=>{
      const rows = applyFilters().map(r=>[r.id,r.memberName,r.memberNo,r.bookTitle,r.isbn,r.borrowedAt,r.dueAt,r.returnedAt||"",statusOf(r),r.notes||""]);
      const csv = ["id,member,studentNo,book,isbn,borrowed,due,returned,status,notes", ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(","))].join("\n");
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
      a.download = "transactions.csv"; a.click(); URL.revokeObjectURL(a.href);
    };

    // Borrow form
    document.getElementById('borrowModal').addEventListener('shown.bs.modal', ()=>{
      // defaults
      bBorrowed.value = todayStr();
      const d = new Date(); d.setDate(d.getDate()+7); bDue.value = d.toISOString().slice(0,10);
    });
    borrowForm.addEventListener('submit', (e)=>{
      e.preventDefault(); borrowForm.classList.add('was-validated'); if(!borrowForm.checkValidity()) return;
      // very light parsing: "Name (StudNo)"
      const memRaw = bMember.value.trim();
      const match = memRaw.match(/(.+)\s+\((.+)\)$/);
      const memberName = match ? match[1] : memRaw;
      const memberNo = match ? match[2] : "";
      // "Title — ISBN"
      const bookRaw = bBook.value.trim();
      const parts = bookRaw.split("—");
      const bookTitle = parts[0].trim();
      const isbn = (parts[1]||"").trim();

      const rec = {
        id: AUTOINC++,
        memberName, memberNo,
        bookTitle, isbn,
        borrowedAt: bBorrowed.value,
        dueAt: bDue.value,
        notes: bNotes.value.trim()
      };
      tx.unshift(rec);
      borrowModal.hide(); borrowForm.reset(); borrowForm.classList.remove('was-validated'); currentPage=1; render();
    });

    // Return form
    returnForm.addEventListener('submit', (e)=>{
      e.preventDefault(); returnForm.classList.add('was-validated'); if(!returnForm.checkValidity()) return;
      const id = Number(rTxId.value);
      tx = tx.map(t => t.id===id ? {...t, returnedAt:rReturned.value, notes: (t.notes? t.notes+" | ":"") + (rNotes.value.trim()||"")} : t);
      returnModal.hide(); returnForm.reset(); returnForm.classList.remove('was-validated'); render();
    });

    // View & Return helpers
    window.viewTx = function(id){
      const t = tx.find(x=>x.id===id); if(!t) return;
      vtBook.textContent = t.bookTitle;
      vtMember.textContent = `${t.memberName} • ${t.memberNo||"—"}`;
      vtIsbn.textContent = `ISBN ${t.isbn||"—"}`;
      const st = statusOf(t);
      vtStatus.textContent = st.charAt(0).toUpperCase()+st.slice(1);
      vtStatus.className = 'chip chip-status ' + (st==='overdue'?'danger': st==='returned'?'success':'');
      vfBorrowed.textContent = t.borrowedAt;
      vfDue.textContent = t.dueAt;
      vfReturned.textContent = t.returnedAt || '—';
      vfNotes.textContent = t.notes || '—';
      if(st==='returned'){ vtReturnBtn.classList.add('d-none'); }
      else { vtReturnBtn.classList.remove('d-none'); vtReturnBtn.onclick = ()=>{ openReturn(id); viewTxModal.hide(); }; }
      viewTxModal.show();
    };
    window.openReturn = function(id){
      const t = tx.find(x=>x.id===id); if(!t) return;
      rTxId.value = t.id; rReturned.value = todayStr(); rNotes.value="";
      returnModal.show();
    };
    window.deleteTx = function(id){
      if(!confirm('Delete this transaction?')) return;
      tx = tx.filter(t=>t.id!==id); render();
    };

    function selectedIds(){ const ids=[]; document.querySelectorAll('.row-check:checked').forEach(cb=>ids.push(Number(cb.value))); return ids; }

    // Init
    render();
  </script>
</body>
</html>
