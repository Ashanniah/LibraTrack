<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack – Librarian · Students</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/sidebar.css" rel="stylesheet">
  <link href="assets/css/admin-users.css" rel="stylesheet">
  <link href="assets/css/librarian-students.css" rel="stylesheet">
  <link href="assets/css/responsive.css" rel="stylesheet">
  <link rel="icon" href="assets/img/logo.png" type="image/png">

  <style>
    :root{
      --card-pad:24px;
      --cell-pad-y:14px;
      --cell-pad-x:20px;
      --ui-muted:#6b7280;
      --ui-border:#eef0f3;
      --ui-soft:#f6f7f9;
      --brand-black:#111827;
      --brand-gold:#a68604;
      --gold-dark:#8d7003;
      --sidebar-bg:#111;
      --text-primary:#212529;
      --text-secondary:#6b7280;
      --border-radius:12px;
      --border-radius-sm:8px;
      --border-radius-lg:16px;
      --shadow-sm:0 2px 4px rgba(0,0,0,.04);
      --shadow-md:0 4px 12px rgba(0,0,0,.08);
      --shadow-lg:0 6px 18px rgba(0,0,0,.12);
      --header-bg:#fff;
      --table-header-bg:#f8f9fa;
      --card-border:#e5e7eb;
    }
    html{font-size:14px;}
    body{font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"}

    main.container-fluid{padding-top:24px!important; padding-left:24px!important; padding-right:24px!important}
    
    /* Table Card Header - Dark Background */
    .table-card.card{
      border-radius:var(--border-radius-lg);
      box-shadow:var(--shadow-sm);
      border:1px solid var(--ui-border);
      overflow:visible;
      background:#fff;
    }
    .table-card .card-header{
      padding:20px var(--card-pad);
      border-bottom:0;
      background:var(--sidebar-bg);
      color:#fff;
      border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0;
    }
    .table-card .card-header .fw-semibold{
      color:#fff;
      font-size:1rem;
      font-weight:600;
    }
    .table-card .card-header .text-muted{
      color:rgba(255,255,255,0.7) !important;
    }
    .table-card .card-header .count-pill{
      font-size:.85rem;
      color:#111;
      background:#fff;
      border:1px solid rgba(255,255,255,0.2);
      padding:.15rem .5rem;
      border-radius:999px;
      font-weight:600;
      margin-left:0.5rem;
    }
    .table-card .card-body{padding:0}
    
    /* Skeleton Loaders for Table Rows */
    .skeleton-table-row td {
      padding: 16px 20px;
    }
    .skeleton-table-cell {
      height: 1rem;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
    }
    .skeleton-table-cell.short {
      width: 60%;
    }
    .skeleton-table-cell.medium {
      width: 80%;
    }
    .skeleton-table-cell.long {
      width: 100%;
    }
    .skeleton-checkbox {
      width: 18px;
      height: 18px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
    }
    .skeleton-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      flex-shrink: 0;
    }
    .skeleton-badge {
      width: 60px;
      height: 24px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 12px;
    }
    .skeleton-button {
      width: 32px;
      height: 32px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
      display: inline-block;
    }
    @keyframes skeleton-shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Pagination Styling */
    .pagination{gap:.35rem}
    .pagination .page-link{
      border:1px solid var(--ui-border);
      border-radius:var(--border-radius-sm)!important;
      padding:.35rem .6rem;
      color:var(--text-primary);
      background:#fff;
      font-size:0.875rem;
      font-weight:500;
      transition:all 0.2s ease;
    }
    .pagination .page-link:hover{
      background:#f5f5f5;
      border-color:var(--brand-gold);
      color:var(--text-primary);
    }
    .pagination .page-item.active .page-link{
      background:var(--brand-gold)!important;
      color:#fff!important;
      border-color:var(--brand-gold)!important;
    }
    .pagination .page-item.disabled .page-link{opacity:.4}
    
    /* Consistent Header Design */
    .admin-header-gold {
      background: #fff !important;
      color: var(--text-primary) !important;
      border-bottom:1px solid var(--ui-border);
      box-shadow:var(--shadow-sm);
      padding:12px 0;
    }
    .admin-header-gold .fw-bold,
    .admin-header-gold .h5,
    .admin-header-gold #pageTitle {
      color: var(--text-primary) !important;
      font-weight:700;
      font-size:1.25rem;
      letter-spacing:0.01em;
    }
    
    /* Consistent Search Bar Design */
    .search-bar-custom {
      height: 42px;
    }
    .search-bar-custom .input-group-text,
    .search-bar-custom .form-control {
      height: 42px;
      padding: 10px 16px;
      font-size:0.875rem;
    }
    .search-bar-custom .input-group-text {
      border-top-left-radius: var(--border-radius-sm);
      border-bottom-left-radius: var(--border-radius-sm);
      background: var(--table-header-bg) !important;
      border: 1px solid var(--card-border);
      border-right: none !important;
      color:var(--text-secondary);
    }
    .search-bar-custom .form-control {
      border-top-right-radius: var(--border-radius-sm);
      border-bottom-right-radius: var(--border-radius-sm);
      background: var(--table-header-bg) !important;
      border: 1px solid var(--card-border);
      border-left: none !important;
      color: var(--text-primary);
      outline: none !important;
      box-shadow: none !important;
    }
    .search-bar-custom .form-control:focus {
      outline: none !important;
      box-shadow: none !important;
      border-color: var(--ui-border) !important;
    }
    .search-bar-custom .form-control::placeholder {
      color: var(--ui-muted);
    }
    .search-bar-custom:focus-within {
      box-shadow: 0 0 0 3px rgba(166, 134, 4, 0.15);
      border-radius: var(--border-radius-sm);
    }
    .search-bar-custom:focus-within .input-group-text {
      border-color: var(--brand-gold);
      border-right: none !important;
      background: #fff !important;
    }
    .search-bar-custom:focus-within .form-control {
      border-color: var(--brand-gold);
      border-left: none !important;
      background: #fff !important;
    }
    .search-bar-custom:focus-within .search-icon-wrapper {
      background: #fff !important;
      color: var(--text-primary) !important;
      border-color: var(--brand-gold);
    }

    .admin-btn-custom {
      padding: 0;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--card-border);
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      overflow: hidden;
    }
    .admin-btn-custom:hover {
      border-color: var(--brand-gold);
      box-shadow: 0 0 0 2px rgba(166, 134, 4, 0.1);
    }
    .admin-btn-custom:focus,
    .admin-btn-custom:active,
    .admin-btn-custom.show {
      border-color: var(--brand-gold) !important;
      box-shadow: 0 0 0 0.2rem rgba(166, 134, 4, 0.25) !important;
    }
    .admin-btn-custom img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* Filter Button Styling */
    .filter-btn{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      border-radius:var(--border-radius-sm);
      border-color:var(--ui-border);
      background:#fff;
      color:var(--text-primary) !important;
      padding:10px 16px;
      font-weight:500;
      font-size:0.875rem;
    }
    .filter-btn i,
    .filter-btn span{
      color:var(--text-primary) !important;
    }
    .filter-btn.active{
      background:var(--brand-gold) !important;
      border-color:var(--brand-gold) !important;
      color:#fff !important;
    }
    .filter-btn.active i,
    .filter-btn.active span{
      color:#fff !important;
    }
    .filter-btn.active:hover{
      background:#fff !important;
      border-color:var(--brand-gold) !important;
    }
    .filter-btn.active:hover i,
    .filter-btn.active:hover span{
      color:#000 !important;
    }
    .filter-btn:hover:not(.active){
      background:#f8f9fa !important;
      border-color:var(--brand-gold);
      color:var(--text-primary) !important;
    }
    .filter-btn:hover:not(.active) i,
    .filter-btn:hover:not(.active) span{
      color:var(--text-primary) !important;
    }
    .filter-menu{
      min-width:260px;
      padding:.5rem;
      border-radius:var(--border-radius);
      box-shadow:var(--shadow-lg);
      border:1px solid var(--ui-border);
      margin-top:8px;
    }
    .filter-title{
      font-weight:600;
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--text-secondary);
      padding:0.5rem 0.75rem 0.25rem;
      margin-bottom:0.25rem;
    }
    .filter-section{
      padding:0.25rem 0.5rem;
      margin-bottom:0.5rem;
    }
    .filter-option{
      display:block;
      padding:0.5rem 0.75rem;
      border-radius:var(--border-radius-sm);
      cursor:pointer;
      transition:background-color 0.2s ease;
      margin:0;
      font-size:0.875rem;
      color:var(--text-primary);
    }
    .filter-option:hover{
      background:#f8f9fa;
    }
    .filter-option input[type="radio"]{
      margin-right:0.5rem;
      cursor:pointer;
    }

    /* Search Group in Card Header */
    .search-group .input-group-text,
    .search-group .form-control{
      background:#fff;
      border:1px solid var(--ui-border);
      height:44px;
      transition:all 0.2s ease;
    }
    .search-group .input-group-text{
      border-right:0;
      border-top-left-radius:var(--border-radius-sm);
      border-bottom-left-radius:var(--border-radius-sm);
      color:var(--text-secondary);
    }
    .search-group .form-control{
      border-left:0;
      border-top-right-radius:var(--border-radius-sm);
      border-bottom-right-radius:var(--border-radius-sm);
      color:var(--text-primary);
    }
    .search-group:focus-within{
      box-shadow:0 0 0 3px rgba(166,134,4,0.15);
      border-radius:var(--border-radius-sm);
    }
    .search-group:focus-within .input-group-text,
    .search-group:focus-within .form-control{
      border-color:var(--brand-gold);
    }
    .search-group .form-control:focus{
      box-shadow:none;
      border-color:var(--brand-gold);
    }
    .search-wide { width: 460px; max-width: 48vw; }
    
    /* Filter Button in Dark Header */
    .table-card .card-header .filter-btn{
      background:transparent !important;
      color:#fff !important;
      border-color:#fff !important;
      border-width:1px;
    }
    .table-card .card-header .filter-btn i,
    .table-card .card-header .filter-btn span{
      color:#fff !important;
    }
    .table-card .card-header .filter-btn.active{
      background:var(--brand-gold) !important;
      border-color:var(--brand-gold) !important;
      color:#fff !important;
    }
    .table-card .card-header .filter-btn.active i,
    .table-card .card-header .filter-btn.active span{
      color:#fff !important;
    }
    .table-card .card-header .filter-btn:hover:not(.active){
      background:rgba(255,255,255,0.1) !important;
      border-color:#fff !important;
      color:#fff !important;
    }
    .table-card .card-header .filter-btn:hover:not(.active) i,
    .table-card .card-header .filter-btn:hover:not(.active) span{
      color:#fff !important;
    }
    .table-card .card-header .btn-dark{
      background:var(--brand-gold) !important;
      border-color:var(--brand-gold) !important;
      color:#fff !important;
    }
    .table-card .card-header .btn-dark:hover{
      background:var(--gold-dark) !important;
      border-color:var(--gold-dark) !important;
      color:#fff !important;
    }

    /* Action Buttons - Individual Icons */
    .action-btn{
      padding:0.375rem 0.5rem;
      border-radius:var(--border-radius-sm);
      border:1px solid transparent;
      background:transparent;
      transition:all 0.2s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:32px;
      height:32px;
    }
    .action-btn i{
      font-size:1rem;
    }
    .action-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .action-view{
      color:#000 !important;
    }
    .action-view:hover{
      background:#f8f9fa !important;
      border-color:#000 !important;
      color:#000 !important;
    }
    .action-edit{
      color:#0d6efd !important;
    }
    .action-edit:hover{
      background:rgba(13,110,253,0.1) !important;
      border-color:#0d6efd !important;
      color:#0d6efd !important;
    }
    .action-delete{
      color:#dc3545 !important;
    }
    .action-delete:hover{
      background:rgba(220,53,69,0.1) !important;
      border-color:#dc3545 !important;
      color:#dc3545 !important;
    }

    /* User View Modal - 2 Column Layout */
    .userview-2col .modal-content{
      border-radius:var(--border-radius-lg);
      border:1px solid var(--ui-border);
      box-shadow:var(--shadow-lg);
    }
    .userview-2col .modal-header,
    .userview-2col .modal-header.modal-header-dark{
      background:var(--sidebar-bg) !important;
      color:#fff !important;
      border-bottom:0 !important;
      border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0 !important;
      padding:24px 24px !important;
      min-height:60px !important;
    }
    .userview-2col .modal-header .modal-title{
      color:#fff;
      font-weight:700;
      font-size:1.125rem;
    }
    .userview-2col .modal-header .btn-close{
      filter:invert(1) grayscale(1);
      opacity:0.8;
    }
    .userview-2col .modal-header .btn-close:hover{
      opacity:1;
    }
    .userview-2col .modal-body{
      padding:24px !important;
      background:#fff;
    }
    .userview-2col .vu-head{
      display:flex;
      gap:20px;
      align-items:center;
      margin-bottom:24px;
      padding-bottom:20px;
      border-bottom:1px solid var(--ui-border);
    }
    .userview-2col .vu-avatar{
      flex-shrink:0;
    }
    .userview-2col .vu-avatar img{
      width:80px;
      height:80px;
      border-radius:50%;
      object-fit:cover;
      border:3px solid #f0f0f0;
    }
    .userview-2col .vu-id{
      flex:1;
    }
    .userview-2col .vu-name{
      font-weight:700;
      font-size:1.25rem;
      color:var(--text-primary);
      margin-bottom:4px;
    }
    .userview-2col .vu-email{
      font-size:0.875rem;
      color:var(--text-secondary);
      margin-bottom:12px;
    }
    .userview-2col .vu-chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .userview-2col .vu-actions{
      display:flex;
      gap:8px;
      flex-shrink:0;
    }
    .userview-2col .vu-actions .btn{
      border-radius:var(--border-radius-sm);
      font-weight:500;
      padding:8px 16px;
    }
    .userview-2col .vu-sheet{
      margin-top:0;
      border:1px solid var(--ui-border);
      border-radius:var(--border-radius);
      overflow:hidden;
      background:#fff;
    }
    .userview-2col .vu-row{
      display:grid !important;
      grid-template-columns:160px 1fr !important;
      gap:16px;
      padding:14px 20px;
      border-bottom:1px solid #f0f0f0;
      align-items:center;
    }
    .userview-2col .vu-row:last-child{
      border-bottom:none;
    }
    .userview-2col .vu-row:hover{
      background-color:#f8f9fa;
    }
    .userview-2col .vu-col{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .userview-2col .vu-field{
      font-weight:700;
      color:var(--text-secondary);
      font-size:0.875rem;
    }
    .userview-2col .vu-field i{
      color:var(--text-secondary);
      font-size:0.875rem;
      width:18px;
      text-align:center;
    }
    .userview-2col .vu-value{
      font-weight:500;
      color:var(--text-primary);
      font-size:0.875rem;
    }
    .userview-2col .vu-headrow{
      font-weight:700;
      background:#a68604 !important;
      color:#fff !important;
      border-bottom:none !important;
      padding:16px 20px;
    }
    .userview-2col .vu-headrow .vu-col{
      background:transparent !important;
      border:none !important;
    }
    .userview-2col .vu-headrow .vu-field,
    .userview-2col .vu-headrow .vu-value{
      color:#fff !important;
      font-size:0.8125rem;
      font-weight:700 !important;
      text-transform:uppercase;
      letter-spacing:0.05em;
      background:transparent !important;
      border:none !important;
    }
    .userview-2col .vu-headrow .vu-field i,
    .userview-2col .vu-headrow .vu-value i{
      color:#fff !important;
      filter:none !important;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      padding:0.25rem 0.75rem;
      border-radius:999px;
      font-size:0.75rem;
      font-weight:600;
    }
    .chip-role{
      background:rgba(13,110,253,0.12);
      color:#0d6efd;
      border:1px solid rgba(13,110,253,0.2);
    }
    .chip-role.admin{
      background:#4a4a4a;
      color:#fff;
      border:none;
    }
    .chip-role.student{
      background:rgba(111,66,193,0.12);
      color:#6f42c1;
      border:1px solid rgba(111,66,193,0.2);
    }
    .chip-status{
      background:rgba(25,135,84,0.12);
      color:#198754;
      border:1px solid rgba(25,135,84,0.2);
    }
    .chip-status.disabled{
      background:rgba(220,53,69,0.12);
      color:#dc3545;
      border:1px solid rgba(220,53,69,0.2);
    }
    .userview-2col .modal-footer{
      border-top:1px solid var(--ui-border);
      padding:16px 24px;
      background:#f8f9fa;
      border-radius:0 0 var(--border-radius-lg) var(--border-radius-lg);
    }
    .userview-2col .modal-footer .btn{
      border-radius:var(--border-radius-sm);
      font-weight:500;
      padding:8px 20px;
      background:#4a4a4a !important;
      border-color:#4a4a4a !important;
      color:#fff !important;
    }
    .userview-2col .modal-footer .btn:hover{
      background:#3a3a3a !important;
      border-color:#3a3a3a !important;
      color:#fff !important;
    }

    /* Student Modal Styling - Match Admin Users */
    #studentModal .modal-content{
      border-radius:var(--border-radius-lg);
      border:none;
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      overflow:visible !important;
    }
    #studentModal .modal-header-dark{
      background:var(--sidebar-bg) !important;
      color:#fff !important;
      border-bottom:none !important;
      border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0 !important;
      padding:24px 32px !important;
      min-height:64px !important;
    }
    #studentModal .modal-header-dark .modal-title{
      color:#fff !important;
      font-weight:700 !important;
      font-size:1.25rem;
      letter-spacing:-0.01em;
    }
    #studentModal .modal-header-dark .btn-close{
      filter:invert(1) grayscale(1);
      opacity:0.7;
      transition:opacity 0.2s ease;
      padding:8px;
    }
    #studentModal .modal-header-dark .btn-close:hover{
      opacity:1;
    }

    .name-grid{display:grid;grid-template-columns:1fr 1fr 1fr minmax(130px,180px);gap:14px}
    @media (max-width: 768px){ .name-grid{grid-template-columns:1fr 1fr} }
    
    /* Modern Form Styling */
    #studentModal .modal-body{
      padding:32px !important;
      background:#fff;
      overflow:visible !important;
    }
    #studentModal .modal-content{
      overflow:visible !important;
    }
    #studentModal .modal-dialog{
      overflow:visible !important;
    }
    #studentModal .form-label{
      font-weight:600;
      font-size:0.875rem;
      color:#374151;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    #studentModal .form-label:has(+ .form-text-hint){
      margin-bottom:4px;
    }
    #studentModal .form-control,
    #studentModal .form-select{
      padding:10px 14px;
      font-size:0.9375rem;
      border:1.5px solid #e5e7eb;
      border-radius:8px;
      background:#fff;
      color:#111827;
      transition:all 0.2s ease;
    }
    #studentModal .form-control:focus,
    #studentModal .form-select:focus{
      border-color:var(--brand-gold);
      box-shadow:0 0 0 3px rgba(166,134,4,0.1);
      outline:none;
    }
    #studentModal .form-control:hover:not(:focus),
    #studentModal .form-select:hover:not(:focus){
      border-color:#d1d5db;
    }
    #studentModal .form-control::placeholder{
      color:#9ca3af;
      font-size:0.875rem;
    }
    #studentModal .form-text-hint{
      font-size:0.75rem;
      color:#6b7280;
      margin-top:4px;
      margin-bottom:0;
      font-weight:400;
    }
    #studentModal .form-control.is-invalid,
    #studentModal .form-select.is-invalid{
      border-color:#dc3545;
      background-color:#fef2f2;
    }
    #studentModal .form-control.is-invalid:focus,
    #studentModal .form-select.is-invalid:focus{
      border-color:#dc3545;
      box-shadow:0 0 0 3px rgba(220,53,69,0.1);
    }
    #studentModal .modal-footer{
      padding:20px 32px;
      border-top:1px solid #e5e7eb;
      background:#f9fafb;
      border-radius:0 0 var(--border-radius-lg) var(--border-radius-lg);
      display:flex;
      justify-content:flex-end;
      gap:12px;
    }
    #studentModal .modal-footer .btn{
      border-radius:8px;
      font-weight:600;
      font-size:0.9375rem;
      padding:10px 24px;
      min-width:100px;
      transition:all 0.2s ease;
      border-width:1.5px;
    }
    #studentModal .modal-footer .btn-light{
      background:#fff !important;
      border-color:#d1d5db !important;
      color:#374151 !important;
    }
    #studentModal .modal-footer .btn-light:hover{
      background:#f9fafb !important;
      border-color:#9ca3af !important;
      color:#111827 !important;
      transform:translateY(-1px);
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    #studentModal .modal-footer .btn-primary{
      background:var(--brand-gold) !important;
      border-color:var(--brand-gold) !important;
      color:#fff !important;
      box-shadow:0 2px 4px rgba(166,134,4,0.2);
    }
    #studentModal .modal-footer .btn-primary:hover{
      background:var(--gold-dark) !important;
      border-color:var(--gold-dark) !important;
      color:#fff !important;
      transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(166,134,4,0.3);
    }
    #studentModal .modal-footer .btn:active{
      transform:translateY(0);
    }
    #studentModal .pw-wrap{
      position:relative;
      display:flex;
      align-items:center;
    }
    #studentModal .pw-wrap .form-control{
      padding-right:45px;
    }
    #studentModal .pw-toggle{
      position:absolute;
      right:10px;
      background:transparent;
      border:none;
      color:#6b7280;
      padding:4px 8px;
      cursor:pointer;
      border-radius:4px;
      transition:all 0.2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #studentModal .pw-toggle:hover{
      color:#374151;
      background:#f3f4f6;
    }
    #studentModal .field-error{
      color:#dc3545;
      font-size:0.8125rem;
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:4px;
    }

    /* Delete Confirmation Modal Styling */
    #confirmDeleteModal .modal-content{
      border-radius:var(--border-radius-lg);
      border:1px solid var(--ui-border);
      box-shadow:var(--shadow-lg);
    }
    #confirmDeleteModal .modal-body{
      padding:32px 24px !important;
    }
    .delete-warning-icon{
      width:64px;
      height:64px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#fee2e2;
      border-radius:50%;
    }
    .delete-warning-icon i{
      font-size:2rem;
      color:#dc3545;
    }
    #confirmDeleteModal .modal-title{
      font-size:1.25rem;
      color:#1f2937;
    }
    #confirmDeleteModal .btn-outline-secondary{
      border-color:#d1d5db;
      color:#374151;
    }
    #confirmDeleteModal .btn-outline-secondary:hover{
      background:#f3f4f6;
      border-color:#9ca3af;
    }

    /* Avatar Click Styling */
    .vu-avatar{
      position:relative;
    }
    .vu-avatar img:hover{
      opacity:0.9;
      transform:scale(1.05);
      transition:all 0.2s ease;
    }
    
    /* Success Modal - Matching Delete Success Modal */
    #successModal .modal-content{
      border-radius:var(--border-radius-lg);
      border:1px solid var(--ui-border);
      box-shadow:var(--shadow-lg);
    }
    #successModal .modal-body{
      padding:32px 24px !important;
    }
    #successModal .modal-body.py-4.px-5{
      padding:32px 24px !important;
    }
    .delete-success-icon{
      width:64px;
      height:64px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#d1fae5;
      border-radius:50%;
    }
    .delete-success-icon i{
      font-size:2rem;
      color:#10b981;
    }
    #successModal .modal-title{
      font-size:1.25rem;
      color:#1f2937;
      font-weight:700;
    }
    #successModal .btn-success{
      background:#10b981 !important;
      border-color:#10b981 !important;
      color:#fff !important;
      min-width:100px;
      font-weight:600;
      border-radius:8px;
      padding:10px 24px;
      transition:all 0.2s ease;
    }
    #successModal .btn-success:hover{
      background:#059669 !important;
      border-color:#059669 !important;
      transform:translateY(-1px);
      box-shadow:0 2px 4px rgba(16,185,129,0.3);
    }
    
    /* Avatar Preview Modal */
    #avatarPreviewModal .modal-content{
      background:rgba(0,0,0,0.95) !important;
      border:none !important;
    }
    #avatarPreviewModal .modal-body{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:0;
    }
    #avatarPreviewImage{
      max-width:90%;
      max-height:90vh;
      object-fit:contain;
      border-radius:8px;
      box-shadow:0 8px 32px rgba(255,255,255,0.1);
    }

    /* Force all dropdowns to open downward */
    #studentModal .form-select {
      position: relative;
    }
    #studentModal .form-select:focus {
      z-index: 1050;
    }
    /* Ensure select dropdowns open downward - prevent browser auto-flip */
    #studentModal select.form-select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-position: right 14px center;
    }
    /* Ensure modal body allows dropdowns to render */
    #studentModal .modal-body {
      overflow: visible !important;
    }
    #studentModal .modal-content {
      overflow: visible !important;
    }
    #studentModal .modal-dialog {
      overflow: visible !important;
      /* Ensure modal is positioned to allow dropdowns to open downward */
      margin: 2rem auto !important;
      max-height: calc(100vh - 4rem);
    }
    /* Ensure dropdown options appear below */
    #studentModal .form-select option {
      position: relative;
    }
    /* Specific styling for Course dropdown to ensure it opens downward */
    #fCourse {
      position: relative;
    }
    #fCourse:focus {
      z-index: 1051;
    }
    /* Adjust modal position to ensure dropdowns have space below */
    #studentModal.modal.show .modal-dialog {
      transform: none !important;
      margin: 2rem auto !important;
    }
  </style>
</head>
<body class="sb-body">
  <div id="sidebar-root"></div>

  <div class="sb-wrapper">
    <nav class="sb-topbar navbar navbar-expand sticky-top admin-header-gold">
      <div class="container-fluid">
        <button id="sidebarToggle" class="btn btn-link text-dark me-2" aria-label="Toggle sidebar">
          <i class="bi bi-list fs-4"></i>
        </button>
        <div class="fw-bold h5 mb-0" id="pageTitle">Add Students</div>

        <div class="ms-auto d-flex align-items-center gap-2">
          <form class="d-none d-md-flex" role="search" style="max-width:520px;width:100%;">
            <div class="input-group input-group-sm search-bar-custom">
              <span class="input-group-text bg-light border-0 search-icon-wrapper"><i class="bi bi-search"></i></span>
              <input class="form-control border-0 bg-light search-input-custom" type="search" placeholder="Search">
            </div>
          </form>

          <div class="dropdown">
            <button class="btn btn-light border btn-icon admin-btn-custom" data-bs-toggle="dropdown" id="userBtn" style="padding:0; width:44px; height:44px; border-radius:50%;">
              <img src="assets/img/default-avatar.png" alt="Profile" class="avatar-32" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li class="px-3 py-2 small text-muted" id="whoChip">—</li>
              <li><a class="dropdown-item" href="librarian-profile.html"><i class="bi bi-gear me-2"></i>Profile</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="container-fluid py-3">
      <section class="table-card card p-0 position-relative">
        <div class="card-header">
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="d-flex align-items-center gap-3">
              <span class="fw-semibold d-flex align-items-center gap-2">
                <i class="bi bi-people-fill"></i>
                <span>Students</span>
                <span class="count-pill" id="acctCount">0</span>
              </span>
              <span class="text-muted small" id="schoolChip">—</span>
            </div>

            <div class="d-flex align-items-center toolbar-44 flex-nowrap">
              <form role="search" class="me-2">
                <div class="input-group search-group search-wide">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="searchInput" class="form-control" type="search" placeholder="Search name, email, student no.…">
                </div>
              </form>

              <div class="dropdown me-2">
                <button class="btn btn-outline-secondary filter-btn" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-sliders"></i> Filters
                </button>
                <div class="dropdown-menu dropdown-menu-end filter-menu">
                  <div class="filter-title">Status</div>
                  <div class="filter-section" id="filterStatus">
                    <label class="filter-option"><input type="radio" name="status" value="" checked> All</label>
                    <label class="filter-option"><input type="radio" name="status" value="active"> Active</label>
                    <label class="filter-option"><input type="radio" name="status" value="disabled"> Disabled</label>
                  </div>
                </div>
              </div>

              <button id="btnShowDeleted" class="btn btn-outline-secondary filter-btn me-2" title="Show deleted accounts">
                <i class="bi bi-trash"></i> <span id="btnShowDeletedText">Deleted Accounts</span>
              </button>

              <button id="btnAdd" class="btn btn-dark d-flex align-items-center gap-2">
                <i class="bi bi-person-plus"></i> Add Student
              </button>
            </div>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-modern align-middle mb-0" id="usersTable">
              <thead>
                <tr>
                  <th class="th-tight"><input class="form-check-input" type="checkbox" id="checkAll"></th>
                  <th>Name</th>
                  <th class="col-id">ID / Student No.</th>
                  <th>Email</th>
                  <th class="d-none d-xl-table-cell">School</th>
                  <th>Course</th>
                  <th>Year</th>
                  <th>Section</th>
                  <th class="th-tight col-status">Status</th>
                  <th class="th-tight text-end col-actions">Actions</th>
                </tr>
              </thead>              
              <tbody id="usersBody"></tbody>
            </table>
          </div>
        </div>

        <div class="table-footer">
          <nav><ul class="pagination pagination-sm mb-0" id="pager"></ul></nav>
          <div class="page-info" id="pageInfo">Showing 0–0 of 0</div>
        </div>
      </section>
    </main>
  </div>

  <div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form id="studentForm" class="modal-content" novalidate>
        <div class="modal-header modal-header-dark">
          <h5 class="modal-title" id="studentModalTitle">Add Student</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <div class="name-grid">
                <div>
                  <label class="form-label">First Name</label>
                  <input id="fFirst" type="text" class="form-control" placeholder="First name" required>
                  <div class="field-error d-none" id="errFirst"></div>
                </div>
                <div>
                  <label class="form-label">Middle Name (optional)</label>
                  <input id="fMiddle" type="text" class="form-control" placeholder="Middle name">
                </div>
                <div>
                  <label class="form-label">Last Name</label>
                  <input id="fLast" type="text" class="form-control" placeholder="Last name" required>
                  <div class="field-error d-none" id="errLast"></div>
                </div>
                <div>
                  <label class="form-label">Suffix (optional)</label>
                  <select id="fSuffix" class="form-select" aria-label="Suffix">
                    <option value="">N/A</option>
                    <option>Jr.</option><option>Sr.</option>
                    <option>I</option><option>II</option><option>III</option><option>IV</option>
                    <option>V</option><option>VI</option><option>VII</option><option>VIII</option>
                    <option>IX</option><option>X</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-6" style="margin-top:24px;">
              <label class="form-label">Email</label>
              <input id="fEmail" type="email" class="form-control" placeholder="Enter email" required>
              <div class="field-error d-none" id="errEmail"></div>
            </div>

            <div class="col-12 col-md-6" style="margin-top:24px;">
              <label class="form-label">Status</label>
              <select id="fStatus" class="form-select" required>
                <option value="active">Active</option>
                <option value="disabled">Disabled</option>
              </select>
            </div>

            <div class="col-12 col-md-6" style="margin-top:24px;">
              <label class="form-label">Password</label>
              <div class="pw-wrap">
                <input id="fPassword" type="password" class="form-control" placeholder="Enter password">
                <button type="button" class="pw-toggle" id="pwToggle1" aria-label="Show password">
                  <i class="bi bi-eye" id="pwIcon1"></i>
                </button>
              </div>
              <div class="field-error d-none" id="errPassword"></div>
            </div>

            <div class="col-12 col-md-6" style="margin-top:24px;">
              <label class="form-label">Confirm Password</label>
              <div class="pw-wrap">
                <input id="fConfirm" type="password" class="form-control" placeholder="Re-enter password">
                <button type="button" class="pw-toggle" id="pwToggle2" aria-label="Show password">
                  <i class="bi bi-eye" id="pwIcon2"></i>
                </button>
              </div>
              <div class="field-error d-none" id="errConfirm"></div>
            </div>

            <div class="col-12 col-md-6" style="margin-top:24px;">
              <label class="form-label">School</label>
              <input id="fSchoolName" type="text" class="form-control" disabled placeholder="Loading school..." style="background-color: #e9ecef; color: #6c757d; cursor: not-allowed;">
              <div class="form-text-hint" id="schoolHint">Automatically assigned based on librarian's school</div>
            </div>

            <div class="col-12 col-md-6" style="margin-top:24px;">
              <label class="form-label">School ID / Student No.</label>
              <input id="fStudNo" type="text" class="form-control" required inputmode="numeric" pattern="\d{8}" maxlength="8" placeholder="8-digit ID">
              <div class="field-error d-none" id="errStudNo"></div>
            </div>

            <div class="col-12 col-md-4" style="margin-top:24px;">
              <label class="form-label">Course</label>
              <select id="fCourse" class="form-select" required>
                <option value="">Select Course</option>
                <option value="Bachelor of Science in Computer Science">Bachelor of Science in Computer Science</option>
                <option value="Bachelor of Science in Information Technology">Bachelor of Science in Information Technology</option>
                <option value="Bachelor of Science in Information Systems">Bachelor of Science in Information Systems</option>
                <option value="Bachelor of Science in Computer Engineering">Bachelor of Science in Computer Engineering</option>
                <option value="Bachelor of Science in Software Engineering">Bachelor of Science in Software Engineering</option>
                <option value="Bachelor of Science in Business Administration">Bachelor of Science in Business Administration</option>
                <option value="Bachelor of Science in Accountancy">Bachelor of Science in Accountancy</option>
                <option value="Bachelor of Science in Education">Bachelor of Science in Education</option>
                <option value="Bachelor of Arts in Psychology">Bachelor of Arts in Psychology</option>
                <option value="Bachelor of Science in Nursing">Bachelor of Science in Nursing</option>
                <option value="Bachelor of Science in Engineering">Bachelor of Science in Engineering</option>
                <option value="Bachelor of Science in Mathematics">Bachelor of Science in Mathematics</option>
              </select>
              <div class="field-error d-none" id="errCourse"></div>
            </div>
            <div class="col-6 col-md-4" style="margin-top:24px;">
              <label class="form-label">Year Level</label>
              <select id="fYear" class="form-select" required>
                <option value="">Select Year</option>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
                <option value="3rd">3rd</option>
                <option value="4th">4th</option>
              </select>
              <div class="field-error d-none" id="errYear"></div>
            </div>
            <div class="col-6 col-md-4" style="margin-top:24px;">
              <label class="form-label">Section</label>
              <select id="fSection" class="form-select" required>
                <option value="">Select Section</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="G">G</option>
                <option value="H">H</option>
              </select>
              <div class="field-error d-none" id="errSection"></div>
            </div>

            <div class="col-12 col-md-6" style="margin-top:24px;">
              <label class="form-label">Notes</label>
              <input id="fNotes" type="text" class="form-control" placeholder="Optional notes…">
            </div>

            <input id="fId" type="hidden">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button id="btnSaveStudent" class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content userview-2col">
        <div class="modal-header modal-header-dark">
          <h5 class="modal-title">Student Details</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="vu-head">
            <div class="vu-avatar">
              <img id="vuAvatar" src="assets/img/default-avatar.png" alt="Avatar" style="cursor:pointer;">
            </div>
            <div class="vu-id">
              <div class="vu-name" id="vuName">—</div>
              <div class="vu-email" id="vuEmail">—</div>
              <div class="vu-chips">
                <span class="chip chip-role student">Student</span>
                <span id="vuStatus" class="chip chip-status">—</span>
              </div>
            </div>
            <div class="vu-actions ms-auto">
              <button type="button" class="btn btn-outline-primary btn-sm" id="vuEdit"><i class="bi bi-pencil-square me-1"></i>Edit</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="vuDelete" style="border-color:#dc3545; color:#dc3545;"><i class="bi bi-trash-fill me-1"></i>Delete</button>
            </div>
          </div>

          <div class="vu-sheet mt-3">
            <div class="vu-row vu-headrow">
              <div class="vu-col vu-field"><i class="bi bi-info-circle me-2"></i> Field</div>
              <div class="vu-col vu-value"><i class="bi bi-clipboard-check me-2"></i> Details</div>
            </div>

            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-person-fill"></i> Full Name</div><div class="vu-col vu-value" id="vFullName">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-envelope-fill"></i> Email</div><div class="vu-col vu-value" id="vEmail">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-building"></i> School</div><div class="vu-col vu-value" id="vSchool">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-person-vcard-fill"></i> Student No.</div><div class="vu-col vu-value" id="vStudNo">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-mortarboard-fill"></i> Course</div><div class="vu-col vu-value" id="vCourse">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-calendar3"></i> Year</div><div class="vu-col vu-value" id="vYear">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-people-fill"></i> Section</div><div class="vu-col vu-value" id="vSection">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-clock-fill"></i> Status</div><div class="vu-col vu-value" id="vStatus">—</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-book"></i> Borrowed</div><div class="vu-col vu-value" id="vBorrowed">0</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-exclamation-triangle"></i> Overdue</div><div class="vu-col vu-value" id="vOverdue">0</div></div>
            <div class="vu-row"><div class="vu-col vu-field"><i class="bi bi-card-text"></i> Notes</div><div class="vu-col vu-value" id="vNotes">—</div></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">Back to list</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-body py-4 px-5">
          <div class="delete-warning-icon mb-3">
            <i class="bi bi-exclamation-circle-fill"></i>
          </div>
          <h5 class="modal-title mb-2 fw-bold" id="delTitle">Delete User</h5>
          <p class="text-muted mb-2" id="delMessage">You're going to delete this user.</p>
          <p class="text-muted small mb-4" style="font-size:0.875rem; color:#6b7280;">The account will be deactivated now and automatically removed after 30 days.</p>
          <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal" style="min-width: 100px;">No</button>
            <button class="btn btn-danger" id="confirmDeleteBtn" style="min-width: 100px;">Yes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Avatar Preview Modal -->
  <div class="modal fade" id="avatarPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen">
      <div class="modal-content" style="background:rgba(0,0,0,0.95); border:none;">
        <div class="modal-header border-0" style="position:absolute; top:20px; right:20px; z-index:1060; background:transparent;">
          <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal" aria-label="Close" style="filter:invert(1); opacity:0.8;"></button>
        </div>
        <div class="modal-body d-flex align-items-center justify-content-center" style="min-height:100vh; padding:0;">
          <img id="avatarPreviewImage" src="" alt="Profile Picture" style="max-width:90%; max-height:90vh; object-fit:contain; border-radius:8px; box-shadow:0 8px 32px rgba(255,255,255,0.1);">
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-body py-4 px-5">
          <div class="delete-success-icon mb-3">
            <i class="bi bi-check-circle-fill"></i>
          </div>
          <h5 class="modal-title mb-2 fw-bold" id="succTitle">Success!</h5>
          <p class="text-muted mb-4" id="succBody" style="font-size:0.9375rem; color:#6b7280;">Student account has been created successfully!</p>
          <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-success" data-bs-dismiss="modal" style="min-width: 100px;">OK</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/logout.js"></script>
  <script src="assets/js/sidebar.js?v=2025-11-17-restructured"></script>

  <script>
    async function getJson(url, opts = {}) {
      const res = await fetch(url, { credentials: 'include', ...opts });
      const text = await res.text();
      if (!text || text.trim() === '') throw new Error(`Empty response from server (${res.status} ${res.statusText})`);
      let data; try { data = JSON.parse(text); } catch { throw new Error(`Invalid JSON response: ${text.slice(0,200)}`); }
      if (!res.ok || data?.success === false) { const err = new Error(data?.error || data?.message || `HTTP ${res.status}`); err.field = data?.field; throw err; }
      return data;
    }

    async function getMe() {
      try { const data = await getJson('/api/check-auth'); return data.user; }
      catch { location.href = 'login.html'; return null; }
    }

    let me = null, schoolId = null, schoolName = "";
    let students = []; const pageSize = 10; let currentPage = 1;

    const tbody = document.getElementById('usersBody');
    const pager = document.getElementById('pager');
    const pageInfo = document.getElementById('pageInfo');
    const acctCount = document.getElementById('acctCount');
    const search = document.getElementById('searchInput');
    const btnAdd = document.getElementById('btnAdd');
    const checkAll = document.getElementById('checkAll');
    const btnShowDeleted = document.getElementById('btnShowDeleted');
    const btnShowDeletedText = document.getElementById('btnShowDeletedText');
    let showDeleted = false;
    let statusFilter = '';

    const studentModalEl = document.getElementById('studentModal');
    const viewModalEl = document.getElementById('viewModal');
    const confirmEl = document.getElementById('confirmDeleteModal');
    const successEl = document.getElementById('successModal');

    const studentModal = new bootstrap.Modal(studentModalEl);
    const viewModal    = new bootstrap.Modal(viewModalEl);
    const confirmModal = new bootstrap.Modal(confirmEl);
    const successModal = new bootstrap.Modal(successEl);
    
    // Ensure Course dropdown opens downward by adjusting modal position
    studentModalEl.addEventListener('shown.bs.modal', function() {
      const modalDialog = studentModalEl.querySelector('.modal-dialog');
      if (modalDialog) {
        modalDialog.style.transform = 'none';
        modalDialog.style.margin = '2rem auto';
      }
    });
    
    // Force Course dropdown to open downward when focused
    const courseSelect = document.getElementById('fCourse');
    if (courseSelect) {
      courseSelect.addEventListener('mousedown', function(e) {
        // Temporarily move select to ensure dropdown opens downward
        const rect = this.getBoundingClientRect();
        const spaceBelow = window.innerHeight - rect.bottom;
        const spaceAbove = rect.top;
        
        // If there's more space above than below, scroll modal up slightly
        if (spaceAbove > spaceBelow && spaceBelow < 300) {
          const modalBody = studentModalEl.querySelector('.modal-body');
          if (modalBody) {
            modalBody.scrollTop = Math.max(0, modalBody.scrollTop - 100);
          }
        }
      });
    }

    const succTitle = document.getElementById('succTitle');
    const succBody  = document.getElementById('succBody');
    function showSuccess(title, message){
      const titleText = title || 'Success';
      const messageText = message || 'Operation completed successfully.';
      succTitle.textContent = titleText.endsWith('!') ? titleText : titleText + '!';
      succBody.textContent  = messageText.endsWith('!') ? messageText : messageText.replace(/\.$/, '') + '!';
      successModal.show();
    }

    const studentForm  = document.getElementById('studentForm');
    const studentModalTitle = document.getElementById('studentModalTitle');

    const fId = document.getElementById('fId');
    const fFirst = document.getElementById('fFirst');
    const fMiddle = document.getElementById('fMiddle');
    const fLast = document.getElementById('fLast');
    const fSuffix = document.getElementById('fSuffix');
    const fEmail = document.getElementById('fEmail');
    const fStatus = document.getElementById('fStatus');
    const fStudNo = document.getElementById('fStudNo');
    const fCourse = document.getElementById('fCourse');
    const fYear = document.getElementById('fYear');
    const fSection = document.getElementById('fSection');
    const fPassword = document.getElementById('fPassword');
    const fConfirm = document.getElementById('fConfirm');
    const fNotes = document.getElementById('fNotes');
    const fSchoolName = document.getElementById('fSchoolName');

    const errFirst = document.getElementById('errFirst');
    const errLast  = document.getElementById('errLast');
    const errEmail = document.getElementById('errEmail');
    const errStudNo= document.getElementById('errStudNo');
    const errCourse= document.getElementById('errCourse');
    const errYear  = document.getElementById('errYear');
    const errSection=document.getElementById('errSection');
    const errPassword = document.getElementById('errPassword');
    const errConfirm  = document.getElementById('errConfirm');

    function setupPwToggle(inputEl, btnId, iconId){
      const btn  = document.getElementById(btnId);
      const icon = document.getElementById(iconId);
      if(!inputEl || !btn || !icon) return;
      btn.addEventListener('click', () => {
        const showing = inputEl.type === 'text';
        inputEl.type = showing ? 'password' : 'text';
        icon.classList.toggle('bi-eye',  showing);
        icon.classList.toggle('bi-eye-slash', !showing);
        btn.setAttribute('aria-label', showing ? 'Show password' : 'Hide password');
      });
    }
    setupPwToggle(fPassword, 'pwToggle1', 'pwIcon1');
    setupPwToggle(fConfirm,  'pwToggle2', 'pwIcon2');

    const vuName   = document.getElementById('vuName');
    const vuEmail  = document.getElementById('vuEmail');
    const vuAvatar = document.getElementById('vuAvatar');
    const vuStatusChip = document.getElementById('vuStatus');
    const vFullName= document.getElementById('vFullName');
    const vEmail   = document.getElementById('vEmail');
    const vSchool  = document.getElementById('vSchool');
    const vStudNo  = document.getElementById('vStudNo');
    const vCourse  = document.getElementById('vCourse');
    const vYear    = document.getElementById('vYear');
    const vSection = document.getElementById('vSection');
    const vStatus  = document.getElementById('vStatus');
    const vBorrowed= document.getElementById('vBorrowed');
    const vOverdue = document.getElementById('vOverdue');
    const vNotes   = document.getElementById('vNotes');
    const vuEdit   = document.getElementById('vuEdit');
    const vuDelete = document.getElementById('vuDelete');

    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let deleteId = null;

    function renderSidebarAndHeader() {
      renderSidebar('users', me.role, false);
      document.getElementById('sidebarToggle')?.addEventListener('click', () => {
        if (typeof toggleSidebar === 'function') toggleSidebar();
        else document.body.classList.toggle('sb-collapsed');
      });
      const displayName =
        me.full_name ||
        [me.first_name, me.middle_name, me.last_name].filter(Boolean).join(' ') ||
        me.name || me.email || 'Account';
      const whoChipEl = document.getElementById('whoChip');
      if (whoChipEl) {
        const role = (me.role || '').toLowerCase();
        whoChipEl.innerHTML = `<span class="badge role-chip ${role}">${role.toUpperCase()}</span> ${displayName}`;
      }
      // Load avatar in header if available
      const headerAvatar = document.querySelector('#userBtn img.avatar-32');
      if (headerAvatar && me.avatar && me.avatar.trim() !== '') {
        headerAvatar.src = me.avatar;
      }
      document.getElementById('schoolChip').textContent = 'School: ' + (schoolName || '—');
      fSchoolName.value = schoolName || '';
    }

    function fullName(u){
      const parts = [u.first_name, u.middle_name, u.last_name].map(v => (v||'').trim()).filter(Boolean);
      const base = parts.join(' ');
      return base + (u.suffix ? ', ' + u.suffix : '');
    }
    const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    function comboCYS(u){ const a=[u.course,u.year_level,u.section].map(v=>(v||'').trim()).filter(Boolean); return a.length?a.join(' / '):'—'; }
    function statusBadge(u){ const active=(u.status||'').toLowerCase()==='active'; return active?'<span class="badge text-bg-success-soft">Active</span>':'<span class="badge text-bg-danger-soft">Disabled</span>'; }

    function rowHtml(u){
  return `
    <tr class="fade-in">
      <td><input class="form-check-input row-check" type="checkbox" value="${u.id}"></td>

      <!-- Name (no ID pill here anymore) -->
      <td>
        <div class="d-flex align-items-center gap-2">
          <img class="avatar" src="assets/img/default-avatar.png" alt="">
          <div class="fw-semibold">${escapeHtml(fullName(u))}</div>
        </div>
      </td>

      <!-- ID / Student No. -->
      <td class="col-id">${escapeHtml(u.student_no || '—')}</td>

      <!-- Email -->
      <td>${escapeHtml(u.email || '')}</td>

      <!-- School -->
      <td class="d-none d-xl-table-cell">${escapeHtml(u.school_name || schoolName || '—')}</td>

      <!-- Course -->
      <td>${escapeHtml((u.course || '').trim() || '—')}</td>

      <!-- Year -->
      <td>${escapeHtml((u.year_level || '').trim() || '—')}</td>

      <!-- Section -->
      <td>${escapeHtml((u.section || '').trim() || '—')}</td>

      <!-- Status -->
      <td class="col-status">${statusBadge(u)}</td>

      <!-- Actions -->
      <td class="text-end col-actions">
        <div class="d-flex align-items-center justify-content-end gap-1">
          <button class="btn btn-sm action-btn action-view" data-action="view" data-id="${u.id}" title="View profile" aria-label="View profile">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-sm action-btn action-edit" data-action="edit" data-id="${u.id}" title="Edit details" aria-label="Edit details">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button class="btn btn-sm action-btn action-delete" data-action="delete" data-id="${u.id}" title="Delete user" aria-label="Delete user">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </td>
    </tr>`;
}

    function buildPager(total){
      const pages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > pages) currentPage = pages;
      pager.innerHTML = '';
      const add=(label,page,disabled=false,active=false)=>{
        const li=document.createElement('li');
        li.className=`page-item ${disabled?'disabled':''} ${active?'active':''}`;
        li.innerHTML=`<a class="page-link" href="#">${label}</a>`;
        li.onclick=e=>{e.preventDefault(); if(!disabled){ currentPage=page; render(); }};
        pager.appendChild(li);
      };
      add('‹', Math.max(1,currentPage-1), currentPage===1);
      for(let p=1;p<=pages;p++) add(p,p,false,p===currentPage);
      add('›', Math.min(pages,currentPage+1), currentPage===pages);
    }

    function applyFilters(){
      const q=(search?.value||'').toLowerCase().trim();
      return students.filter(u => {
        const matchesSearch = (fullName(u)+' '+(u.email||'')+' '+(u.student_no||'')+' '+comboCYS(u)).toLowerCase().includes(q);
        const matchesStatus = !statusFilter || (u.status||'').toLowerCase() === statusFilter.toLowerCase();
        const matchesDeleted = showDeleted ? (u.deleted_at !== null && u.deleted_at !== undefined) : (!u.deleted_at || u.deleted_at === null);
        return matchesSearch && matchesStatus && matchesDeleted;
      });
    }

    function render(){
      const list = applyFilters();
      const total = list.length;
      const start = (currentPage - 1) * pageSize;
      const end   = Math.min(start + pageSize, total);

      acctCount.textContent = String(students.length);
      tbody.innerHTML = total ? list.slice(start, end).map(u => {
        const html = rowHtml(u);
        return html.replace('<tr>', '<tr class="fade-in">');
      }).join('') : `<tr class="empty-row fade-in"><td colspan="10">No students found.</td></tr>`;
      pageInfo.textContent = total ? `Showing ${start+1}–${end} of ${total}` : '—';
      buildPager(total);

      Array.prototype.forEach.call(tbody.querySelectorAll('.action-btn'), function(btn){
        const id = Number(btn.dataset.id);
        const action = btn.dataset.action;
        btn.onclick = function(){
          if (action==='view') return viewStudent(id);
          if (action==='edit') return editStudent(id);
          if (action==='delete') return askDelete(id);
        };
      });
    }

    // Render skeleton table rows
    function renderSkeletonTableRows(count = 8) {
      return Array.from({length: count}, () => `
        <tr class="skeleton-table-row">
          <td><div class="skeleton-checkbox"></div></td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <div class="skeleton-avatar"></div>
              <div class="skeleton-table-cell medium"></div>
            </div>
          </td>
          <td class="col-id"><div class="skeleton-table-cell short"></div></td>
          <td><div class="skeleton-table-cell medium"></div></td>
          <td class="d-none d-xl-table-cell"><div class="skeleton-table-cell medium"></div></td>
          <td><div class="skeleton-table-cell long"></div></td>
          <td><div class="skeleton-table-cell short"></div></td>
          <td><div class="skeleton-table-cell short"></div></td>
          <td class="col-status"><div class="skeleton-badge"></div></td>
          <td class="text-end col-actions">
            <div class="d-flex align-items-center justify-content-end gap-1">
              <div class="skeleton-button"></div>
              <div class="skeleton-button"></div>
              <div class="skeleton-button"></div>
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function loadStudents(){
      // Show skeleton loaders while fetching
      tbody.innerHTML = renderSkeletonTableRows(8);
      
      try{
        const data = await getJson('/api/users?role=student');
        students = (data.students || []).map(s => ({
          id:Number(s.id), first_name:s.first_name, middle_name:s.middle_name, last_name:s.last_name,
          suffix:s.suffix, email:s.email, student_no:s.student_no, course:s.course, year_level:s.year_level,
          section:s.section, status:s.status||'active', notes:s.notes||'',
          school_id:s.school_id ? Number(s.school_id) : schoolId, school_name:s.school_name || schoolName
        }));
        if (data.school_id) schoolId = data.school_id;
        if (students.length && students[0].school_name) {
          schoolName = students[0].school_name;
          document.getElementById('schoolChip').textContent = 'School: ' + schoolName;
          fSchoolName.value = schoolName;
        }
        currentPage = 1; render();
      }catch(err){
        console.error(err); students = []; render();
        alert(err.message || 'Network error while loading students.');
      }
    }

    const validEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v||'');
    
    // Password validation: min 8 chars, 1 uppercase, 1 lowercase, 1 number
    const strongEnough = (pw, email, studentNo) => {
      if (!pw || pw.length < 8) return false;
      if (!/[A-Z]/.test(pw)) return false; // At least 1 uppercase
      if (!/[a-z]/.test(pw)) return false; // At least 1 lowercase
      if (!/[0-9]/.test(pw)) return false; // At least 1 number
      // Must NOT be identical to email or student ID
      if (email && pw.toLowerCase() === email.toLowerCase()) return false;
      if (studentNo && pw === studentNo) return false;
      return true;
    };
    
    // Name validation: letters, spaces, hyphen, apostrophe; 2-50 chars
    const validName = (name) => {
      if (!name || name.trim().length < 2 || name.trim().length > 50) return false;
      return /^[a-zA-Z\s\-']+$/.test(name.trim());
    };
    
    // Allowed suffix values
    const allowedSuffixes = ['', 'N/A', 'Jr.', 'Sr.', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'];
    const validSuffix = (suffix) => {
      return allowedSuffixes.includes(suffix || '');
    };
    
    // Valid status values
    const validStatus = (status) => {
      return ['active', 'disabled', 'inactive'].includes((status || '').toLowerCase());
    };

    function clearErr(i,e){ i?.classList.remove('is-invalid'); if(e){ e.textContent=''; e.classList.add('d-none'); } }
    function setErr(i,e,msg){ i?.classList.add('is-invalid'); if(e){ e.textContent=msg; e.classList.remove('d-none'); } }
    function beginLoading(btn){ btn.classList.add('btn-loading'); btn.disabled=true; btn.insertAdjacentHTML('beforeend',' <span class="spinner-border" role="status" aria-hidden="true"></span>'); }
    function endLoading(btn){ btn.classList.remove('btn-loading'); btn.disabled=false; btn.querySelector('.spinner-border')?.remove(); }

    function viewStudent(id){
      const u = students.find(x=>x.id===id); if(!u) return;
      const name = fullName(u);
      const email = u.email || '—';
      const status = (u.status||'active').toLowerCase();
      
      // Profile section
      vuName.textContent = name;
      vuEmail.textContent = email;
      if (vuAvatar) {
        vuAvatar.src = u.avatar && u.avatar.trim() !== '' ? u.avatar : 'assets/img/default-avatar.png';
        
        // Setup avatar click handler to show full-screen preview
        vuAvatar.onclick = () => {
          const previewImage = document.getElementById('avatarPreviewImage');
          const avatarModal = new bootstrap.Modal(document.getElementById('avatarPreviewModal'));
          if (previewImage) {
            previewImage.src = vuAvatar.src;
            avatarModal.show();
          }
        };
      }
      if (vuStatusChip) {
        vuStatusChip.textContent = status === 'active' ? 'Active' : 'Disabled';
        vuStatusChip.className = 'chip chip-status' + (status === 'active' ? '' : ' disabled');
      }
      
      // Details section
      vFullName.textContent = name;
      vEmail.textContent = email;
      vSchool.textContent = u.school_name || schoolName || '—';
      vStudNo.textContent = u.student_no || '—';
      vCourse.textContent = (u.course || '').trim() || '—';
      vYear.textContent = (u.year_level || '').trim() || '—';
      vSection.textContent = (u.section || '').trim() || '—';
      vStatus.textContent = status === 'active' ? 'Active' : 'Disabled';
      vBorrowed.textContent = '0'; // TODO: Get actual borrowed count
      vOverdue.textContent = '0'; // TODO: Get actual overdue count
      vNotes.textContent = (u.notes || '').trim() || '—';
      
      vuEdit.onclick = () => { viewModal.hide(); editStudent(u.id); };
      vuDelete.onclick = () => { viewModal.hide(); askDelete(u.id); };
      viewModal.show();
    }

    function openCreate(){
      studentModalTitle.textContent = 'Add Student';
      studentForm.reset();
      fId.value = ''; fStatus.value = 'active'; fSchoolName.value = schoolName || '';
      fCourse.value=''; fYear.value=''; fSection.value='';
      [[fFirst,errFirst],[fLast,errLast],[fEmail,errEmail],[fStudNo,errStudNo],[fCourse,errCourse],[fYear,errYear],[fSection,errSection],[fPassword,errPassword],[fConfirm,errConfirm]]
        .forEach(([i,e])=>clearErr(i,e));
      studentModal.show();
    }

    function editStudent(id){
      const u = students.find(x=>x.id===id); if(!u) return;
      studentModalTitle.textContent = 'Edit Student';
      fId.value=String(u.id); fFirst.value=u.first_name||''; fMiddle.value=u.middle_name||''; fLast.value=u.last_name||'';
      fSuffix.value=u.suffix||''; fEmail.value=u.email||''; fStatus.value=u.status||'active'; fStudNo.value=u.student_no||'';
      fCourse.value=u.course||''; fYear.value=u.year_level||''; fSection.value=u.section||''; fNotes.value=u.notes||'';
      fSchoolName.value=u.school_name||schoolName||''; fPassword.value=''; fConfirm.value='';
      [[fFirst,errFirst],[fLast,errLast],[fEmail,errEmail],[fStudNo,errStudNo],[fCourse,errCourse],[fYear,errYear],[fSection,errSection],[fPassword,errPassword],[fConfirm,errConfirm]]
        .forEach(([i,e])=>clearErr(i,e));
      studentModal.show();
    }

    fStudNo.addEventListener('input', () => {
      fStudNo.value = (fStudNo.value || '').replace(/\D/g, '').slice(0, 8);
      if (fStudNo.value.length > 0 && fStudNo.value.length < 8) {
        setErr(fStudNo, errStudNo, 'Student number must be exactly 8 digits.');
      } else {
        clearErr(fStudNo, errStudNo);
      }
    });

    studentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      // Clear all errors
      [[fFirst,errFirst],[fMiddle],[fLast,errLast],[fSuffix],[fEmail,errEmail],[fStatus],[fStudNo,errStudNo],[fCourse,errCourse],[fYear,errYear],[fSection,errSection],[fPassword,errPassword],[fConfirm,errConfirm]]
        .forEach(([i,e])=>clearErr(i,e));

      let ok = true;
      const isCreate = !(fId.value||'').trim();
      
      // 🧍 Personal Info Validation
      const firstName = (fFirst.value||'').trim();
      if(!firstName){
        setErr(fFirst,errFirst,'First name is required.');
        ok=false;
      } else if(!validName(firstName)){
        setErr(fFirst,errFirst,'First name must be 2-50 characters and contain only letters, spaces, hyphens, or apostrophes.');
        ok=false;
      }
      
      const middleName = (fMiddle.value||'').trim();
      if(middleName && !validName(middleName)){
        // Middle name is optional, but if provided, it must be valid
        // We'll show error on first name field since there's no errMiddle
        setErr(fMiddle,errFirst,'Middle name must be 2-50 characters and contain only letters, spaces, hyphens, or apostrophes.');
        ok=false;
      }
      
      const lastName = (fLast.value||'').trim();
      if(!lastName){
        setErr(fLast,errLast,'Last name is required.');
        ok=false;
      } else if(!validName(lastName)){
        setErr(fLast,errLast,'Last name must be 2-50 characters and contain only letters, spaces, hyphens, or apostrophes.');
        ok=false;
      }
      
      const suffix = (fSuffix.value||'').trim();
      if(suffix && !validSuffix(suffix)){
        // Suffix validation error - no dedicated error field, so we'll skip showing it
        // The backend will catch this anyway
        ok=false;
      }
      
      // 📧 Account & Status Validation
      const email = (fEmail.value||'').trim().toLowerCase();
      if(!email){
        setErr(fEmail,errEmail,'Email is required.');
        ok=false;
      } else if(!validEmail(email)){
        setErr(fEmail,errEmail,'Enter a valid email address.');
        ok=false;
      }
      
      const status = (fStatus.value||'').trim();
      if(!status || !validStatus(status)){
        // Status validation error - no dedicated error field, backend will catch this
        ok=false;
      }
      
      const pw = fPassword.value || '';
      const cf = fConfirm.value || '';
      
      // Password validation rules:
      // - CREATE: Password is required
      // - EDIT: Password is optional (only validate if admin wants to reset it)
      if (isCreate) {
        // Create mode: Password is required
        if(!pw){
          setErr(fPassword,errPassword,'Password is required.');
          ok=false;
        }
        if(!cf){
          setErr(fConfirm,errConfirm,'Please confirm the password.');
          ok=false;
        }
      } else {
        // Edit mode: Password is optional, but if filled, confirm password is required
        if (pw && !cf) {
          setErr(fConfirm,errConfirm,'Please confirm the password.');
          ok=false;
        }
      }
      
      // If password is provided (create or edit), validate it
      if (pw) {
        const sn = (fStudNo.value||'').trim();
        if(!strongEnough(pw, email, sn)){
          setErr(fPassword,errPassword,'Password must be at least 8 characters with 1 uppercase, 1 lowercase, and 1 number. It cannot be the same as your email or student ID.');
          ok=false;
        }
        if(pw !== cf){
          setErr(fConfirm,errConfirm,'Passwords do not match.');
          ok=false;
        }
      }
      
      // 🏫 Academic Info Validation
      // School is automatically assigned (read-only), so we skip validation
      
      const sn = (fStudNo.value||'').trim();
      if(!sn){
        setErr(fStudNo,errStudNo,'School ID / Student No. is required.');
        ok=false;
      } else if(!/^\d{8}$/.test(sn)){
        setErr(fStudNo,errStudNo,'Student number must be exactly 8 digits.');
        ok=false;
      }
      
      const course = (fCourse.value||'').trim();
      if(!course){
        setErr(fCourse,errCourse,'Course is required.');
        ok=false;
      }
      
      const year = (fYear.value||'').trim();
      if(!year){
        setErr(fYear,errYear,'Year level is required.');
        ok=false;
      }
      
      const section = (fSection.value||'').trim();
      if(!section){
        setErr(fSection,errSection,'Section is required.');
        ok=false;
      }
      
      if(!ok) return;

      const model = {
        id: (fId.value||'').trim()? Number(fId.value): undefined,
        first_name:(fFirst.value||'').trim(), middle_name:(fMiddle.value||'').trim(),
        last_name:(fLast.value||'').trim(), suffix:(fSuffix.value||'').trim(),
        email:(fEmail.value||'').trim(), status:fStatus.value,
        student_no: sn, course:(fCourse.value||'').trim(),
        year_level:(fYear.value||'').trim(), section:(fSection.value||'').trim(),
        notes:(fNotes.value||'').trim()
      };
      if(pw) model.password = pw;

      const submitBtn = document.getElementById('btnSaveStudent');
      try{
        beginLoading(submitBtn);
        const url = isCreate ? '/api/users/students' : `/api/users/${fId.value}`;
        const method = isCreate ? 'POST' : 'PUT';
        await getJson(url, { method: method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(model) });
        await loadStudents();
        studentModalEl.addEventListener('hidden.bs.modal', () => {
          if (isCreate) showSuccess('Student Added','The student account has been created successfully.');
          else showSuccess('Student Updated','The student account has been updated successfully.');
        }, { once:true });
        studentModal.hide();
        studentForm.reset();
      }catch(err){
        const msg = err.message || 'Network/Server error. Please try again.';
        if (err.field === 'email') setErr(fEmail, errEmail, msg);
        else if (err.field === 'student_no') setErr(fStudNo, errStudNo, msg);
        else if (/email/i.test(msg)) setErr(fEmail, errEmail, msg);
        else if (/student/i.test(msg)) setErr(fStudNo, errStudNo, msg);
        else setErr(fPassword, errPassword, msg);
      }finally{
        endLoading(submitBtn);
      }
    });

    function askDelete(id){
      const u = students.find(x=>x.id===id); if(!u) return;
      deleteId = id;
      const userName = fullName(u) || '(no name)';
      document.getElementById('delTitle').textContent = 'Delete User';
      document.getElementById('delMessage').textContent = 'You\'re going to delete "' + userName + '".';
      confirmModal.show();
    }

    async function performDelete(){
      if(!deleteId) return;
      try{
        await getJson(`/api/users/${deleteId}`, {
          method:'DELETE', headers:{'Content-Type':'application/json'}
        });
        students = students.filter(u => u.id !== deleteId); render(); confirmModal.hide();
      }catch(err){ alert('Network/Server error while deleting: ' + (err?.message || err)); }
      finally{ deleteId = null; }
    }
    confirmDeleteBtn.addEventListener('click', performDelete);

    successEl.addEventListener('shown.bs.modal', () => {
      document.querySelectorAll('.modal-backdrop:not(.show)').forEach(el => el.remove());
    }, { once:true });

    (async () => {
      me = await getMe(); if(!me) return;
      if (me.role !== 'librarian') { location.href='dashboard.html'; return; }
      schoolId = me.school_id ? Number(me.school_id) : null;
      schoolName = me.school_name || '';
      fSchoolName.value = schoolName || '';
      // Update hint text if school name is available
      const schoolHint = document.getElementById('schoolHint');
      if (schoolHint) {
        if (schoolName) {
          schoolHint.textContent = 'School assigned to your librarian account';
        } else {
          schoolHint.textContent = 'No school assigned. Please contact administrator.';
        }
      }
      renderSidebarAndHeader();

      const attachBtn = () => {
        const btn = document.getElementById('btnAdd');
        if (!btn) return false;
        const clone = btn.cloneNode(true);
        btn.parentNode.replaceChild(clone, btn);
        clone.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openCreate(); });
        return true;
      };
      if (!attachBtn()) setTimeout(attachBtn, 200);

      // Connect header search bar
      const headerSearch = document.querySelector('.search-input-custom');
      if (headerSearch && search) {
        headerSearch.addEventListener('input', () => {
          search.value = headerSearch.value;
          currentPage = 1;
          render();
        });
      }
      if (search) {
        search.addEventListener('input', () => {
          if (headerSearch) headerSearch.value = search.value;
          currentPage = 1;
          render();
        });
      }

      // Filter status
      document.querySelectorAll('#filterStatus input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', () => {
          statusFilter = radio.value;
          currentPage = 1;
          render();
        });
      });

      // Show deleted toggle
      if (btnShowDeleted) {
        btnShowDeleted.addEventListener('click', () => {
          showDeleted = !showDeleted;
          btnShowDeleted.classList.toggle('active', showDeleted);
          if (btnShowDeletedText) {
            btnShowDeletedText.textContent = showDeleted ? 'Active Accounts' : 'Deleted Accounts';
          }
          currentPage = 1;
          render();
        });
      }

      checkAll.addEventListener('change', () => {
        document.querySelectorAll('.row-check').forEach(cb => cb.checked = checkAll.checked);
      });

      await loadStudents();
    })();
  </script>
</body>
</html>
