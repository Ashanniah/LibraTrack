<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack – Librarian · Students</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/sidebar.css" rel="stylesheet">
  <link href="assets/css/admin-users.css" rel="stylesheet">
  <link href="assets/css/librarian-students.css" rel="stylesheet">
  <link rel="icon" href="assets/img/LibraTrack-logo.png">
</head>
<body class="sb-body">
  <div id="sidebar-root"></div>

  <div class="sb-wrapper">
    <nav class="sb-topbar navbar navbar-expand bg-white sticky-top">
      <div class="container-fluid">
        <button id="sidebarToggle" class="btn btn-link text-dark me-2" aria-label="Toggle sidebar">
          <i class="bi bi-list fs-4"></i>
        </button>
        <div class="fw-bold h5 mb-0">Add Students</div>
        <div class="ms-auto d-flex align-items-center gap-2">
          <div class="dropdown">
            <button class="btn btn-light border" data-bs-toggle="dropdown" aria-expanded="false" id="profileBtn">
              <i class="bi bi-person-circle me-1"></i><span id="profileName">Account</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><h6 class="dropdown-header" id="profileHeader">Signed in</h6></li>
              <li><a class="dropdown-item" href="admin-profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
              <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear me-2"></i>Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="backend/logout.php"><i class="bi bi-box-arrow-right me-2"></i>Sign out</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="container-fluid py-3">
      <section class="table-card card p-0 position-relative">
        <div class="card-header">
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="d-flex align-items-center gap-3">
              <span class="fw-semibold d-flex align-items-center gap-2">
                <i class="bi bi-people-fill"></i>
                <span>Students</span>
                <span class="count-pill" id="acctCount">0</span>
              </span>
              <span class="text-muted small" id="schoolChip">—</span>
            </div>
            <div class="d-flex align-items-center toolbar-44 flex-nowrap">
              <form role="search" class="me-2">
                <div class="input-group search-group" style="width:460px;max-width:48vw">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input id="searchInput" class="form-control" type="search" placeholder="Search name, email, student no.…">
                </div>
              </form>
              <button id="btnAdd" class="btn btn-dark d-flex align-items-center gap-2">
                <i class="bi bi-person-plus"></i> Add Student
              </button>
            </div>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-modern align-middle mb-0" id="usersTable">
              <thead>
                <tr>
                  <th class="th-tight"><input class="form-check-input" type="checkbox" id="checkAll"></th>
                  <th>Name</th>
                  <th class="col-id">ID / Student No.</th>
                  <th>Email</th>
                  <th class="d-none d-xl-table-cell">School</th>
                  <th>Course</th>
                  <th>Year</th>
                  <th>Section</th>
                  <th class="th-tight col-status">Status</th>
                  <th class="th-tight text-end col-actions">Actions</th>
                </tr>
              </thead>              
              <tbody id="usersBody"></tbody>
            </table>
          </div>
        </div>

        <div class="table-footer">
          <nav><ul class="pagination pagination-sm mb-0" id="pager"></ul></nav>
          <div class="page-info" id="pageInfo">Showing 0–0 of 0</div>
        </div>
      </section>
    </main>
  </div>

  <div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form id="studentForm" class="modal-content" novalidate>
        <div class="modal-header modal-header-dark">
          <h5 class="modal-title" id="studentModalTitle">Add Student</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label mb-1">Name</label>
              <div class="name-grid">
                <div>
                  <input id="fFirst" type="text" class="form-control" placeholder="First name" required>
                  <div class="field-error d-none" id="errFirst"></div>
                </div>
                <div>
                  <input id="fMiddle" type="text" class="form-control" placeholder="Middle name">
                  <div class="form-text-hint">Optional</div>
                </div>
                <div>
                  <input id="fLast" type="text" class="form-control" placeholder="Last name" required>
                  <div class="field-error d-none" id="errLast"></div>
                </div>
                <div>
                  <select id="fSuffix" class="form-select" aria-label="Suffix">
                    <option value="">N/A</option>
                    <option>Jr.</option><option>Sr.</option>
                    <option>I</option><option>II</option><option>III</option><option>IV</option>
                    <option>V</option><option>VI</option><option>VII</option><option>VIII</option>
                    <option>IX</option><option>X</option>
                  </select>
                  <div class="form-text-hint">Optional</div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Email</label>
              <input id="fEmail" type="email" class="form-control" required>
              <div class="field-error d-none" id="errEmail"></div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Status</label>
              <select id="fStatus" class="form-select" required>
                <option value="active">Active</option>
                <option value="disabled">Disabled</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">School</label>
              <input id="fSchoolName" type="text" class="form-control" disabled>
              <div class="form-text-hint">Automatically based on librarian’s school</div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">School ID / Student No.</label>
              <input id="fStudNo" type="text" class="form-control" required inputmode="numeric" pattern="\d{8}" maxlength="8" placeholder="8-digit ID">
              <div class="field-error d-none" id="errStudNo"></div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Course</label>
              <select id="fCourse" class="form-select" required>
                <option value="">Select Course</option>
                <option value="Bachelor of Science in Computer Science">Bachelor of Science in Computer Science</option>
                <option value="Bachelor of Science in Information Technology">Bachelor of Science in Information Technology</option>
                <option value="Bachelor of Science in Information Systems">Bachelor of Science in Information Systems</option>
                <option value="Bachelor of Science in Computer Engineering">Bachelor of Science in Computer Engineering</option>
                <option value="Bachelor of Science in Software Engineering">Bachelor of Science in Software Engineering</option>
                <option value="Bachelor of Science in Business Administration">Bachelor of Science in Business Administration</option>
                <option value="Bachelor of Science in Accountancy">Bachelor of Science in Accountancy</option>
                <option value="Bachelor of Science in Education">Bachelor of Science in Education</option>
                <option value="Bachelor of Arts in Psychology">Bachelor of Arts in Psychology</option>
                <option value="Bachelor of Science in Nursing">Bachelor of Science in Nursing</option>
                <option value="Bachelor of Science in Engineering">Bachelor of Science in Engineering</option>
                <option value="Bachelor of Science in Mathematics">Bachelor of Science in Mathematics</option>
              </select>
              <div class="field-error d-none" id="errCourse"></div>
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label">Year Level</label>
              <select id="fYear" class="form-select" required>
                <option value="">Select Year</option>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
                <option value="3rd">3rd</option>
                <option value="4th">4th</option>
              </select>
              <div class="field-error d-none" id="errYear"></div>
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label">Section</label>
              <select id="fSection" class="form-select" required>
                <option value="">Select Section</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="G">G</option>
                <option value="H">H</option>
              </select>
              <div class="field-error d-none" id="errSection"></div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Password</label>
              <div class="pw-wrap">
                <input id="fPassword" type="password" class="form-control" placeholder="≥8 chars, 1 uppercase, 1 special">
                <button type="button" class="pw-toggle" id="pwToggle1" aria-label="Show password">
                  <i class="bi bi-eye" id="pwIcon1"></i>
                </button>
              </div>
              <div id="pwHint" class="form-text-hint">Required when creating. Leave blank to keep current password.</div>
              <div class="field-error d-none" id="errPassword"></div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Confirm Password</label>
              <div class="pw-wrap">
                <input id="fConfirm" type="password" class="form-control" placeholder="Repeat password">
                <button type="button" class="pw-toggle" id="pwToggle2" aria-label="Show password">
                  <i class="bi bi-eye" id="pwIcon2"></i>
                </button>
              </div>
              <div class="field-error d-none" id="errConfirm"></div>
            </div>

            <div class="col-12">
              <label class="form-label">Notes</label>
              <input id="fNotes" type="text" class="form-control" placeholder="Optional notes…">
            </div>

            <input id="fId" type="hidden">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button id="btnSaveStudent" class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header modal-header-dark">
          <h5 class="modal-title">Student Details</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="vu-head">
            <div class="vu-avatar"><img src="assets/img/default-avatar.png" alt=""></div>
            <div>
              <div class="vu-name" id="vuName">—</div>
              <div class="text-muted small" id="vuEmail">—</div>
            </div>
            <div class="ms-auto">
              <button class="btn btn-outline-primary btn-sm me-2" id="vuEdit"><i class="bi bi-pencil-square me-1"></i>Edit</button>
              <button class="btn btn-outline-danger btn-sm" id="vuDelete"><i class="bi bi-trash me-1"></i>Delete</button>
            </div>
          </div>

          <div class="vu-sheet mt-3">
            <div class="vu-row vu-headrow"><div><i class="bi bi-info-circle me-2"></i>Field</div><div><i class="bi bi-clipboard-check me-2"></i>Details</div></div>
            <div class="vu-row"><div>Full Name</div><div id="vFullName">—</div></div>
            <div class="vu-row"><div>School</div><div id="vSchool">—</div></div>
            <div class="vu-row"><div>Student No.</div><div id="vStudNo">—</div></div>
            <div class="vu-row"><div>Course / Year / Section</div><div id="vCYS">—</div></div>
            <div class="vu-row"><div>Status</div><div id="vStatus">—</div></div>
            <div class="vu-row"><div>Notes</div><div id="vNotes">—</div></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header modal-header-dark">
          <h5 class="modal-title">Delete Student</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-1">You’re about to delete:</p>
          <div class="fw-semibold" id="delWho">—</div>
          <div class="text-muted small" id="delEmail">—</div>
          <div class="alert alert-warning mt-3 mb-0">This action can’t be undone.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" id="confirmDeleteBtn"><i class="bi bi-trash me-1"></i>Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header modal-header-success">
          <h5 class="modal-title" id="succTitle">Success</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex align-items-start gap-3">
          <i class="bi bi-check-circle-fill fs-3"></i>
          <div id="succBody">Student account has been created successfully.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/sidebar.js"></script>

  <script>
    async function getJson(url, opts = {}) {
      const res = await fetch(url, { credentials: 'include', ...opts });
      const text = await res.text();
      if (!text || text.trim() === '') throw new Error(`Empty response from server (${res.status} ${res.statusText})`);
      let data; try { data = JSON.parse(text); } catch { throw new Error(`Invalid JSON response: ${text.slice(0,200)}`); }
      if (!res.ok || data?.success === false) { const err = new Error(data?.error || data?.message || `HTTP ${res.status}`); err.field = data?.field; throw err; }
      return data;
    }

    async function getMe() {
      try { const data = await getJson('backend/check-auth.php'); return data.user; }
      catch { location.href = 'login.html'; return null; }
    }

    let me = null, schoolId = null, schoolName = "";
    let students = []; const pageSize = 10; let currentPage = 1;

    const tbody = document.getElementById('usersBody');
    const pager = document.getElementById('pager');
    const pageInfo = document.getElementById('pageInfo');
    const acctCount = document.getElementById('acctCount');
    const search = document.getElementById('searchInput');
    const btnAdd = document.getElementById('btnAdd');
    const checkAll = document.getElementById('checkAll');

    const studentModalEl = document.getElementById('studentModal');
    const viewModalEl = document.getElementById('viewModal');
    const confirmEl = document.getElementById('confirmDeleteModal');
    const successEl = document.getElementById('successModal');

    const studentModal = new bootstrap.Modal(studentModalEl);
    const viewModal    = new bootstrap.Modal(viewModalEl);
    const confirmModal = new bootstrap.Modal(confirmEl);
    const successModal = new bootstrap.Modal(successEl);

    const succTitle = document.getElementById('succTitle');
    const succBody  = document.getElementById('succBody');
    function showSuccess(title, message){
      succTitle.textContent = title || 'Success';
      succBody.textContent  = message || 'Done.';
      successModal.show();
    }

    const studentForm  = document.getElementById('studentForm');
    const studentModalTitle = document.getElementById('studentModalTitle');

    const fId = document.getElementById('fId');
    const fFirst = document.getElementById('fFirst');
    const fMiddle = document.getElementById('fMiddle');
    const fLast = document.getElementById('fLast');
    const fSuffix = document.getElementById('fSuffix');
    const fEmail = document.getElementById('fEmail');
    const fStatus = document.getElementById('fStatus');
    const fStudNo = document.getElementById('fStudNo');
    const fCourse = document.getElementById('fCourse');
    const fYear = document.getElementById('fYear');
    const fSection = document.getElementById('fSection');
    const fPassword = document.getElementById('fPassword');
    const fConfirm = document.getElementById('fConfirm');
    const fNotes = document.getElementById('fNotes');
    const fSchoolName = document.getElementById('fSchoolName');

    const errFirst = document.getElementById('errFirst');
    const errLast  = document.getElementById('errLast');
    const errEmail = document.getElementById('errEmail');
    const errStudNo= document.getElementById('errStudNo');
    const errCourse= document.getElementById('errCourse');
    const errYear  = document.getElementById('errYear');
    const errSection=document.getElementById('errSection');
    const errPassword = document.getElementById('errPassword');
    const errConfirm  = document.getElementById('errConfirm');

    function setupPwToggle(inputEl, btnId, iconId){
      const btn  = document.getElementById(btnId);
      const icon = document.getElementById(iconId);
      if(!inputEl || !btn || !icon) return;
      btn.addEventListener('click', () => {
        const showing = inputEl.type === 'text';
        inputEl.type = showing ? 'password' : 'text';
        icon.classList.toggle('bi-eye',  showing);
        icon.classList.toggle('bi-eye-slash', !showing);
        btn.setAttribute('aria-label', showing ? 'Show password' : 'Hide password');
      });
    }
    setupPwToggle(fPassword, 'pwToggle1', 'pwIcon1');
    setupPwToggle(fConfirm,  'pwToggle2', 'pwIcon2');

    const vuName   = document.getElementById('vuName');
    const vuEmail  = document.getElementById('vuEmail');
    const vFullName= document.getElementById('vFullName');
    const vSchool  = document.getElementById('vSchool');
    const vStudNo  = document.getElementById('vStudNo');
    const vCYS     = document.getElementById('vCYS');
    const vStatus  = document.getElementById('vStatus');
    const vNotes   = document.getElementById('vNotes');
    const vuEdit   = document.getElementById('vuEdit');
    const vuDelete = document.getElementById('vuDelete');

    const delWho  = document.getElementById('delWho');
    const delEmail = document.getElementById('delEmail');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let deleteId = null;

    function renderSidebarAndHeader() {
      renderSidebar('librarian-users', me.role);
      document.getElementById('sidebarToggle')?.addEventListener('click', () => {
        if (typeof toggleSidebar === 'function') toggleSidebar();
        else document.body.classList.toggle('sb-collapsed');
      });
      const displayName =
        me.full_name ||
        [me.first_name, me.middle_name, me.last_name].filter(Boolean).join(' ') ||
        me.name || me.email || 'Account';
      const profileNameEl   = document.getElementById('profileName');
      const profileHeaderEl = document.getElementById('profileHeader');
      if (profileNameEl)   profileNameEl.textContent   = displayName;
      if (profileHeaderEl) profileHeaderEl.textContent = 'Signed in as ' + displayName;
      document.getElementById('schoolChip').textContent = 'School: ' + (schoolName || '—');
      fSchoolName.value = schoolName || '';
    }

    function fullName(u){
      const parts = [u.first_name, u.middle_name, u.last_name].map(v => (v||'').trim()).filter(Boolean);
      const base = parts.join(' ');
      return base + (u.suffix ? ', ' + u.suffix : '');
    }
    const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    function comboCYS(u){ const a=[u.course,u.year_level,u.section].map(v=>(v||'').trim()).filter(Boolean); return a.length?a.join(' / '):'—'; }
    function statusBadge(u){ const active=(u.status||'').toLowerCase()==='active'; return active?'<span class="badge text-bg-success-soft">Active</span>':'<span class="badge text-bg-danger-soft">Disabled</span>'; }

    function rowHtml(u){
  return `
    <tr>
      <td><input class="form-check-input row-check" type="checkbox" value="${u.id}"></td>

      <!-- Name (no ID pill here anymore) -->
      <td>
        <div class="d-flex align-items-center gap-2">
          <img class="avatar" src="assets/img/default-avatar.png" alt="">
          <div class="fw-semibold">${escapeHtml(fullName(u))}</div>
        </div>
      </td>

      <!-- ID / Student No. -->
      <td class="col-id">${escapeHtml(u.student_no || '—')}</td>

      <!-- Email -->
      <td>${escapeHtml(u.email || '')}</td>

      <!-- School -->
      <td class="d-none d-xl-table-cell">${escapeHtml(u.school_name || schoolName || '—')}</td>

      <!-- Course -->
      <td>${escapeHtml((u.course || '').trim() || '—')}</td>

      <!-- Year -->
      <td>${escapeHtml((u.year_level || '').trim() || '—')}</td>

      <!-- Section -->
      <td>${escapeHtml((u.section || '').trim() || '—')}</td>

      <!-- Status -->
      <td class="col-status">${statusBadge(u)}</td>

      <!-- Actions -->
      <td class="text-end col-actions">
        <div class="dropdown text-end">
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
            <i class="bi bi-three-dots-vertical"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><button class="dropdown-item" data-action="view" data-id="${u.id}">
              <i class="bi bi-person-badge"></i> View</button></li>
            <li><button class="dropdown-item" data-action="edit" data-id="${u.id}">
              <i class="bi bi-pencil-square"></i> Edit</button></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger" data-action="delete" data-id="${u.id}">
              <i class="bi bi-trash"></i> Delete</button></li>
          </ul>
        </div>
      </td>
    </tr>`;
}

    function buildPager(total){
      const pages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > pages) currentPage = pages;
      pager.innerHTML = '';
      const add=(label,page,disabled=false,active=false)=>{
        const li=document.createElement('li');
        li.className=`page-item ${disabled?'disabled':''} ${active?'active':''}`;
        li.innerHTML=`<a class="page-link" href="#">${label}</a>`;
        li.onclick=e=>{e.preventDefault(); if(!disabled){ currentPage=page; render(); }};
        pager.appendChild(li);
      };
      add('‹', Math.max(1,currentPage-1), currentPage===1);
      for(let p=1;p<=pages;p++) add(p,p,false,p===currentPage);
      add('›', Math.min(pages,currentPage+1), currentPage===pages);
    }

    function applyFilters(){
      const q=(search.value||'').toLowerCase().trim();
      return students.filter(u => (
        (fullName(u)+' '+(u.email||'')+' '+(u.student_no||'')+' '+comboCYS(u)).toLowerCase().includes(q)
      ));
    }

    function render(){
      const list = applyFilters();
      const total = list.length;
      const start = (currentPage - 1) * pageSize;
      const end   = Math.min(start + pageSize, total);

      acctCount.textContent = String(students.length);
      tbody.innerHTML = total ? list.slice(start, end).map(rowHtml).join('') : `<tr class="empty-row"><td colspan="8">No students found.</td></tr>`;
      pageInfo.textContent = total ? `Showing ${start+1}–${end} of ${total}` : '—';
      buildPager(total);

      tbody.querySelectorAll('.dropdown-item').forEach(btn=>{
        const id = Number(btn.dataset.id);
        const action = btn.dataset.action;
        btn.onclick = () => {
          if (action==='view') return viewStudent(id);
          if (action==='edit') return editStudent(id);
          if (action==='delete') return askDelete(id);
        };
      });
    }

    async function loadStudents(){
      try{
        const data = await getJson('backend/list-users.php?role=student');
        students = (data.students || []).map(s => ({
          id:Number(s.id), first_name:s.first_name, middle_name:s.middle_name, last_name:s.last_name,
          suffix:s.suffix, email:s.email, student_no:s.student_no, course:s.course, year_level:s.year_level,
          section:s.section, status:s.status||'active', notes:s.notes||'',
          school_id:s.school_id ? Number(s.school_id) : schoolId, school_name:s.school_name || schoolName
        }));
        if (data.school_id) schoolId = data.school_id;
        if (students.length && students[0].school_name) {
          schoolName = students[0].school_name;
          document.getElementById('schoolChip').textContent = 'School: ' + schoolName;
          fSchoolName.value = schoolName;
        }
        currentPage = 1; render();
      }catch(err){
        console.error(err); students = []; render();
        alert(err.message || 'Network error while loading students.');
      }
    }

    const validEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v||'');
    const strongEnough = pw => /^(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{}|\\:;'"<>,.?/~`]).{8,}$/.test(pw||'');

    function clearErr(i,e){ i?.classList.remove('is-invalid'); if(e){ e.textContent=''; e.classList.add('d-none'); } }
    function setErr(i,e,msg){ i?.classList.add('is-invalid'); if(e){ e.textContent=msg; e.classList.remove('d-none'); } }
    function beginLoading(btn){ btn.classList.add('btn-loading'); btn.disabled=true; btn.insertAdjacentHTML('beforeend',' <span class="spinner-border" role="status" aria-hidden="true"></span>'); }
    function endLoading(btn){ btn.classList.remove('btn-loading'); btn.disabled=false; btn.querySelector('.spinner-border')?.remove(); }

    function viewStudent(id){
      const u = students.find(x=>x.id===id); if(!u) return;
      vuName.textContent = fullName(u);
      vuEmail.textContent = u.email || '—';
      vFullName.textContent = fullName(u);
      vSchool.textContent = u.school_name || schoolName || '—';
      vStudNo.textContent = u.student_no || '—';
      vCYS.textContent = comboCYS(u);
      vStatus.textContent = (u.status||'—').replace(/^\w/,c=>c.toUpperCase());
      vNotes.textContent = u.notes || '—';
      vuEdit.onclick = () => { viewModal.hide(); editStudent(u.id); };
      vuDelete.onclick = () => { viewModal.hide(); askDelete(u.id); };
      viewModal.show();
    }

    function openCreate(){
      studentModalTitle.textContent = 'Add Student';
      studentForm.reset();
      fId.value = ''; fStatus.value = 'active'; fSchoolName.value = schoolName || '';
      fCourse.value=''; fYear.value=''; fSection.value='';
      [[fFirst,errFirst],[fLast,errLast],[fEmail,errEmail],[fStudNo,errStudNo],[fCourse,errCourse],[fYear,errYear],[fSection,errSection],[fPassword,errPassword],[fConfirm,errConfirm]]
        .forEach(([i,e])=>clearErr(i,e));
      document.getElementById('pwHint').textContent = 'Required when creating. Leave blank to keep current password.';
      studentModal.show();
    }

    function editStudent(id){
      const u = students.find(x=>x.id===id); if(!u) return;
      studentModalTitle.textContent = 'Edit Student';
      fId.value=String(u.id); fFirst.value=u.first_name||''; fMiddle.value=u.middle_name||''; fLast.value=u.last_name||'';
      fSuffix.value=u.suffix||''; fEmail.value=u.email||''; fStatus.value=u.status||'active'; fStudNo.value=u.student_no||'';
      fCourse.value=u.course||''; fYear.value=u.year_level||''; fSection.value=u.section||''; fNotes.value=u.notes||'';
      fSchoolName.value=u.school_name||schoolName||''; fPassword.value=''; fConfirm.value='';
      [[fFirst,errFirst],[fLast,errLast],[fEmail,errEmail],[fStudNo,errStudNo],[fCourse,errCourse],[fYear,errYear],[fSection,errSection],[fPassword,errPassword],[fConfirm,errConfirm]]
        .forEach(([i,e])=>clearErr(i,e));
      document.getElementById('pwHint').textContent = 'Leave blank to keep current password.';
      studentModal.show();
    }

    fStudNo.addEventListener('input', () => {
      fStudNo.value = (fStudNo.value || '').replace(/\D/g, '').slice(0, 8);
      if (fStudNo.value.length > 0 && fStudNo.value.length < 8) {
        setErr(fStudNo, errStudNo, 'Student number must be exactly 8 digits.');
      } else {
        clearErr(fStudNo, errStudNo);
      }
    });

    studentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      [[fFirst,errFirst],[fLast,errLast],[fEmail,errEmail],[fStudNo,errStudNo],[fCourse,errCourse],[fYear,errYear],[fSection,errSection],[fPassword,errPassword],[fConfirm,errConfirm]]
        .forEach(([i,e])=>clearErr(i,e));

      let ok = true;
      if(!(fFirst.value||'').trim()){ setErr(fFirst,errFirst,'First name is required.'); ok=false; }
      if(!(fLast.value||'').trim()){ setErr(fLast,errLast,'Last name is required.'); ok=false; }
      if(!validEmail(fEmail.value)){ setErr(fEmail,errEmail,'Enter a valid email.'); ok=false; }
      const sn = (fStudNo.value||'').trim();
      if(!/^\d{8}$/.test(sn)){ setErr(fStudNo,errStudNo,'Student number must be exactly 8 digits.'); ok=false; }
      if(!fCourse.value.trim()){ setErr(fCourse,errCourse,'Course is required.'); ok=false; }
      if(!fYear.value.trim()){ setErr(fYear,errYear,'Year level is required.'); ok=false; }
      if(!fSection.value.trim()){ setErr(fSection,errSection,'Section is required.'); ok=false; }

      const isCreate = !(fId.value||'').trim();
      const pw = fPassword.value || '';
      const cf = fConfirm.value || '';
      if (isCreate) { if(!pw){ setErr(fPassword,errPassword,'Password is required.'); ok=false; } if(!cf){ setErr(fConfirm,errConfirm,'Please confirm the password.'); ok=false; } }
      if (pw){ if(!strongEnough(pw)){ setErr(fPassword,errPassword,'Use ≥8 chars with 1 uppercase & 1 special character.'); ok=false; }
               if(pw!==cf){ setErr(fConfirm,errConfirm,'Passwords do not match.'); ok=false; } }
      if(!ok) return;

      const model = {
        id: (fId.value||'').trim()? Number(fId.value): undefined,
        first_name:(fFirst.value||'').trim(), middle_name:(fMiddle.value||'').trim(),
        last_name:(fLast.value||'').trim(), suffix:(fSuffix.value||'').trim(),
        email:(fEmail.value||'').trim(), status:fStatus.value,
        student_no: sn, course:(fCourse.value||'').trim(),
        year_level:(fYear.value||'').trim(), section:(fSection.value||'').trim(),
        notes:(fNotes.value||'').trim()
      };
      if(pw) model.password = pw;

      const submitBtn = document.getElementById('btnSaveStudent');
      try{
        beginLoading(submitBtn);
        const url = isCreate ? 'backend/create-student.php' : 'backend/update-student.php';
        await getJson(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(model) });
        await loadStudents();
        studentModalEl.addEventListener('hidden.bs.modal', () => {
          if (isCreate) showSuccess('Student Added','The student account has been created successfully.');
          else showSuccess('Student Updated','The student account has been updated successfully.');
        }, { once:true });
        studentModal.hide();
        studentForm.reset();
      }catch(err){
        const msg = err.message || 'Network/Server error. Please try again.';
        if (err.field === 'email') setErr(fEmail, errEmail, msg);
        else if (err.field === 'student_no') setErr(fStudNo, errStudNo, msg);
        else if (/email/i.test(msg)) setErr(fEmail, errEmail, msg);
        else if (/student/i.test(msg)) setErr(fStudNo, errStudNo, msg);
        else setErr(fPassword, errPassword, msg);
      }finally{
        endLoading(submitBtn);
      }
    });

    function askDelete(id){
      const u = students.find(x=>x.id===id); if(!u) return;
      deleteId = id; delWho.textContent = fullName(u) || '(no name)'; delEmail.textContent = u.email || ''; confirmModal.show();
    }

    async function performDelete(){
      if(!deleteId) return;
      try{
        await getJson('/libratrack/backend/delete-user.php', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: deleteId })
        });
        students = students.filter(u => u.id !== deleteId); render(); confirmModal.hide();
      }catch(err){ alert('Network/Server error while deleting: ' + (err?.message || err)); }
      finally{ deleteId = null; }
    }
    confirmDeleteBtn.addEventListener('click', performDelete);

    successEl.addEventListener('shown.bs.modal', () => {
      document.querySelectorAll('.modal-backdrop:not(.show)').forEach(el => el.remove());
    }, { once:true });

    (async () => {
      me = await getMe(); if(!me) return;
      if (me.role !== 'librarian') { location.href='dashboard.html'; return; }
      schoolId = me.school_id ? Number(me.school_id) : null;
      schoolName = me.school_name || '';
      fSchoolName.value = schoolName || '';
      renderSidebarAndHeader();

      const attachBtn = () => {
        const btn = document.getElementById('btnAdd');
        if (!btn) return false;
        const clone = btn.cloneNode(true);
        btn.parentNode.replaceChild(clone, btn);
        clone.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openCreate(); });
        return true;
      };
      if (!attachBtn()) setTimeout(attachBtn, 200);

      search.addEventListener('input', () => { currentPage = 1; render(); });
      checkAll.addEventListener('change', () => {
        document.querySelectorAll('.row-check').forEach(cb => cb.checked = checkAll.checked);
      });

      await loadStudents();
    })();
  </script>
</body>
</html>
