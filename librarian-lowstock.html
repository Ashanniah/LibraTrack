<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack - Low Stock</title>

  <!-- Fonts / Icons / Bootstrap -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

  <!-- Shared + page styles -->
  <link href="assets/css/sidebar.css" rel="stylesheet">
  <link href="assets/css/librarian-borrow-return.css" rel="stylesheet">
  <link href="assets/css/responsive.css" rel="stylesheet">

  <link rel="icon" href="assets/img/LibraTrack-logo.png">
  <style>
    :root{
      --card-pad:24px;
      --cell-pad-y:14px;
      --cell-pad-x:20px;
      --ui-muted:#6b7280;
      --ui-border:#eef0f3;
      --ui-soft:#f6f7f9;
      --brand-black:#111827;
      --brand-gold:#a68604;
      --gold-dark:#8d7003;
      --sidebar-bg:#111;
      --text-primary:#212529;
      --text-secondary:#6b7280;
      --border-radius:12px;
      --border-radius-sm:8px;
      --border-radius-lg:16px;
      --shadow-sm:0 2px 4px rgba(0,0,0,.04);
      --shadow-md:0 4px 12px rgba(0,0,0,.08);
      --shadow-lg:0 6px 18px rgba(0,0,0,.12);
      --header-bg:#fff;
      --table-header-bg:#111;
      --card-border:#e5e7eb;
    }
    html{font-size:14px;}
    body{font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"}
    main.container-fluid{padding:24px!important}

    /* Header Styling */
    .admin-header-gold{
      background:#fff!important;
      border-bottom:1px solid var(--card-border);
      padding:12px 24px;
    }
    .search-bar-custom {
      height: 42px;
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius-sm);
      background: #fff;
      overflow: hidden;
    }
    .search-bar-custom .input-group-text,
    .search-bar-custom .form-control {
      height: 42px;
      padding: 10px 16px;
      font-size:0.875rem;
      border: none !important;
      background: transparent !important;
    }
    .search-bar-custom .input-group-text {
      color: var(--text-secondary);
      padding-left: 16px;
      padding-right: 8px;
    }
    .search-bar-custom .form-control {
      color: var(--text-primary);
      padding-left: 8px;
      padding-right: 16px;
    }
    .search-bar-custom .form-control::placeholder {
      color: var(--text-secondary);
    }
    .search-bar-custom:focus-within {
      box-shadow: 0 0 0 3px rgba(166,134,4,0.15);
      border-color: var(--brand-gold);
    }
    .search-bar-custom:focus-within .input-group-text {
      color: var(--text-primary);
    }
    .notification-btn{
      width:44px;
      height:44px;
      border-radius:var(--border-radius-sm);
      border:none;
      background:transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s ease;
      color:var(--text-primary);
      padding:0;
      position:relative;
    }
    .notification-btn:hover{
      background:#f8f9fa;
      color:var(--text-primary);
    }
    .notification-btn i{
      font-size:1.25rem;
    }
    .admin-btn-custom{
      padding:0;
      width:44px;
      height:44px;
      border-radius:50%;
      border:1px solid var(--card-border);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s ease;
    }
    .admin-btn-custom:hover{
      border-color:var(--brand-gold);
      box-shadow:0 0 0 2px rgba(166,134,4,0.1);
    }
    .admin-btn-custom img{
      width:32px;
      height:32px;
      border-radius:50%;
      object-fit:cover;
    }

    /* Stat Cards - Dashboard Style */
    .sb-card{
      background:#fff;
      border:1px solid var(--card-border);
      border-radius:var(--border-radius);
      padding:20px;
      transition:all 0.2s ease;
    }
    .sb-card.elevated{
      box-shadow:var(--shadow-sm);
    }
    .sb-card-title{
      font-size:0.875rem;
      font-weight:600;
      color:var(--text-secondary);
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .sb-card-title i{
      color:var(--text-secondary);
      font-size:1rem;
    }
    .sb-card-value{
      font-size:1.75rem;
      font-weight:700;
      color:var(--text-secondary);
      line-height:1.2;
      text-align:center;
    }
    
    /* Color-coded cards */
    .sb-card.card-danger .sb-card-title,
    .sb-card.card-danger .sb-card-title i,
    .sb-card.card-danger .sb-card-value{
      color:#dc2626 !important;
    }
    .sb-card.card-warning .sb-card-title,
    .sb-card.card-warning .sb-card-title i,
    .sb-card.card-warning .sb-card-value{
      color:#f59e0b !important;
    }
    .sb-card.card-success .sb-card-title,
    .sb-card.card-success .sb-card-title i,
    .sb-card.card-success .sb-card-value{
      color:#10b981 !important;
    }
    .sb-card.card-info .sb-card-title,
    .sb-card.card-info .sb-card-title i,
    .sb-card.card-info .sb-card-value{
      color:#3b82f6 !important;
    }

    /* Restock Modal Styling - Match Add Student Modal */
    #restockModal .modal-content{
      border-radius:var(--border-radius-lg);
      border:none;
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      overflow:visible !important;
    }
    #restockModal .modal-header-dark{
      background:var(--sidebar-bg) !important;
      color:#fff !important;
      border-bottom:none !important;
      border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0 !important;
      padding:24px 32px !important;
      min-height:64px !important;
    }
    #restockModal .modal-header-dark .modal-title{
      color:#fff !important;
      font-weight:700 !important;
      font-size:1.25rem;
      letter-spacing:-0.01em;
    }
    #restockModal .modal-header-dark .btn-close{
      filter:invert(1) grayscale(1);
      opacity:0.7;
      transition:opacity 0.2s ease;
      padding:8px;
    }
    #restockModal .modal-header-dark .btn-close:hover{
      opacity:1;
    }
    #restockModal .modal-body{
      padding:32px !important;
      background:#fff;
      overflow:visible !important;
    }
    #restockModal .modal-content{
      overflow:visible !important;
    }
    #restockModal .modal-dialog{
      overflow:visible !important;
    }
    #restockModal .form-label{
      font-weight:600;
      font-size:0.875rem;
      color:#374151;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    #restockModal .modal-footer{
      padding:20px 32px;
      border-top:1px solid #e5e7eb;
      background:#f9fafb;
      border-radius:0 0 var(--border-radius-lg) var(--border-radius-lg);
      display:flex;
      justify-content:flex-end;
      gap:12px;
    }
    #restockModal .modal-footer .btn{
      border-radius:8px;
      font-weight:600;
      font-size:0.9375rem;
      padding:10px 24px;
      min-width:100px;
      transition:all 0.2s ease;
      border-width:1.5px;
    }
    #restockModal .modal-footer .btn-light{
      background:#fff !important;
      border-color:#d1d5db !important;
      color:#374151 !important;
    }
    #restockModal .modal-footer .btn-light:hover{
      background:#f9fafb !important;
      border-color:#9ca3af !important;
      color:#111827 !important;
      transform:translateY(-1px);
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    #restockModal .modal-footer .btn-primary{
      background:var(--brand-gold) !important;
      border-color:var(--brand-gold) !important;
      color:#fff !important;
      box-shadow:0 2px 4px rgba(166,134,4,0.2);
    }
    #restockModal .modal-footer .btn-primary:hover{
      background:var(--gold-dark) !important;
      border-color:var(--gold-dark) !important;
      color:#fff !important;
      transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(166,134,4,0.3);
    }
    #restockModal .modal-footer .btn:active{
      transform:translateY(0);
    }

    /* Threshold Modal Styling - Match Add Student Modal */
    #thModal .modal-content{
      border-radius:var(--border-radius-lg);
      border:none;
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      overflow:visible !important;
    }
    #thModal .modal-header-dark{
      background:var(--sidebar-bg) !important;
      color:#fff !important;
      border-bottom:none !important;
      border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0 !important;
      padding:24px 32px !important;
      min-height:64px !important;
    }
    #thModal .modal-header-dark .modal-title{
      color:#fff !important;
      font-weight:700 !important;
      font-size:1.25rem;
      letter-spacing:-0.01em;
    }
    #thModal .modal-header-dark .btn-close{
      filter:invert(1) grayscale(1);
      opacity:0.7;
      transition:opacity 0.2s ease;
      padding:8px;
    }
    #thModal .modal-header-dark .btn-close:hover{
      opacity:1;
    }
    #thModal .modal-body{
      padding:32px !important;
      background:#fff;
      overflow:visible !important;
    }
    #thModal .modal-content{
      overflow:visible !important;
    }
    #thModal .modal-dialog{
      overflow:visible !important;
    }
    #thModal .form-label{
      font-weight:600;
      font-size:0.875rem;
      color:#374151;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    #thModal .form-control{
      padding:10px 14px;
      font-size:0.9375rem;
      border:1.5px solid #e5e7eb;
      border-radius:8px;
      background:#fff;
      color:#111827;
      transition:all 0.2s ease;
      text-align:center;
    }
    #thModal .form-control:focus{
      border-color:var(--brand-gold);
      box-shadow:0 0 0 3px rgba(166,134,4,0.1);
      outline:none;
    }
    #thModal .form-control:hover:not(:focus){
      border-color:#d1d5db;
    }
    #thModal .form-control::placeholder{
      color:#9ca3af;
      font-size:0.875rem;
    }
    #thModal .form-control.is-invalid{
      border-color:#dc3545;
      background-color:#fef2f2;
    }
    #thModal .form-control.is-invalid:focus{
      border-color:#dc3545;
      box-shadow:0 0 0 3px rgba(220,53,69,0.1);
    }
    #thModal .modal-footer{
      padding:20px 32px;
      border-top:1px solid #e5e7eb;
      background:#f9fafb;
      border-radius:0 0 var(--border-radius-lg) var(--border-radius-lg);
      display:flex;
      justify-content:flex-end;
      gap:12px;
    }
    #thModal .modal-footer .btn{
      border-radius:8px;
      font-weight:600;
      font-size:0.9375rem;
      padding:10px 24px;
      min-width:100px;
      transition:all 0.2s ease;
      border-width:1.5px;
    }
    #thModal .modal-footer .btn-light{
      background:#fff !important;
      border-color:#d1d5db !important;
      color:#374151 !important;
    }
    #thModal .modal-footer .btn-light:hover{
      background:#f9fafb !important;
      border-color:#9ca3af !important;
      color:#111827 !important;
      transform:translateY(-1px);
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    #thModal .modal-footer .btn-primary{
      background:var(--brand-gold) !important;
      border-color:var(--brand-gold) !important;
      color:#fff !important;
      box-shadow:0 2px 4px rgba(166,134,4,0.2);
    }
    #thModal .modal-footer .btn-primary:hover{
      background:var(--gold-dark) !important;
      border-color:var(--gold-dark) !important;
      color:#fff !important;
      transform:translateY(-1px);
      box-shadow:0 4px 8px rgba(166,134,4,0.3);
    }
    #thModal .modal-footer .btn:active{
      transform:translateY(0);
    }

    /* Table Styling */
    .table-modern{
      margin-bottom:0;
    }
    .table-modern thead th{
      background:#fff;
      color:var(--text-secondary);
      font-weight:700;
      font-size:0.8125rem;
      text-transform:uppercase;
      letter-spacing:0.05em;
      padding:16px var(--cell-pad-x);
      border-bottom:2px solid var(--ui-border);
      vertical-align:middle;
    }
    .table-modern tbody td{
      padding:var(--cell-pad-y) var(--cell-pad-x);
      vertical-align:middle;
      border-bottom:1px solid var(--ui-border);
      color:var(--text-primary);
    }
    .table-modern tbody tr:hover{
      background:#f8f9fa;
    }

    /* Card Styling */
    .card{
      border-radius:var(--border-radius-lg);
      box-shadow:var(--shadow-sm);
      border:1px solid var(--ui-border);
      background:#fff;
    }
    .card-header{
      background:var(--table-header-bg);
      color:#fff;
      border-bottom:0;
      padding:20px var(--card-pad);
      border-radius:var(--border-radius-lg) var(--border-radius-lg) 0 0;
    }

    /* Pagination */
    .pagination .page-item.active .page-link{
      background:var(--brand-gold)!important;
      color:#fff!important;
      border-color:var(--brand-gold)!important;
    }

    /* Filter Section */
    .filter-section{
      background:#fff;
      border-radius:var(--border-radius-lg);
      box-shadow:var(--shadow-sm);
      border:1px solid var(--ui-border);
      padding:20px var(--card-pad);
      margin-bottom:24px;
    }
    .filter-section .form-label{
      font-weight:600;
      font-size:0.875rem;
      color:var(--text-primary);
      margin-bottom:8px;
    }
    .filter-section .form-control,
    .filter-section .form-select{
      border:1.5px solid var(--ui-border);
      border-radius:var(--border-radius-sm);
      padding:10px 14px;
      font-size:0.9375rem;
    }
    .filter-section .form-control:focus,
    .filter-section .form-select:focus{
      border-color:var(--brand-gold);
      box-shadow:0 0 0 3px rgba(166,134,4,0.1);
    }

    /* Empty State */
    .empty{
      text-align:center;
      padding:48px 24px;
      color:var(--text-secondary);
    }
    .empty i{
      color:var(--text-secondary);
      opacity:0.5;
    }
  </style>
</head>
<body class="sb-body">
  <div id="sidebar-root"></div>

  <div class="sb-wrapper">
    <nav class="sb-topbar navbar navbar-expand sticky-top admin-header-gold">
      <div class="container-fluid">
        <button id="sidebarToggle" class="btn btn-link text-dark me-2" aria-label="Toggle sidebar">
          <i class="bi bi-list fs-4"></i>
        </button>
        <div class="fw-bold h5 mb-0" id="pageTitle">Low Stock</div>

        <div class="ms-auto d-flex align-items-center gap-2">
          <form class="d-none d-md-flex" role="search" style="max-width:520px;width:100%;">
            <div class="input-group search-bar-custom">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input id="q" class="form-control" type="search" placeholder="Search title, author, ISBN...">
            </div>
          </form>

          <div class="dropdown position-relative">
            <button id="btnNotifications" class="btn notification-btn" data-bs-toggle="dropdown" title="Notifications" aria-expanded="false">
              <i class="bi bi-bell"></i>
              <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill d-none" style="background:var(--brand-gold); color:#fff; font-size:0.65rem; padding:2px 6px; font-weight:600; border:2px solid #fff;">0</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" id="notificationDropdown" style="min-width: 320px; max-width: 400px;">
              <li><h6 class="dropdown-header">Notifications</h6></li>
              <li><hr class="dropdown-divider"></li>
              <li id="notificationList">
                <div class="px-3 py-2 text-center text-muted">
                  <small>No notifications</small>
                </div>
              </li>
            </ul>
          </div>

          <div class="dropdown">
            <button id="userBtn" class="btn admin-btn-custom" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="assets/img/default-avatar.png" alt="User" class="avatar-32">
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="librarian-profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="logout(); return false;"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="container-fluid py-4">
      <!-- Stats -->
      <section class="row g-3 mb-3">
        <div class="col-6 col-md-4">
          <div class="sb-card elevated text-center card-warning">
            <div class="sb-card-title"><i class="bi bi-box-seam"></i>Titles Low</div>
            <div class="sb-card-value" id="stTitles">0</div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="sb-card elevated text-center card-danger">
            <div class="sb-card-title"><i class="bi bi-exclamation-triangle"></i>Critical (0-1)</div>
            <div class="sb-card-value" id="stCritical">0</div>
          </div>
        </div>
        <div class="col-6 col-md-4">
          <div class="sb-card elevated text-center card-info">
            <div class="sb-card-title"><i class="bi bi-clipboard2-check"></i>Needed Copies</div>
            <div class="sb-card-value" id="stNeeded">0</div>
          </div>
        </div>
      </section>

      <!-- Filters -->
      <section class="filter-section">
        <div class="row g-3 align-items-end">
          <div class="col-6 col-md-3">
            <label class="form-label">Category</label>
            <select id="fCat" class="form-select">
              <option value="">All</option>
              <option>Computer Science</option>
              <option>Fantasy</option>
              <option>Science</option>
              <option>History</option>
              <option>Children's Books</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Severity</label>
            <select id="fSeverity" class="form-select">
              <option value="">All</option>
              <option value="critical">Critical (=1)</option>
              <option value="low">Low (= threshold)</option>
            </select>
          </div>
          <div class="col-12 col-md-6 text-md-end">
            <div class="d-flex gap-2 justify-content-md-end">
              <button id="btnRestock" class="btn btn-primary"><i class="bi bi-bag-plus me-1"></i>Restock</button>
              <button id="btnEmail" class="btn btn-warning"><i class="bi bi-envelope-exclamation me-1"></i>Email Alert</button>
              <button id="btnDelete" class="btn btn-danger"><i class="bi bi-trash3 me-1"></i>Delete</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Table -->
      <section class="card p-0">
        <div class="card-header">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="fw-semibold">Low Stock</div>
            <button id="btnExport" class="btn btn-sm" style="background:#fff; color:#111; border:1px solid rgba(255,255,255,0.3); padding:6px 16px; cursor:pointer; min-width:80px;">
              <i class="bi bi-download me-2"></i>Export CSV
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-modern align-middle mb-0" id="tbl">
            <thead>
              <tr>
                <th style="width:38px"><input class="form-check-input" type="checkbox" id="checkAll"></th>
                <th>Title / Author</th>
                <th>ISBN</th>
                <th>Category</th>
                <th class="text-center">Qty</th>
                <th class="text-center">Threshold</th>
                <th class="text-center">Needed</th>
                <th class="text-end" style="width:180px">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"><!-- JS --></tbody>
          </table>
        </div>

        <div class="d-flex justify-content-between align-items-center p-3 gap-2 flex-wrap">
          <div class="text-muted small" id="pageInfo">Showing 1�10 of 0</div>
          <nav><ul class="pagination pagination-sm mb-0" id="pager"></ul></nav>
        </div>

        <div id="emptyState" class="empty d-none text-center py-5">
          <i class="bi bi-box2-heart fs-2 d-block mb-2 text-muted"></i>
          <p class="text-muted mb-0">Nothing low right now. Great job keeping stock healthy!</p>
        </div>
      </section>
    </main>
  </div>

  <!-- Edit Threshold Modal -->
  <div class="modal fade" id="thModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="thForm" novalidate>
        <div class="modal-header modal-header-dark">
          <h5 class="modal-title">Edit Low-stock Threshold</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 text-muted small" id="thBook">—</div>
          <label class="form-label">Threshold <span class="text-danger">*</span></label>
          <input type="number" id="thValue" class="form-control" min="0" step="1" required>
          <div class="invalid-feedback">Enter a valid number.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Restock Confirmation Modal -->
  <div class="modal fade" id="restockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header modal-header-dark">
          <h5 class="modal-title">Restock Book</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="text-muted small mb-2" id="restockBookInfo">—</div>
            <div class="mb-3">
              <label class="form-label mb-1">Current Quantity</label>
              <div class="form-control bg-light" id="restockCurrentQty" style="text-align:center; font-weight:600; font-size:1.125rem; border:1px solid #e5e7eb;">0</div>
            </div>
            <div class="mb-3">
              <label class="form-label mb-1">Add Copies <span class="text-danger">*</span></label>
              <input type="number" id="restockAddCopies" class="form-control" min="1" step="1" value="1" required style="text-align:center; font-weight:600; font-size:1.125rem; padding:12px;">
              <div class="invalid-feedback">Please enter a valid number (minimum 1).</div>
            </div>
            <div class="mb-3">
              <label class="form-label mb-1">New Quantity</label>
              <div class="form-control bg-light" id="restockNewQty" style="text-align:center; font-weight:600; font-size:1.125rem; color:var(--brand-gold); border:1px solid #e5e7eb;">0</div>
            </div>
            <div class="alert alert-info mb-0" style="background:#e8f2ff; border-color:#b3d9ff; color:#1e40af;">
              <i class="bi bi-info-circle me-2"></i>
              <span id="restockMessage">Adding copies to meet the threshold.</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="button" id="btnConfirmRestock">Confirm Restock</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/sidebar.js?v=2025-11-19-FINAL-LOANS-COMBINED-V4"></script>
  <!-- Centralized Notifications -->
  <script src="assets/js/notifications.js"></script>
  <script>
    // Initialize with authentication check
    (async () => {
      const res = await fetch('/api/check-auth', {credentials:'include'});
      if (!res.ok) { location.href = 'login.html'; return; }
      const data = await res.json().catch(()=>null);
      const role = (data?.user?.role || '').toLowerCase();
      if (role !== 'librarian' && role !== 'admin') { location.href = 'dashboard.html'; return; }

      renderSidebar('lowstock', role, false);
      localStorage.setItem('userRole', role);
      
      // Load avatar in header if available
      const headerAvatar = document.querySelector('#userBtn img.avatar-32');
      if (headerAvatar && data?.user?.avatar && data.user.avatar.trim() !== '') {
        headerAvatar.src = data.user.avatar;
      }
      
      // Attach sidebar toggle listener
      const sidebarToggleBtn = document.getElementById('sidebarToggle');
      if (sidebarToggleBtn) {
        // Remove any existing listeners by cloning and replacing
        const newBtn = sidebarToggleBtn.cloneNode(true);
        sidebarToggleBtn.parentNode.replaceChild(newBtn, sidebarToggleBtn);
        
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          // Use window.toggleSidebar if available, otherwise fallback
          if (typeof window.toggleSidebar === 'function') {
            window.toggleSidebar();
          } else {
            // Fallback: toggle classes directly
            const isDesktop = window.innerWidth >= 992;
            const cls = isDesktop ? 'sb-expanded' : 'sb-toggled';
            document.body.classList.toggle(cls);
            if (isDesktop) document.body.classList.remove('sb-toggled');
          }
        });
      }
      
      // Logout function
      window.logout = async function() {
        try {
          await fetch('/api/logout', {method:'POST', credentials:'include'});
          localStorage.removeItem('userRole');
          location.href = 'login.html';
        } catch(e) {
          location.href = 'login.html';
        }
      };

    // Data
    let books = [];
    let threshold = 3; // Default threshold from settings
    let categories = [];

    // Elements
    const q=document.getElementById('q'), fCat=document.getElementById('fCat'), fSeverity=document.getElementById('fSeverity');
    const tbody=document.getElementById('tbody'), empty=document.getElementById('emptyState');
    const stTitles=document.getElementById('stTitles'), stCritical=document.getElementById('stCritical'), stNeeded=document.getElementById('stNeeded');
    const pager=document.getElementById('pager'), pageInfo=document.getElementById('pageInfo'), checkAll=document.getElementById('checkAll');
    const thModal = new bootstrap.Modal('#thModal'); const thForm=document.getElementById('thForm'); const thValue=document.getElementById('thValue'); const thBook=document.getElementById('thBook');
    let thId=null;

    // Helpers
    const pageSize=10; let currentPage=1;
    const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

    // Calculate available quantity (per-school perspective)
    function getAvailable(b) {
      const total = (b.quantity ?? 0);
      const borrowed = (b.borrowed ?? 0);
      return Math.max(0, total - borrowed);
    }

    // Get low stock books (available <= threshold)
    function getLowStockBooks() {
      return books.filter(b => {
        const available = getAvailable(b);
        return available <= threshold;
      });
    }

    function applyFilters(){
      const lowStock = getLowStockBooks();
      const text=(q.value||'').toLowerCase().trim();
      const cat=fCat.value, sev=fSeverity.value;
      return lowStock.filter(b=>{
        const available = getAvailable(b);
        const hit=(b.title+' '+b.author+' '+b.isbn).toLowerCase().includes(text);
        const catOk=cat? b.category===cat : true;
        const sevOk=sev==='critical'? available<=1 : sev==='low'? available<=threshold : true;
        return hit && catOk && sevOk;
      });
    }
    function updateStats(list){
      stTitles.textContent=list.length;
      stCritical.textContent=list.filter(b=>getAvailable(b)<=1).length;
      stNeeded.textContent=list.reduce((sum,b)=> sum + Math.max(0,threshold-getAvailable(b)),0);
    }
    function render(){
      const list=applyFilters(); updateStats(list);
      const total=list.length, pages=Math.max(1,Math.ceil(total/pageSize));
      if(currentPage>pages) currentPage=pages;
      const start=(currentPage-1)*pageSize, end=Math.min(start+pageSize,total), slice=list.slice(start,end);

      empty.classList.toggle('d-none', !!slice.length);
      tbody.innerHTML=slice.map(rowHtml).join('');
      pageInfo.textContent=`Showing ${total?start+1:0}-${end} of ${total}`;
      pager.innerHTML='';
      const add=(label,page,dis=false,act=false)=>{ const li=document.createElement('li'); li.className=`page-item ${dis?'disabled':''} ${act?'active':''}`; li.innerHTML=`<a class="page-link" href="#">${label}</a>`; li.onclick=(e)=>{e.preventDefault(); if(!dis){currentPage=page; render();}}; pager.appendChild(li); };
      add('«',1,currentPage===1); add('‹',Math.max(1,currentPage-1),currentPage===1);
      for(let p=1;p<=pages;p++) add(p,p,false,p===currentPage);
      add('›',Math.min(pages,currentPage+1),currentPage===pages); add('»',pages,currentPage===pages);
      checkAll.checked=false;
    }
    function severityPill(b){
      const available = getAvailable(b);
      if (available <= 0) return '<span class="pill pill-red ms-2">Critical</span>';
      if (available === 1) return '<span class="pill pill-orange ms-2">Low</span>';
      if (available <= threshold) return '<span class="pill pill-yellow ms-2">Below</span>';
      return '';
    }
    function rowHtml(b){
      const available = getAvailable(b);
      const needed = Math.max(0, threshold - available);
      const total = (b.quantity ?? 0);
      const borrowed = (b.borrowed ?? 0);
      return `
        <tr>
          <td><input class="form-check-input row-check" type="checkbox" value="${b.id}"></td>
          <td>
            <div class="fw-medium">${esc(b.title)}</div>
            <div class="small text-muted">${esc(b.author)}</div>
          </td>
          <td>${esc(b.isbn)}</td>
          <td>${esc(b.category)}</td>
          <td class="text-center">
            <div>${available}${severityPill(b)}</div>
            <div class="small text-muted">(${total} total, ${borrowed} borrowed)</div>
          </td>
          <td class="text-center">${threshold}</td>
          <td class="text-center">${needed}</td>
          <td class="text-end">
            <div class="d-flex align-items-center gap-2 justify-content-end">
              <button class="btn btn-warning btn-sm" title="Email Alert" onclick="emailAlert(${b.id})" style="width:36px; height:36px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <i class="bi bi-envelope-exclamation"></i>
              </button>
              <button class="btn btn-primary btn-sm" title="Restock +1" onclick="restock(${b.id})" style="width:36px; height:36px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <i class="bi bi-bag-plus"></i>
              </button>
              <button class="btn btn-secondary btn-sm" title="Edit Threshold" onclick="editThreshold(${b.id})" style="width:36px; height:36px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <i class="bi bi-sliders"></i>
              </button>
            </div>
          </td>
        </tr>`;
    }

    // Events
    [q,fCat,fSeverity].forEach(el=>el.addEventListener('input',()=>{currentPage=1;render();}));
    document.getElementById('btnExport').onclick=()=>{
      const rows=applyFilters().map(b=>{
        const available = getAvailable(b);
        return [b.id,b.title,b.author,b.isbn,b.category,available,threshold];
      });
      const csv=["id,title,author,isbn,category,available,threshold", ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(","))].join("\n");
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download="lowstock.csv"; a.click(); URL.revokeObjectURL(a.href);
    };
    const selectedIds=()=>{ const ids=[]; document.querySelectorAll('.row-check:checked').forEach(cb=>ids.push(Number(cb.value))); return ids; };
    checkAll.addEventListener('change',()=>{ document.querySelectorAll('.row-check').forEach(cb=>cb.checked=checkAll.checked); });
    
    // Bulk Restock
    document.getElementById('btnRestock').onclick=async ()=>{
      const ids=selectedIds();
      if(!ids.length) {
        alert('Please select at least one book to restock.');
        return;
      }
      
      if(!confirm(`Restock ${ids.length} selected book(s)? This will add the needed copies to meet the threshold.`)) return;
      
      const btn = document.getElementById('btnRestock');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Restocking...';
      
      try {
        let successCount = 0;
        let failCount = 0;
        
        for(const bookId of ids) {
          const book = books.find(b => b.id === bookId);
          if(!book) continue;
          
          const available = getAvailable(book);
          const needed = Math.max(0, threshold - available);
          
          if(needed <= 0) {
            continue; // Already above threshold
          }
          
          const newQuantity = (book.quantity || 0) + needed;
          
          try {
            const fd = new FormData();
            fd.append('id', bookId);
            fd.append('title', book.title || '');
            fd.append('isbn', book.isbn || '');
            fd.append('author', book.author || '');
            fd.append('category', book.category || '');
            fd.append('publisher', book.publisher || '');
            fd.append('quantity', newQuantity);
            if(book.date_published) fd.append('date_published', book.date_published);
            
            const res = await fetch(`/api/books/${bookId}`, { 
              method: 'PUT', 
              body: fd, 
              credentials: 'include' 
            });
            
            const data = await res.json().catch(()=>({ok:false}));
            if(data.ok) {
              successCount++;
            } else {
              failCount++;
              console.error(`Failed to restock ${book.title}:`, data.error);
            }
          } catch(err) {
            failCount++;
            console.error(`Error restocking ${book.title}:`, err);
          }
        }
        
        if(successCount > 0) {
          await loadData();
          alert(`Successfully restocked ${successCount} book(s)${failCount > 0 ? `. ${failCount} failed.` : '.'}`);
        } else if(failCount > 0) {
          alert(`Failed to restock ${failCount} book(s). Please try again.`);
        } else {
          alert('Selected books are already above the threshold.');
        }
      } catch(err) {
        console.error('Restock error:', err);
        alert('An error occurred while restocking. Please try again.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    };
    
    document.getElementById('btnEmail').onclick=()=>{ const ids=selectedIds(); if(!ids.length) return alert('Select rows first.'); alert('Email alert feature coming soon.'); };
    document.getElementById('btnDelete').onclick=()=>{ const ids=selectedIds(); if(!ids.length) return alert('Select rows first.'); if(!confirm('Delete selected titles?')) return; alert('Delete feature should call backend API.'); };

    // Actions
    window.emailAlert=function(id){ const b=books.find(x=>x.id===id); alert('Email alert feature coming soon for "'+b.title+'".'); };
    
    // Individual Restock (+1)
    let currentRestockBook = null;
    const restockModalEl = document.getElementById('restockModal');
    const restockModal = restockModalEl ? new bootstrap.Modal(restockModalEl) : null;
    
    window.restock=function(id){
      const book = books.find(b => b.id === id);
      if(!book) {
        alert('Book not found.');
        return;
      }
      
      currentRestockBook = book;
      const currentQty = book.quantity || 0;
      const threshold = window.threshold || 3;
      const needed = Math.max(0, threshold - currentQty);
      
      // Update modal content
      const restockBookInfo = document.getElementById('restockBookInfo');
      const restockCurrentQty = document.getElementById('restockCurrentQty');
      const restockAddCopies = document.getElementById('restockAddCopies');
      const restockNewQty = document.getElementById('restockNewQty');
      const restockMessage = document.getElementById('restockMessage');
      
      if(restockBookInfo) restockBookInfo.textContent = `${book.title} (${book.isbn || 'N/A'})`;
      if(restockCurrentQty) restockCurrentQty.textContent = currentQty;
      if(restockAddCopies) {
        restockAddCopies.value = needed > 0 ? needed : 1;
        restockAddCopies.min = 1;
      }
      
      // Function to update new quantity and message
      const updateRestockInfo = () => {
        const addCopies = parseInt(restockAddCopies?.value || 1) || 1;
        const newQty = currentQty + addCopies;
        if(restockNewQty) restockNewQty.textContent = newQty;
        if(restockMessage) {
          restockMessage.textContent = `Adding ${addCopies} copy${addCopies !== 1 ? 'ies' : ''} to "${book.title}". New total: ${newQty} copies.`;
        }
      };
      
      // Initial update
      updateRestockInfo();
      
      // Update on input change
      if(restockAddCopies) {
        restockAddCopies.addEventListener('input', updateRestockInfo);
      }
      
      // Show modal
      if(restockModal) restockModal.show();
    };
    
    // Handle restock confirmation
    document.getElementById('btnConfirmRestock')?.addEventListener('click', async function() {
      if(!currentRestockBook) return;
      
      const restockAddCopies = document.getElementById('restockAddCopies');
      const addCopies = parseInt(restockAddCopies?.value || 1) || 1;
      
      if(!restockAddCopies || addCopies < 1) {
        restockAddCopies?.classList.add('is-invalid');
        return;
      }
      
      restockAddCopies?.classList.remove('is-invalid');
      
      const btn = this;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Restocking...';
      
      try {
        const id = currentRestockBook.id;
        const currentQty = currentRestockBook.quantity || 0;
        const newQty = currentQty + addCopies;
        
        const fd = new FormData();
        fd.append('id', id);
        fd.append('title', currentRestockBook.title || '');
        fd.append('isbn', currentRestockBook.isbn || '');
        fd.append('author', currentRestockBook.author || '');
        fd.append('category', currentRestockBook.category || '');
        fd.append('publisher', currentRestockBook.publisher || '');
        fd.append('quantity', newQty);
        if(currentRestockBook.date_published) fd.append('date_published', currentRestockBook.date_published);
        
        const res = await fetch(`/api/books/${id}`, { 
          method: 'PUT', 
          body: fd, 
          credentials: 'include' 
        });
        
        const data = await res.json().catch(()=>({ok:false}));
        if(data.ok) {
          restockModal?.hide();
          await loadData();
          // Show success message
          const successAlert = document.createElement('div');
          successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
          successAlert.style.zIndex = '9999';
          successAlert.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>Successfully added ${addCopies} copy${addCopies !== 1 ? 'ies' : ''} to "${currentRestockBook.title}".
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.body.appendChild(successAlert);
          setTimeout(() => successAlert.remove(), 3000);
        } else {
          alert(`Failed to restock: ${data.error || 'Unknown error'}`);
        }
      } catch(err) {
        console.error('Restock error:', err);
        alert('An error occurred while restocking. Please try again.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
        currentRestockBook = null;
      }
    });
    window.editThreshold=function(id){ 
      // Edit global threshold (stored in settings)
      thId=id; 
      const b=books.find(x=>x.id===id);
      thBook.textContent=`${b.title} (${b.isbn}) - Global Threshold`;
      thValue.value=threshold; 
      thForm.classList.remove('was-validated'); 
      thModal.show(); 
    };

    thForm.addEventListener('submit',(e)=>{ 
      e.preventDefault(); 
      thForm.classList.add('was-validated'); 
      if(!thForm.checkValidity()) return; 
      threshold = Number(thValue.value||3); 
      // TODO: Save threshold to backend settings
      thModal.hide(); 
      render(); 
    });

    // Load data
    async function loadData() {
      try {
        // Load settings (threshold)
        try {
          const settingsRes = await fetch('/api/settings', {credentials:'include'});
          const settingsData = await settingsRes.json().catch(()=>({success:false}));
          if (settingsData.success && settingsData.settings) {
            threshold = parseInt(settingsData.settings['low_stock_threshold'] || '3', 10);
          }
        } catch(e) {}

        // Load books (global catalog with per-school borrowed counts)
        let page = 1;
        let allBooks = [];
        let totalPages = 1;
        do {
          const res = await fetch(`/api/books?page=${page}&pagesize=100`, {credentials:'include'});
          const data = await res.json().catch(()=>({ok:false}));
          if (data.ok && data.items) {
            allBooks = allBooks.concat(data.items);
            totalPages = data.pages || 1;
            page++;
          } else {
            break;
          }
        } while (page <= totalPages);

        books = allBooks;
        
        // Extract categories
        categories = [...new Set(books.map(b=>b.category).filter(Boolean))].sort();
        const fCatEl = document.getElementById('fCat');
        fCatEl.innerHTML = '<option value="">All</option>' + categories.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');

        render();
      } catch(e) {
        console.error('Failed to load data:', e);
        render();
      }
    }

    // Init
    loadData();
    })(); // Close the async IIFE
  </script>
</body>
</html>
