<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack - Members</title>

  <!-- Fonts / Icons / Bootstrap -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

  <!-- Shared + page styles -->
  <link href="assets/css/sidebar.css" rel="stylesheet">
  <link href="assets/css/librarian-members.css" rel="stylesheet">

  <link rel="icon" href="assets/img/LibraTrack-logo.png">
</head>

<body class="sb-body">
  <!-- Shared Sidebar -->
  <div id="sidebar-root"></div>

  <!-- ============= MAIN WRAPPER ============= -->
  <div class="sb-wrapper">
    <!-- Topbar -->
    <div class="topbar">
      <div class="page-head d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-2">
          <button id="sidebarToggle" class="btn btn-link text-dark p-0 me-2" aria-label="Toggle sidebar">
            <i class="bi bi-list fs-4"></i>
          </button>
          <div class="page-title">Members</div>
        </div>

        <div class="d-flex align-items-center gap-2 tools-wrap">
          <div class="search-wrap flex-grow-1">
            <i class="bi bi-search"></i>
            <input id="memberSearch" type="search" placeholder="Search name, email, student no.…">
          </div>
          <button class="btn btn-primary d-flex align-items-center gap-2" data-bs-toggle="modal" data-bs-target="#memberModal">
            <i class="bi bi-person-plus"></i> Register Member
          </button>
        </div>
      </div>
    </div>

    <main class="container-fluid py-4">
      <!-- Quick stats -->
      <section class="row g-3 mb-3">
        <div class="col-6 col-md-3">
          <div class="card stat">
            <div class="icon bg-primary-subtle text-primary"><i class="bi bi-people"></i></div>
            <div class="meta">
              <div class="label">Total Members</div>
              <div id="statTotal" class="value">0</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card stat">
            <div class="icon bg-success-subtle text-success"><i class="bi bi-person-check"></i></div>
            <div class="meta">
              <div class="label">Active</div>
              <div id="statActive" class="value">0</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card stat">
            <div class="icon bg-danger-subtle text-danger"><i class="bi bi-exclamation-triangle"></i></div>
            <div class="meta">
              <div class="label">With Overdue</div>
              <div id="statOverdue" class="value">0</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card stat">
            <div class="icon bg-warning-subtle text-warning"><i class="bi bi-box-arrow-in-down"></i></div>
            <div class="meta">
              <div class="label">Currently Borrowing</div>
              <div id="statBorrowing" class="value">0</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Filters -->
      <section class="card p-3 mb-3">
        <div class="row g-2">
          <div class="col-6 col-md-3">
            <label class="form-label">Status</label>
            <select id="filterStatus" class="form-select">
              <option value="">All</option>
              <option value="active">Active</option>
              <option value="disabled">Disabled</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Overdue</label>
            <select id="filterOverdue" class="form-select">
              <option value="">All</option>
              <option value="with">With Overdue</option>
              <option value="none">None</option>
            </select>
          </div>
          <div class="col-12 col-md-6 text-md-end">
            <div class="btn-group">
              <button id="btnExport" class="btn btn-outline-secondary"><i class="bi bi-download me-2"></i>Export CSV</button>
              <button id="btnDisable" class="btn btn-outline-warning">Disable</button>
              <button id="btnDelete" class="btn btn-outline-danger">Delete</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Members table -->
      <section class="card p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th style="width:38px"><input class="form-check-input" type="checkbox" id="checkAll"></th>
                <th>Name</th>
                <th class="d-none d-lg-table-cell">Student No.</th>
                <th>Course / Section</th>
                <th>Borrowed</th>
                <th>Overdue</th>
                <th>Status</th>
                <th class="text-end" style="width:140px">Actions</th>
              </tr>
            </thead>
            <tbody id="membersBody"><!-- JS --></tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center p-3 gap-2 flex-wrap">
          <div class="text-muted small" id="pageInfo">Showing 1–10 of 0</div>
          <nav><ul class="pagination pagination-sm mb-0" id="pager"></ul></nav>
        </div>
      </section>

      <!-- Empty state (when no results) -->
      <div id="emptyState" class="empty d-none">
        <i class="bi bi-people fs-2 d-block mb-2"></i>
        No members found.
      </div>
    </main>
  </div>

  <!-- Register / Edit Member Modal -->
  <div class="modal fade" id="memberModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form id="memberForm" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="memberModalTitle">Register Member</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Full Name</label>
              <input id="fName" type="text" class="form-control" required>
              <div class="invalid-feedback">Full name is required.</div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Email</label>
              <input id="fEmail" type="email" class="form-control" required>
              <div class="invalid-feedback">Valid email is required.</div>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Student No.</label>
              <input id="fStudNo" type="text" class="form-control" placeholder="e.g., 2025-12345" required>
              <div class="invalid-feedback">Student number is required.</div>
            </div>
            <div class="col-8 col-md-4">
              <label class="form-label">Course / Year</label>
              <input id="fCourseYear" type="text" class="form-control" placeholder="BSIT / 2" required>
              <div class="invalid-feedback">Course/Year is required.</div>
            </div>
            <div class="col-4 col-md-2">
              <label class="form-label">Section</label>
              <input id="fSection" type="text" class="form-control" placeholder="A" required>
              <div class="invalid-feedback">Section is required.</div>
            </div>
            <div class="col-12 col-md-2">
              <label class="form-label">Status</label>
              <select id="fStatus" class="form-select" required>
                <option value="active">Active</option>
                <option value="disabled">Disabled</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <input id="fNotes" type="text" class="form-control" placeholder="Optional notes…">
            </div>
            <input id="fId" type="hidden">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button id="btnSaveMember" class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Member (Field / Details sheet) -->
  <div class="modal fade" id="viewMemberModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content memberview">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title">Member Details</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body pt-0">
          <!-- Header -->
          <div class="mv-head">
            <div class="mv-avatar"><img id="mvAvatar" src="assets/img/default-avatar.png" alt=""></div>
            <div class="mv-id">
              <div class="mv-name" id="mvName">—</div>
              <div class="mv-email" id="mvEmail">—</div>
              <div class="mv-chips">
                <span id="mvStatus" class="chip chip-status">Active</span>
                <span id="mvBorrowedChip" class="chip chip-neutral"><i class="bi bi-book me-1"></i><span id="mvBorrowed">0</span> borrowed</span>
                <span id="mvOverdueChip" class="chip chip-danger d-none"><i class="bi bi-exclamation-triangle me-1"></i><span id="mvOverdue">0</span> overdue</span>
              </div>
            </div>
            <div class="mv-actions">
              <button class="btn btn-outline-primary btn-sm" id="mvEditBtn"><i class="bi bi-pencil me-1"></i>Edit</button>
              <button class="btn btn-outline-danger btn-sm" id="mvDeleteBtn"><i class="bi bi-trash3 me-1"></i>Delete</button>
            </div>
          </div>

          <!-- Sheet -->
          <div class="mv-sheet">
            <div class="mv-row mv-headrow">
              <div class="mv-col mv-field"><i class="bi bi-info-circle me-2"></i> Field</div>
              <div class="mv-col mv-value"><i class="bi bi-clipboard-check me-2"></i> Details</div>
            </div>

            <div class="mv-row"><div class="mv-col mv-field"><i class="bi bi-hash"></i> Student No.</div><div class="mv-col mv-value" id="mfStudNo">—</div></div>
            <div class="mv-row"><div class="mv-col mv-field"><i class="bi bi-mortarboard"></i> Course / Year</div><div class="mv-col mv-value" id="mfCourseYear">—</div></div>
            <div class="mv-row"><div class="mv-col mv-field"><i class="bi bi-collection"></i> Section</div><div class="mv-col mv-value" id="mfSection">—</div></div>
            <div class="mv-row"><div class="mv-col mv-field"><i class="bi bi-calendar-event"></i> Joined</div><div class="mv-col mv-value" id="mfJoined">—</div></div>
            <div class="mv-row"><div class="mv-col mv-field"><i class="bi bi-clock-history"></i> Last Active</div><div class="mv-col mv-value" id="mfLastActive">—</div></div>
            <div class="mv-row"><div class="mv-col mv-field"><i class="bi bi-card-text"></i> Notes</div><div class="mv-col mv-value" id="mfNotes">—</div></div>
          </div>
        </div>

        <div class="modal-footer border-0 pt-0">
          <button class="btn btn-light" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/sidebar.js"></script>
  <script>
    // Mount shared sidebar and highlight "Members"
    renderSidebar('members');
    document.getElementById('sidebarToggle')?.addEventListener('click', toggleSidebar);

    // ------------ Demo data (UI only; hook to PHP later) ------------
    let AUTOINC = 8;
    let members = [
      {id:1, name:"Juan Dela Cruz", email:"2025-12345@student.edu", studNo:"2025-12345", courseYear:"BSIT / 2", section:"B", borrowed:3, overdue:1, status:"active", joined:"2025-01-05T08:00:00Z"},
      {id:2, name:"Ana Santos",     email:"2025-10322@student.edu", studNo:"2025-10322", courseYear:"BSIT / 1", section:"A", borrowed:1, overdue:0, status:"active", joined:"2025-02-10T08:00:00Z"},
      {id:3, name:"Mark Reyes",     email:"2024-88231@student.edu", studNo:"2024-88231", courseYear:"BSCpE / 3", section:"C", borrowed:0, overdue:0, status:"disabled", joined:"2024-06-12T08:00:00Z", notes:"On leave"},
      {id:4, name:"Lea Cruz",       email:"2025-99877@student.edu", studNo:"2025-99877", courseYear:"BSIT / 1", section:"A", borrowed:2, overdue:0, status:"active", joined:"2025-03-01T08:00:00Z"},
    ];

    // ------------ Elements ------------
    const tbody = document.getElementById('membersBody');
    const empty = document.getElementById('emptyState');
    const search = document.getElementById('memberSearch');
    const filterStatus = document.getElementById('filterStatus');
    const filterOverdue = document.getElementById('filterOverdue');
    const checkAll = document.getElementById('checkAll');
    const pageInfo = document.getElementById('pageInfo');
    const pager = document.getElementById('pager');

    // Stats
    const statTotal = document.getElementById('statTotal');
    const statActive = document.getElementById('statActive');
    const statOverdue = document.getElementById('statOverdue');
    const statBorrowing = document.getElementById('statBorrowing');

    // Modals
    const memberModal = new bootstrap.Modal('#memberModal');
    const viewModal = new bootstrap.Modal('#viewMemberModal');

    // Form refs
    const fId = document.getElementById('fId');
    const fName = document.getElementById('fName');
    const fEmail = document.getElementById('fEmail');
    const fStudNo = document.getElementById('fStudNo');
    const fCourseYear = document.getElementById('fCourseYear');
    const fSection = document.getElementById('fSection');
    const fStatus = document.getElementById('fStatus');
    const fNotes = document.getElementById('fNotes');
    const memberModalTitle = document.getElementById('memberModalTitle');
    const form = document.getElementById('memberForm');

    // View refs
    const mvAvatar = document.getElementById('mvAvatar');
    const mvName = document.getElementById('mvName');
    const mvEmail = document.getElementById('mvEmail');
    const mvStatus = document.getElementById('mvStatus');
    const mvBorrowedChip = document.getElementById('mvBorrowedChip');
    const mvOverdueChip = document.getElementById('mvOverdueChip');
    const mvBorrowed = document.getElementById('mvBorrowed');
    const mvOverdue = document.getElementById('mvOverdue');
    const mvEditBtn = document.getElementById('mvEditBtn');
    const mvDeleteBtn = document.getElementById('mvDeleteBtn');

    const mfStudNo = document.getElementById('mfStudNo');
    const mfCourseYear = document.getElementById('mfCourseYear');
    const mfSection = document.getElementById('mfSection');
    const mfJoined = document.getElementById('mfJoined');
    const mfLastActive = document.getElementById('mfLastActive');
    const mfNotes = document.getElementById('mfNotes');

    // ------------ Helpers ------------
    const pageSize = 10;
    let currentPage = 1;

    function applyFilters(){
      const q = (search.value||"").toLowerCase().trim();
      const st = filterStatus.value;
      const od = filterOverdue.value;

      return members.filter(m=>{
        const hit = (m.name+" "+m.email+" "+m.studNo).toLowerCase().includes(q);
        const stOk = st ? m.status===st : true;
        const odOk = od==="with" ? m.overdue>0 : od==="none" ? m.overdue===0 : true;
        return hit && stOk && odOk;
      });
    }

    function render(){
      const list = applyFilters();
      updateStats();

      const total = list.length;
      const pages = Math.max(1, Math.ceil(total/pageSize));
      if (currentPage > pages) currentPage = pages;

      const start = (currentPage-1)*pageSize;
      const end = Math.min(start+pageSize, total);
      const slice = list.slice(start, end);

      empty.classList.toggle('d-none', !!slice.length);
      tbody.innerHTML = slice.map(rowHtml).join('');
      pageInfo.textContent = `Showing ${total? start+1:0}–${end} of ${total}`;

      // pager
      pager.innerHTML = '';
      const addItem = (label, page, disabled=false, active=false) =>{
        const li = document.createElement('li');
        li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
        li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
        li.onclick = (e)=>{ e.preventDefault(); if(!disabled){ currentPage=page; render(); } };
        pager.appendChild(li);
      };
      addItem('«',1,currentPage===1); addItem('‹',Math.max(1,currentPage-1),currentPage===1);
      for(let p=1;p<=pages;p++) addItem(p,p,false,p===currentPage);
      addItem('›',Math.min(pages,currentPage+1),currentPage===pages); addItem('»',pages,currentPage===pages);

      checkAll.checked = false;
    }

    function rowHtml(m){
      const statusBadge = m.status === 'active'
        ? `<span class="badge text-bg-success-soft">Active</span>`
        : `<span class="badge text-bg-danger-soft">Disabled</span>`;
      const odBadge = m.overdue>0
        ? `<span class="badge text-bg-danger-soft">${m.overdue}</span>`
        : `<span class="badge text-bg-success-soft">0</span>`;

      return `
      <tr>
        <td><input class="form-check-input row-check" type="checkbox" value="${m.id}"></td>
        <td>
          <div class="d-flex align-items-center gap-2">
            <img class="avatar" src="assets/img/default-avatar.png" alt="">
            <div>
              <div class="fw-medium">${escapeHtml(m.name)}</div>
              <div class="small text-muted d-lg-none">${escapeHtml(m.studNo)}</div>
            </div>
          </div>
        </td>
        <td class="d-none d-lg-table-cell">${escapeHtml(m.studNo)}</td>
        <td>${escapeHtml(m.courseYear)} • ${escapeHtml(m.section)}</td>
        <td>${m.borrowed}</td>
        <td>${odBadge}</td>
        <td>${statusBadge}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" title="View" onclick="viewMember(${m.id})"><i class="bi bi-eye"></i></button>
            <button class="btn btn-outline-primary" title="Edit" onclick="editMember(${m.id})"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-outline-danger" title="Delete" onclick="deleteMember(${m.id})"><i class="bi bi-trash3"></i></button>
          </div>
        </td>
      </tr>`;
    }

    function escapeHtml(s){return String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]))}

    function updateStats(){
      const total = members.length;
      const active = members.filter(m=>m.status==='active').length;
      const overdue = members.filter(m=>m.overdue>0).length;
      const borrowing = members.reduce((sum,m)=>sum + (m.borrowed||0),0);

      statTotal.textContent = total;
      statActive.textContent = active;
      statOverdue.textContent = overdue;
      statBorrowing.textContent = borrowing;
    }

    // ---------- Events ----------
    search.addEventListener('input', ()=>{ currentPage=1; render(); });
    filterStatus.addEventListener('change', ()=>{ currentPage=1; render(); });
    filterOverdue.addEventListener('change', ()=>{ currentPage=1; render(); });

    checkAll.addEventListener('change', ()=>{
      document.querySelectorAll('.row-check').forEach(cb => cb.checked = checkAll.checked);
    });

    document.getElementById('btnDisable').onclick = ()=>{
      const ids = selectedIds(); if(!ids.length) return alert('Select members first.');
      members = members.map(m => ids.includes(m.id)? {...m, status:'disabled'} : m);
      render();
    };
    document.getElementById('btnDelete').onclick = ()=>{
      const ids = selectedIds(); if(!ids.length) return alert('Select members first.');
      if(!confirm('Delete selected members?')) return;
      members = members.filter(m => !ids.includes(m.id));
      render();
    };
    document.getElementById('btnExport').onclick = ()=>{
      const rows = applyFilters().map(m => [m.id,m.name,m.email,m.studNo,m.courseYear,m.section,m.borrowed,m.overdue,m.status]);
      const csv = ["id,name,email,studentNo,courseYear,section,borrowed,overdue,status", ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(","))].join("\n");
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
      a.download = "members.csv"; a.click(); URL.revokeObjectURL(a.href);
    };

    function selectedIds(){
      const ids=[]; document.querySelectorAll('.row-check:checked').forEach(cb=>ids.push(Number(cb.value))); return ids;
    }

    // ---------- Register / Edit ----------
    document.getElementById('memberModal').addEventListener('hidden.bs.modal', ()=>{
      form.reset(); form.classList.remove('was-validated'); fId.value="";
      memberModalTitle.textContent = "Register Member";
    });

    form.addEventListener('submit', (e)=>{
      e.preventDefault(); form.classList.add('was-validated');
      if(!form.checkValidity()) return;

      const model = {
        id: fId.value? Number(fId.value) : AUTOINC++,
        name: fName.value.trim(),
        email: fEmail.value.trim(),
        studNo: fStudNo.value.trim(),
        courseYear: fCourseYear.value.trim(),
        section: fSection.value.trim(),
        status: fStatus.value,
        notes: fNotes.value.trim(),
        borrowed: 0, overdue: 0,
        joined: new Date().toISOString()
      };

      const exists = members.find(m=>m.id===model.id);
      if(exists){ members = members.map(m=>m.id===model.id? model : m); }
      else{ members.unshift(model); }

      memberModal.hide(); currentPage=1; render();
    });

    window.editMember = function(id){
      const m = members.find(x=>x.id===id); if(!m) return;
      memberModalTitle.textContent = "Edit Member";
      fId.value = m.id; fName.value = m.name; fEmail.value = m.email; fStudNo.value = m.studNo;
      fCourseYear.value = m.courseYear; fSection.value = m.section; fStatus.value = m.status; fNotes.value = m.notes||"";
      memberModal.show();
    };

    window.deleteMember = function(id){
      if(!confirm('Delete this member?')) return;
      members = members.filter(m=>m.id!==id); render();
    };

    // ---------- View (Field/Details) ----------
    window.viewMember = function(id){
      const m = members.find(x=>x.id===id); if(!m) return;

      mvAvatar.src = 'assets/img/default-avatar.png';
      mvName.textContent = m.name; mvEmail.textContent = m.email;

      mvStatus.textContent = m.status==='active' ? 'Active' : 'Disabled';
      mvStatus.className = 'chip chip-status ' + (m.status==='active' ? '' : 'disabled');

      mvBorrowed.textContent = m.borrowed; mvOverdue.textContent = m.overdue;
      mvOverdueChip.classList.toggle('d-none', m.overdue<=0);

      mfStudNo.textContent = m.studNo;
      mfCourseYear.textContent = m.courseYear;
      mfSection.textContent = m.section;
      mfJoined.textContent = m.joined ? new Date(m.joined).toLocaleString() : '—';
      mfLastActive.textContent = m.lastActive ? new Date(m.lastActive).toLocaleString() : '—';
      mfNotes.textContent = m.notes || '—';

      mvEditBtn.onclick = ()=>{ viewModal.hide(); editMember(m.id); };
      mvDeleteBtn.onclick = ()=>{ viewModal.hide(); deleteMember(m.id); };

      viewModal.show();
    };

    // Init
    render();
  </script>
</body>
</html>
