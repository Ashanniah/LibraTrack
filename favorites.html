<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LibraTrack — My Favorites</title>

  <!-- Fonts & Vendor -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

  <!-- App CSS -->
  <link href="assets/css/sidebar.css" rel="stylesheet">
  <link href="assets/css/responsive.css" rel="stylesheet">
  <link rel="icon" href="assets/img/logo.png" type="image/png">

  <style>
    :root{
      --card-pad:24px;
      --cell-pad-y:14px;
      --cell-pad-x:20px;
      --ui-muted:#6b7280;
      --ui-border:#eef0f3;
      --ui-soft:#f6f7f9;
      --brand-black:#111827;
      --brand-gold:#a68604;
      --gold-dark:#8d7003;
      --sidebar-bg:#111;
      --text-primary:#212529;
      --text-secondary:#6b7280;
      --border-radius:12px;
      --border-radius-sm:8px;
      --border-radius-lg:16px;
      --shadow-sm:0 2px 4px rgba(0,0,0,.04);
      --shadow-md:0 4px 12px rgba(0,0,0,.08);
      --shadow-lg:0 6px 18px rgba(0,0,0,.12);
      --header-bg:#fff;
      --table-header-bg:#fff;
      --card-border:#e5e7eb;
    }
    html{font-size:14px;}
    body{font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"}
    main.container-fluid{padding:24px!important}

    /* Header Styling */
    .admin-header-gold{
      background:#fff!important;
      border-bottom:1px solid var(--card-border);
      padding:12px 24px;
    }
    .admin-header-gold .fw-bold,
    .admin-header-gold .h5,
    .admin-header-gold #pageTitle {
      color: var(--text-primary) !important;
      font-weight:700;
      font-size:1.25rem;
      letter-spacing:0.01em;
    }
    .search-bar-custom {
      height: 42px;
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius-sm);
      background: #fff;
      overflow: hidden;
    }
    .search-bar-custom .input-group-text,
    .search-bar-custom .form-control {
      height: 42px;
      padding: 10px 16px;
      font-size:0.875rem;
      border: none !important;
      background: transparent !important;
    }
    .search-bar-custom .input-group-text {
      color: var(--text-secondary);
      padding-left: 16px;
      padding-right: 8px;
    }
    .search-bar-custom .form-control {
      color: var(--text-primary);
      padding-left: 8px;
      padding-right: 16px;
    }
    .search-bar-custom .form-control::placeholder {
      color: var(--text-secondary);
    }
    .search-bar-custom:focus-within {
      box-shadow: 0 0 0 3px rgba(166,134,4,0.15);
      border-color: var(--brand-gold);
    }
    .search-bar-custom:focus-within .input-group-text {
      color: var(--text-primary);
    }
    .admin-btn-custom{
      padding:0;
      width:44px;
      height:44px;
      border-radius:50%;
      border:1px solid var(--card-border);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s ease;
      overflow:hidden;
    }
    .admin-btn-custom:hover{
      border-color:var(--brand-gold);
      box-shadow:0 0 0 2px rgba(166,134,4,0.1);
    }
    .avatar-32 {
      width:32px;
      height:32px;
      border-radius:50%;
      object-fit:cover;
    }

    /* Card Styling */
    .card {
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      background: #fff;
    }
    .fav-header{ 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:12px;
      padding: 20px 24px;
      border-bottom: 1px solid var(--card-border);
    }
    .fav-header h5{ 
      margin:0; 
      font-weight:700;
      color: #fff;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: var(--sidebar-bg);
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .fav-header h5 i {
      color: #fff;
      font-size: 1rem;
    }
    .card-body {
      padding: 24px;
    }
    .subtle{ color:var(--text-secondary); }
    .grid-wrap{ 
      display:flex; 
      flex-wrap:wrap; 
      gap:16px;
    }
    .grid-item{ 
      flex:0 0 auto; 
      width: 180px;
      min-width: 180px;
    }
    .book-card {
      background: #fff;
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      transition: all 0.3s ease;
      padding: 16px;
      width: 180px;
      min-width: 180px;
      box-shadow: var(--shadow-sm);
    }
    .book-card:hover {
      box-shadow: 0 8px 24px rgba(166, 134, 4, 0.15);
      transform: translateY(-4px);
      border-color: var(--brand-gold);
    }
    .cover-wrap {
      position: relative;
      width: 100%;
      overflow: hidden;
      background: #f9fafb;
      border-radius: 12px;
    }
    .cover-wrap img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 12px;
    }
    .btn-fav {
      --fav-size: 30px;
      position: absolute;
      top: 8px;
      right: 8px;
      width: var(--fav-size);
      height: var(--fav-size);
      border-radius: 50% !important;
      border: 1px solid rgba(2, 6, 23, .08);
      background: rgba(255,255,255,.96);
      backdrop-filter: saturate(180%) blur(4px);
      box-shadow: 0 2px 6px rgba(15,23,42,.10);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 2;
      padding: 0;
      box-sizing: border-box;
    }
    .btn-fav:hover {
      background: #fff;
      transform: scale(1.05);
    }
    .btn-fav i {
      display: block !important;
      line-height: 0 !important;
      font-size: 18px;
      transform: translateY(1.5px);
      pointer-events: none;
      vertical-align: middle !important;
    }
    .btn-fav .bi-heart-fill {
      color: #dc2626 !important;
    }
    .book-card .title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 1.05rem;
      margin-top: 12px;
      margin-bottom: 4px;
      line-height: 1.3;
    }
    .book-card .meta {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }

    /* Empty State */
    .empty {
      padding: 48px 24px;
      text-align: center;
      color: var(--text-secondary);
    }
    .empty i {
      opacity: 0.3;
      margin-bottom: 12px;
    }
    .empty a {
      color: var(--brand-gold);
      text-decoration: none;
      font-weight: 600;
    }
    .empty a:hover {
      text-decoration: underline;
    }

    /* Drawer Styling - Similar to Librarian */
    .request-drawer { 
      width: 520px; 
      max-width: 90vw; 
    }
    .request-drawer .offcanvas-header {
      background: var(--sidebar-bg);
      color: #fff;
      border-bottom: none;
      padding: 24px;
    }
    .request-drawer .offcanvas-title {
      color: #fff;
      font-weight: 700;
      font-size: 1.25rem;
    }
    .request-drawer .offcanvas-header .btn-close {
      filter: invert(1) grayscale(1);
      opacity: 0.8;
    }
    .request-drawer .offcanvas-body { 
      padding: 24px;
      background: #fff;
    }
    .book-cover-small { 
      width: 100px; 
      height: 140px; 
      object-fit: cover; 
      border-radius: var(--border-radius-sm);
      background: #f3f4f6;
      box-shadow: var(--shadow-sm);
    }
    .request-section {
      margin-bottom: 28px;
    }
    .request-section:last-child {
      margin-bottom: 0;
    }
    .request-section-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: var(--sidebar-bg);
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
    }
    .request-section-title i {
      color: #fff;
      font-size: 1rem;
    }
    .book-info-card {
      background: #f8f9fa;
      border-radius: var(--border-radius);
      padding: 16px;
      border: 1px solid var(--ui-border);
    }
    .book-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .book-meta {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .book-meta i {
      color: var(--text-secondary);
      font-size: 0.875rem;
      width: 16px;
    }
    .info-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid var(--ui-border);
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
      min-width: 120px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .info-label i {
      color: var(--text-secondary);
      font-size: 0.875rem;
      width: 16px;
    }
    .info-value {
      color: var(--text-primary);
      font-size: 0.9375rem;
      font-weight: 500;
    }

    /* Browse Books Button */
    .btn-browse {
      background: var(--brand-gold);
      border-color: var(--brand-gold);
      color: #fff;
      font-weight: 600;
      padding: 8px 20px;
      border-radius: var(--border-radius-sm);
      transition: all 0.2s ease;
    }
    .btn-browse:hover {
      background: var(--gold-dark);
      border-color: var(--gold-dark);
      color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(166,134,4,0.3);
    }

    /* Category Chips - Same as Books Page */
    .chips-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 8px 0;
    }
    .chip {
      border: 1px solid var(--card-border);
      background: #fff;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      font-family: "Times New Roman", Times, serif;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .chip:hover {
      background: #f9fafb;
      border-color: #111;
      color: var(--text-primary);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chip.active {
      background: #111 !important;
      color: #fff !important;
      border-color: #111 !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
    }

    /* Section Spacing */
    .section-spacing {
      margin-top: 32px;
    }
    .section-spacing:first-child {
      margin-top: 0;
    }

    /* Skeleton Loaders */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
    }
    @keyframes skeleton-shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-book-card {
      animation: skeleton-pulse 1.5s ease-in-out infinite;
    }
    @keyframes skeleton-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .skeleton-cover {
      width: 100%;
      height: 220px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 12px;
    }
    .skeleton-line {
      height: 16px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .skeleton-line.short {
      width: 60%;
    }
    .skeleton-line.medium {
      width: 80%;
    }
    .skeleton-line.long {
      width: 100%;
    }
    .skeleton-line.thin {
      height: 12px;
      width: 50%;
    }
    .skeleton-count {
      display: inline-block;
      width: 80px;
      height: 16px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .btn:disabled,
    .form-control:disabled,
    .chip:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background-color: #e9ecef;
      pointer-events: none;
    }
  </style>
</head>
<body class="sb-body">
  <div id="sidebar-root"></div>

  <div class="sb-wrapper">
    <nav class="sb-topbar navbar navbar-expand sticky-top admin-header-gold">
      <div class="container-fluid">
        <button id="sidebarToggle" class="btn btn-link text-dark me-2" aria-label="Toggle sidebar">
          <i class="bi bi-list fs-4"></i>
        </button>
        <div class="fw-bold h5 mb-0" id="pageTitle">My Favorites</div>

        <div class="ms-auto d-flex align-items-center gap-2">
          <form class="d-none d-md-flex" role="search" style="max-width:520px;width:100%;">
            <div class="input-group search-bar-custom">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input id="favoritesSearch" class="form-control" type="search" placeholder="Search favorites">
            </div>
          </form>

          <div class="dropdown position-relative">
          <div class="dropdown">
            <button id="userBtn" class="btn admin-btn-custom" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="assets/img/default-avatar.png" alt="User" class="avatar-32">
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="student-profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <main class="container-fluid py-4">
      <div class="card">
        <div class="fav-header">
          <div>
            <h5 class="m-0"><i class="bi bi-heart"></i> Books you've favorited</h5>
            <div id="countLine" class="subtle small mt-2"></div>
          </div>
          <a href="books.html" class="btn btn-browse"><i class="bi bi-book me-1"></i>Browse books</a>
        </div>

        <div class="card-body">
          <!-- Categories Section -->
          <div class="mb-3">
            <span class="badge" style="background:var(--brand-gold); color:#fff; padding:8px 16px; font-size:0.875rem; font-weight:600; border-radius:999px;">Categories</span>
          </div>
          <div id="catChips" class="chips-container mb-4"></div>

          <!-- Grid -->
          <div class="section-spacing">
            <div class="mb-3">
              <span class="badge" style="background:var(--brand-gold); color:#fff; padding:8px 16px; font-size:0.875rem; font-weight:600; border-radius:999px;">Book List Grid</span>
            </div>
            <div id="grid" class="grid-wrap"></div>

            <!-- Empty state -->
            <div id="empty" class="empty d-none">
              <i class="bi bi-heart fs-1 d-block mb-2"></i>
              <p class="mb-2">You have no favorites yet.</p>
              <p class="mb-0">Go to <a href="books.html">Books</a> and tap the heart to add some.</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Offcanvas: book details -->
  <div class="offcanvas offcanvas-end request-drawer" tabindex="-1" id="bookDetails" aria-labelledby="bookDetailsLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="bookDetailsLabel">Book</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body" id="detailsBody"></div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="toastInfo" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body"><i class="bi bi-check2-circle me-2"></i><span id="toastMsg">Updated.</span></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/logout.js"></script>
  <script src="assets/js/sidebar.js?v=2025-11-19-FINAL-NO-SEARCH-NO-NOTIFICATIONS-V2"></script>
  <script>
    // === Helpers ===
    const esc = (s='') => s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toast = new bootstrap.Toast(document.getElementById('toastInfo'));
    const toastMsg = document.getElementById('toastMsg');

    function showToast(msg){ toastMsg.textContent = msg; toast.show(); }

    // Logout - handled by logout.js (confirmation dialog)

    async function getMe(){
      try{
        const r = await fetch('/api/check-auth', {credentials:'include'});
        const d = await r.json().catch(()=>null);
        return d?.user || null;
      }catch{ return null; }
    }

    // === Page init ===
    (async ()=>{
      const me = await getMe();
      const role = (me?.role || 'student').toLowerCase();
      if (typeof renderSidebar === 'function') renderSidebar('favorites', role);
      
      // Load avatar if available
      const headerAvatar = document.querySelector('#userBtn img.avatar-32');
      if (headerAvatar && me?.avatar && me.avatar.trim() !== '') {
        headerAvatar.src = me.avatar;
      }
      
      document.getElementById('sidebarToggle')?.addEventListener('click', ()=>{
        if (typeof toggleSidebar === 'function') toggleSidebar(); else document.body.classList.toggle('sb-expanded');
      });

      // Search functionality
      const searchInput = document.getElementById('favoritesSearch');
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
          if (isLoading) return;
          
          clearTimeout(searchTimeout);
          const query = e.target.value.trim();
          searchTimeout = setTimeout(() => {
            filterBySearch(query);
          }, 300);
        });
      }

      await loadFavorites();
    })();

    function filterBySearch(query) {
      if (isLoading) return;
      
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      
      // Show skeleton while filtering (only if we have data to filter)
      if (allFavorites.length > 0) {
        grid.innerHTML = renderSkeletonCards(4);
        empty.classList.add('d-none');
        setLoadingState(true);
        
        // Small delay for smooth transition
        setTimeout(() => {
          // Filter by search query in addition to category filter
          let filtered = allFavorites;
          if (favoritesState.category) {
            filtered = allFavorites.filter(b => b.category === favoritesState.category);
          }
          
          if (query) {
            filtered = filtered.filter(b => {
              const searchText = `${b.title} ${b.author} ${b.category} ${b.isbn || ''}`.toLowerCase();
              return searchText.includes(query);
            });
          }
          
          empty.classList.toggle('d-none', filtered.length > 0);
          grid.innerHTML = filtered.length ? filtered.map(b => {
            const card = renderCard(b);
            return card.replace('<div class="grid-item">', '<div class="grid-item fade-in">');
          }).join('') : '';
          
          // Rebind unfavorite buttons
          bindUnfavoriteButtons();
          setLoadingState(false);
        }, 100);
      } else {
        // No data to filter, just show empty state
        empty.classList.remove('d-none');
        grid.innerHTML = '';
      }
    }

    // === API routes ===
    const API_FAVORITES = '/api/favorites';
    const API_TOGGLE    = '/api/favorites/toggle';

    // === State ===
    let favoritesState = { category: '' };
    let allFavorites = [];
    let isLoading = false;

    // Render skeleton book cards
    function renderSkeletonCards(count = 4) {
      return Array.from({length: count}, () => `
        <div class="grid-item">
          <div class="book-card skeleton-book-card">
            <div class="cover-wrap position-relative">
              <div class="skeleton-cover"></div>
            </div>
            <div class="title">
              <div class="skeleton-line medium"></div>
            </div>
            <div class="meta">
              <div class="skeleton-line short"></div>
            </div>
            <div class="meta">
              <div class="skeleton-line thin"></div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Disable/enable interactions during loading
    function setLoadingState(loading) {
      isLoading = loading;
      
      // Disable category chips
      const chips = document.querySelectorAll('#catChips .chip');
      chips.forEach(chip => {
        chip.disabled = loading;
      });
      
      // Disable search input
      const searchInput = document.getElementById('favoritesSearch');
      if (searchInput) {
        searchInput.disabled = loading;
      }
      
      // Disable browse books button
      const browseBtn = document.querySelector('.btn-browse');
      if (browseBtn) {
        browseBtn.disabled = loading;
      }
    }

    // === Category Chips ===
    function renderChips() {
      const container = document.getElementById('catChips');
      if (!container) return;

      // Get unique categories from all favorites
      const categories = ['All', ...new Set(allFavorites.map(b => b.category).filter(c => c && c.trim()))].sort();
      
      container.innerHTML = categories.map(cat => {
        const v = cat === 'All' ? '' : cat;
        return `<button class="chip ${favoritesState.category === v ? 'active' : ''}" data-cat="${v}" ${isLoading ? 'disabled' : ''}>${cat}</button>`;
      }).join('');

      container.querySelectorAll('.chip').forEach(btn => {
        btn.addEventListener('click', () => {
          if (isLoading) return;
          favoritesState.category = btn.dataset.cat || '';
          filterFavorites();
          renderChips();
        });
      });
    }

    function filterFavorites() {
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      
      // Show skeleton while filtering (only if we have data to filter)
      if (allFavorites.length > 0) {
        grid.innerHTML = renderSkeletonCards(4);
        empty.classList.add('d-none');
        setLoadingState(true);
        
        // Small delay for smooth transition
        setTimeout(() => {
          let filtered = allFavorites;
          if (favoritesState.category) {
            filtered = allFavorites.filter(b => b.category === favoritesState.category);
          }

          empty.classList.toggle('d-none', filtered.length > 0);
          grid.innerHTML = filtered.length ? filtered.map(b => {
            const card = renderCard(b);
            return card.replace('<div class="grid-item">', '<div class="grid-item fade-in">');
          }).join('') : '';

          // Rebind unfavorite buttons
          bindUnfavoriteButtons();
          setLoadingState(false);
        }, 100);
      } else {
        // No data to filter, just show empty state
        empty.classList.remove('d-none');
        grid.innerHTML = '';
      }
    }

    // === Rendering ===
    function renderCard(b){
      const cover = b.cover_url || 'assets/img/no-cover.png';
      const t = esc(b.title||''), a = esc(b.author||'');
      const c = esc(b.category||''), i = esc(b.isbn||'');
      return `
        <div class="grid-item">
          <div class="book-card">
            <div class="cover-wrap position-relative" role="button" onclick='showDetails(${JSON.stringify(b).replace(/'/g,"&#39;")})'>
              <img src="${cover}" alt="${t}" onerror="this.src='assets/img/no-cover.png'; this.onerror=null;">
              <button class="btn-fav active" title="Remove from favorites" data-id="${b.id}">
                <i class="bi bi-heart-fill text-danger"></i>
              </button>
            </div>
            <div class="title text-truncate" title="${t}">${t}</div>
            <div class="meta text-truncate">${a||'Unknown author'}</div>
            <div class="meta">${c}${c&&i?' • ':''}${i?('ISBN: '+i):''}</div>
          </div>
        </div>`;
    }

    function bindUnfavoriteButtons() {
      const grid = document.getElementById('grid');
      const countLine = document.getElementById('countLine');
      
      grid.querySelectorAll('.btn-fav').forEach(btn => {
        btn.onclick = async (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const icon = btn.querySelector('i');
          
          // Optimistically update UI immediately (before API call)
          // Directly set classes instead of toggling to avoid border heart flash
          if (icon) {
            icon.className = 'bi bi-heart';
          }
          btn.title = 'Add to favorites';
          
          try {
            const r = await fetch(API_TOGGLE, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ book_id: id })
            });
            const out = await r.json().catch(() => null);
            if (out?.ok) {
              // remove from allFavorites array
              allFavorites = allFavorites.filter(b => String(b.id) !== String(id));
              
              // Update count
              const totalCount = allFavorites.length;
              countLine.textContent = `${totalCount} favorite${totalCount === 1 ? '' : 's'}`;
              
              // Refresh chips and filter
              renderChips();
              filterFavorites();
              
              showToast('Removed from favorites');
            } else {
              // Revert on error
              if (icon) {
                icon.className = 'bi bi-heart-fill text-danger';
              }
              btn.title = 'Remove from favorites';
              alert(out?.error || 'Failed to update favorite.');
            }
          } catch {
            // Revert on error
            if (icon) {
              icon.className = 'bi bi-heart-fill text-danger';
            }
            btn.title = 'Remove from favorites';
            alert('Network error.');
          }
        };
      });
    }

    async function loadFavorites(){
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      const countLine = document.getElementById('countLine');
      
      // Show skeleton loading
      grid.innerHTML = renderSkeletonCards(4);
      empty.classList.add('d-none');
      countLine.innerHTML = '<span class="skeleton-count"></span>';
      setLoadingState(true);

      let data = null;
      try{
        const res = await fetch(API_FAVORITES, {credentials:'include'});
        data = await res.json();
      }catch{
        grid.innerHTML = '<div class="empty w-100">Failed to load favorites.</div>';
        countLine.textContent = '0 favorites';
        setLoadingState(false);
        return;
      }

      if (!data?.ok){
        grid.innerHTML = `<div class="empty w-100">${data?.error || 'Failed to load favorites.'}</div>`;
        countLine.textContent = '0 favorites';
        setLoadingState(false);
        return;
      }

      allFavorites = data.items || [];
      countLine.textContent = `${allFavorites.length} favorite${allFavorites.length===1?'':'s'}`;
      
      // Render chips and filter
      renderChips();
      filterFavorites();
    }

    // details offcanvas (similar to librarian/book details)
    window.showDetails = function(b){
      const cover = b.cover_url || 'assets/img/no-cover.png';
      const quantityStatus = (b.quantity ?? 0) > 5 ? 'success' : (b.quantity ?? 0) > 0 ? 'warning' : 'danger';
      const quantityText = (b.quantity ?? 0) > 5 ? 'In Stock' : (b.quantity ?? 0) > 0 ? 'Low Stock' : 'Out of Stock';
      
      const body = `
        <!-- Book Information -->
        <div class="request-section">
          <div class="request-section-title">
            <i class="bi bi-journal-text"></i> Book Information
          </div>
          <div class="book-info-card">
            <div class="d-flex gap-3 mb-3">
              <img src="${cover}" alt="${esc(b.title)}" class="book-cover-small" onerror="this.src='assets/img/no-cover.png'; this.onerror=null;">
              <div class="flex-grow-1">
                <div class="book-title">${esc(b.title||'')}</div>
                <div class="book-meta">
                  <i class="bi bi-person"></i> ${esc(b.author||'—')}
                </div>
                <div class="book-meta">
                  <i class="bi bi-tag"></i> ${esc(b.category||'—')}
                </div>
                ${b.isbn ? `<div class="book-meta">
                  <i class="bi bi-upc-scan"></i> ISBN: ${esc(b.isbn)}
                </div>` : ''}
                <div class="mt-2">
                  <span class="badge" style="background:${quantityStatus === 'success' ? '#d1fae5' : quantityStatus === 'warning' ? '#fef3c7' : '#fee2e2'}; color:${quantityStatus === 'success' ? '#065f46' : quantityStatus === 'warning' ? '#92400e' : '#991b1b'}; font-weight:600; padding:6px 12px;">
                    <i class="bi bi-box-seam me-1"></i>Quantity: ${b.quantity??0} (${quantityText})
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Publishing Details -->
        <div class="request-section">
          <div class="request-section-title">
            <i class="bi bi-info-circle"></i> Publishing Details
          </div>
          <div class="info-row">
            <div class="info-label">
              <i class="bi bi-calendar3"></i> Published
            </div>
            <div class="info-value">${b.published_at ? new Date(b.published_at).toLocaleDateString() : '—'}</div>
          </div>
          <div class="info-row">
            <div class="info-label">
              <i class="bi bi-building"></i> Publisher
            </div>
            <div class="info-value">${esc(b.publisher||'—')}</div>
          </div>
        </div>
      `;
      document.getElementById('bookDetailsLabel').textContent = b.title || 'Book';
      document.getElementById('detailsBody').innerHTML = body;
      bootstrap.Offcanvas.getOrCreateInstance('#bookDetails').show();
    };
  </script>
</body>
</html>
