<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>LibraTrack – System Logs</title>
	<link rel="icon" href="assets/img/LibraTrack-logo.png">
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="assets/vendor/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/vendor/bootstrap-icons/bootstrap-icons.css">
	<link rel="stylesheet" href="assets/css/sidebar.css">`n  <link href="assets/css/responsive.css" rel="stylesheet">
	<style>
		:root{
			--gold:#a68604;
			--gold-dark:#8d7003;
			--sidebar-bg:#111;
			--card-bg:#fff;
			--card-border:#e5e7eb;
			--text-primary:#212529;
			--text-secondary:#6b7280;
			--text-muted:#9ca3af;
			--header-bg:#fff;
			--table-header-bg:#f8f9fa;
			--border-radius:12px;
			--border-radius-sm:8px;
			--border-radius-lg:16px;
			--shadow-sm:0 2px 4px rgba(0,0,0,.04);
			--shadow-md:0 4px 12px rgba(0,0,0,.08);
			--shadow-lg:0 6px 18px rgba(0,0,0,.12);
		}
		
		/* Consistent Header Design */
		.admin-header-gold {
			background: var(--header-bg) !important;
			color: var(--text-primary) !important;
			border-bottom:1px solid var(--card-border);
			box-shadow:var(--shadow-sm);
			padding:12px 0;
		}
		.admin-header-gold .fw-bold,
		.admin-header-gold .h5,
		.admin-header-gold #pageTitle {
			color: var(--text-primary) !important;
			font-weight:700;
			font-size:1.25rem;
			letter-spacing:0.01em;
		}
		.admin-header-gold .btn-link {
			color: var(--text-primary) !important;
			padding:8px 12px;
			border-radius:var(--border-radius-sm);
			transition:all 0.2s ease;
		}
		.admin-header-gold .btn-link:hover {
			color: var(--text-primary) !important;
			background-color:#f8f9fa;
		}
		
		/* Consistent Search Bar Design */
		.search-bar-custom {
			height: 42px;
		}
		.search-bar-custom .input-group-text,
		.search-bar-custom .form-control {
			height: 42px;
			padding: 10px 16px;
			font-size:0.875rem;
		}
		.search-bar-custom .input-group-text {
			border-top-left-radius: var(--border-radius-sm);
			border-bottom-left-radius: var(--border-radius-sm);
			background: var(--table-header-bg) !important;
			border: 1px solid var(--card-border);
			border-right: none !important;
			outline: none !important;
			color:var(--text-secondary);
		}
		.search-bar-custom .form-control {
			border-top-right-radius: var(--border-radius-sm);
			border-bottom-right-radius: var(--border-radius-sm);
			background: var(--table-header-bg) !important;
			border: 1px solid var(--card-border);
			border-left: none !important;
			color: var(--text-primary);
			outline: none !important;
			box-shadow: none !important;
		}
		.search-bar-custom .form-control:focus {
			outline: none !important;
			box-shadow: none !important;
			border-color: var(--card-border) !important;
		}
		.search-bar-custom .form-control::placeholder {
			color: var(--text-muted);
		}
		.search-bar-custom:focus-within {
			box-shadow: 0 0 0 3px rgba(166, 134, 4, 0.15);
			border-radius: var(--border-radius-sm);
		}
		.search-bar-custom:focus-within .input-group-text {
			border-color: var(--gold);
			border-right: none !important;
			background: #fff !important;
		}
		.search-bar-custom:focus-within .form-control {
			border-color: var(--gold);
			border-left: none !important;
			background: #fff !important;
		}
		
		/* Consistent Admin Button - Avatar */
		.admin-btn-custom {
			padding: 0;
			width: 44px;
			height: 44px;
			border-radius: var(--border-radius-sm);
			border: 1px solid var(--card-border);
			background: #fff;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
		}
		.admin-btn-custom:hover {
			border-color: var(--gold);
			box-shadow: 0 0 0 2px rgba(166, 134, 4, 0.1);
		}
		.admin-btn-custom:focus,
		.admin-btn-custom:active,
		.admin-btn-custom.show {
			border-color: var(--gold) !important;
			box-shadow: 0 0 0 0.2rem rgba(166, 134, 4, 0.25) !important;
		}
		.admin-btn-custom img {
			width: 32px;
			height: 32px;
			border-radius: 50%;
			object-fit: cover;
		}
		
		/* Notification Button */
		.notification-btn{
			color:var(--text-primary) !important;
			padding:8px 12px;
			border-radius:var(--border-radius-sm);
			transition:all 0.2s ease;
		}
		.notification-btn:hover{
			color:var(--text-primary) !important;
			background-color:#f8f9fa;
		}
		.notification-badge{
			font-size:0.6875rem;
			padding:3px 7px;
			font-weight:600;
			background:var(--gold) !important;
			color:#fff !important;
		}
		.notification-dropdown{
			border-radius:var(--border-radius);
			box-shadow:var(--shadow-lg);
			border:1px solid var(--card-border);
			margin-top:8px;
		}
		
		/* Consistent Card Design */
		.card{
			border-radius:var(--border-radius-lg);
			border:1px solid var(--card-border);
			box-shadow:var(--shadow-sm);
			overflow:hidden;
		}
		.card-header{
			background:var(--sidebar-bg);
			color:#fff;
			border-bottom:0;
			padding:16px 20px;
			font-weight:600;
			font-size:0.9375rem;
		}
		.card-body{
			padding:0;
			background:#fff;
		}
		
		/* Consistent Table Design */
		.table-modern{
			border-collapse:separate;
			border-spacing:0;
			width:100%;
		}
		.table-modern thead th{
			background:var(--sidebar-bg);
			color:#fff;
			font-weight:700;
			font-size:0.75rem;
			text-transform:uppercase;
			letter-spacing:0.05em;
			padding:14px 20px;
			border-bottom:2px solid var(--card-border);
			border-top:none;
			white-space:nowrap;
			vertical-align:middle;
		}
		.table-modern tbody td{
			padding:16px 20px;
			border-bottom:1px solid #f0f0f0;
			color:var(--text-primary);
			font-size:0.875rem;
			vertical-align:middle;
		}
		.table-modern tbody tr{
			transition:background-color 0.2s ease;
		}
		.table-modern tbody tr:hover{
			background-color:#f8f9fa;
		}
		.table-modern tbody tr:last-child td{
			border-bottom:none;
		}
		
		/* Form Controls - Modern styling */
		.filter-control-wrapper{
			display:flex;
			flex-direction:column;
			gap:6px;
		}
		.filter-control-wrapper label{
			font-size:0.75rem;
			font-weight:600;
			color:var(--text-secondary);
			margin-bottom:0;
		}
		.form-select{
			padding:8px 12px;
			font-size:0.875rem;
			border:1.5px solid #e5e7eb;
			border-radius:var(--border-radius-sm);
			background:#fff;
			color:var(--text-primary);
			transition:all 0.2s ease;
			min-width:160px;
		}
		.form-select:hover{
			border-color:var(--gold);
			background:#fff;
		}
		.form-select:focus{
			border-color:var(--gold);
			background:#fff;
			color:var(--text-primary);
			box-shadow:0 0 0 3px rgba(166,134,4,0.1);
			outline:none;
		}
		.form-select option{
			background:#fff;
			color:#111827;
		}
		
		/* Modern Date Input Styling */
		.date-input-wrapper{
			display:flex;
			flex-direction:column;
			gap:6px;
		}
		.date-input-wrapper label{
			font-size:0.75rem;
			font-weight:600;
			color:var(--text-secondary);
			margin-bottom:0;
		}
		.date-input-wrapper input[type="date"]{
			padding:8px 12px;
			font-size:0.875rem;
			border:1.5px solid #e5e7eb;
			border-radius:var(--border-radius-sm);
			background:#fff;
			color:var(--text-primary);
			transition:all 0.2s ease;
			min-width:160px;
			cursor:pointer;
		}
		.date-input-wrapper input[type="date"]::placeholder{
			color:#9ca3af;
		}
		.date-input-wrapper input[type="date"]:hover{
			border-color:var(--gold);
			background:#fff;
		}
		.date-input-wrapper input[type="date"]:focus{
			border-color:var(--gold);
			background:#fff;
			color:var(--text-primary);
			box-shadow:0 0 0 3px rgba(166,134,4,0.1);
			outline:none;
		}
		.date-input-wrapper input[type="date"]::-webkit-calendar-picker-indicator{
			cursor:pointer;
			opacity:0.6;
			transition:opacity 0.2s ease;
		}
		.date-input-wrapper input[type="date"]:hover::-webkit-calendar-picker-indicator{
			opacity:1;
		}
		
		.btn-outline-primary{
			border:2px solid var(--gold);
			color:var(--gold);
			background:#fff;
			border-radius:var(--border-radius-sm);
			padding:10px 16px;
			font-weight:600;
			transition:all 0.2s ease;
		}
		.btn-outline-primary:hover{
			background:var(--gold);
			border-color:var(--gold);
			color:#fff;
			transform:translateY(-1px);
			box-shadow:0 2px 4px rgba(166,134,4,0.2);
		}
		.btn-outline-primary:active{
			transform:translateY(0);
		}
		
		main.container-fluid{
			padding:24px !important;
		}
		h3{
			font-weight:700;
			font-size:1.5rem;
			color:var(--text-primary);
			margin-bottom:8px;
		}
		small.text-secondary{
			color:var(--text-secondary);
			font-size:0.875rem;
		}
		.role-chip{
			font-weight:600;
			border-radius:999px;
			padding:.2rem .6rem;
			font-size:.75rem;
		}
		.role-chip.admin{
			background:#4a4a4a;
			color:#fff;
		}
		.role-chip.librarian{
			background:#e7f1ff;
			color:#0d6efd;
			border:1px solid rgba(13,110,253,.2);
		}
		.role-chip.student{
			background:#efe7ff;
			color:#6f42c1;
			border:1px solid rgba(111,66,193,.2);
		}
	</style>
</head>
<body class="sb-body sb-expanded">
	<div id="sidebar-root"></div>

	<div class="sb-wrapper">
		<nav class="sb-topbar navbar navbar-expand sticky-top admin-header-gold">
			<div class="container-fluid">
				<button id="sidebarToggle" class="btn btn-link text-dark me-2" aria-label="Toggle sidebar">
					<i class="bi bi-list fs-4"></i>
				</button>
				<div class="fw-bold h5 mb-0" id="pageTitle">System Logs</div>

				<div class="ms-auto d-flex align-items-center gap-2">
					<form class="d-none d-md-flex" role="search" style="max-width:520px;width:100%;">
						<div class="input-group input-group-sm search-bar-custom">
							<span class="input-group-text bg-light border-0 search-icon-wrapper"><i class="bi bi-search"></i></span>
							<input class="form-control border-0 bg-light search-input-custom" type="search" placeholder="Search">
						</div>
					</form>

					<div class="dropdown me-2">
						<button class="btn btn-link btn-sm position-relative notification-btn" data-bs-toggle="dropdown" id="notificationBtn" aria-label="Notifications">
							<i class="bi bi-bell fs-5"></i>
							<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-badge d-none" id="notificationBadge">0</span>
						</button>
						<ul class="dropdown-menu dropdown-menu-end notification-dropdown" style="min-width:320px;max-height:400px;overflow-y:auto;">
							<li class="px-3 py-2 border-bottom"><h6 class="mb-0 fw-semibold">System Alerts</h6></li>
							<li id="notificationList" class="px-3 py-2"><div class="text-muted small">No alerts</div></li>
						</ul>
					</div>

					<div class="dropdown">
						<button class="btn btn-light border btn-icon admin-btn-custom" data-bs-toggle="dropdown" id="userBtn" style="padding:0; width:44px; height:44px; border-radius:var(--border-radius-sm);">
							<img src="assets/img/default-avatar.png" alt="Profile" class="avatar-32" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
						</button>
						<ul class="dropdown-menu dropdown-menu-end">
							<li class="px-3 py-2 small text-muted" id="whoChip">—</li>
							<li><a class="dropdown-item" href="admin-profile.html"><i class="bi bi-gear me-2"></i>Profile</a></li>
							<li><hr class="dropdown-divider"></li>
							<li><a class="dropdown-item text-danger" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
						</ul>
					</div>
				</div>
			</div>
		</nav>

		<main class="sb-content container-fluid">
			<div class="d-flex align-items-end justify-content-between mb-4">
				<div class="d-flex align-items-end gap-3 ms-auto">
					<select id="type" class="form-select">
						<option value="">All</option>
						<option value="librarian">Librarian Actions</option>
						<option value="user">User Status Changes</option>
						<option value="settings">System Settings</option>
						<option value="login">Login Attempts</option>
						<option value="error">Errors/Warnings</option>
					</select>
					<div class="date-input-wrapper">
						<label for="from">From:</label>
						<input type="date" id="from" placeholder="dd/mm/yyyy">
					</div>
					<div class="date-input-wrapper">
						<label for="to">To:</label>
						<input type="date" id="to" placeholder="dd/mm/yyyy">
					</div>
					<button id="btnFilter" class="btn btn-outline-primary"><i class="bi bi-filter"></i></button>
				</div>
			</div>

			<div class="card">
				<div class="card-body p-0">
					<div class="table-responsive">
						<table class="table table-modern align-middle mb-0">
							<thead>
								<tr>
									<th>Actor</th>
									<th>Action</th>
									<th>Date</th>
									<th>Details</th>
								</tr>
							</thead>
							<tbody id="logBody"></tbody>
						</table>
						<div id="empty" class="text-center text-muted py-5 d-none">
							<i class="bi bi-card-checklist fs-1 d-block mb-2"></i>
							No logs.
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="assets/js/sidebar.js?v=2025-11-17-unified"></script>
	<script>
		async function getMe() {
			const authUrl = '/api/check-auth';
			try {
				const res = await fetch(authUrl, { credentials: 'include', headers: { 'Accept':'application/json' } });
				if (res.status === 401) {
					location.href = '/login';
					return null;
				}
				if (!res.ok) return null;
				const data = await res.json();
				if (data && data.success === true && data.user) return data.user;
				if (data && data.ok === true && data.user) return data.user;
				location.href = '/login';
				return null;
			} catch (e) {
				console.error('Auth check error:', e);
				return null;
			}
		}

		(async function(){
			const me = await getMe();
			if (!me) return;

			const role = (me.role || '').toLowerCase();
			renderSidebar('logs', role, false);
			
			// Cache role for sidebar
			if (['admin', 'librarian', 'student'].includes(role)) {
				localStorage.setItem('userRole', role);
			}

			// Load avatar in header if available
			const headerAvatar = document.querySelector('#userBtn img.avatar-32');
			if (headerAvatar && me.avatar && me.avatar.trim() !== '') {
				headerAvatar.src = me.avatar;
			}

			document.getElementById('sidebarToggle')?.addEventListener('click', () => {
				if (typeof toggleSidebar === 'function') toggleSidebar();
				else document.body.classList.toggle('sb-expanded');
			});

			const fullName = [me.first_name, me.last_name].filter(Boolean).join(' ');
			document.getElementById('whoChip').innerHTML =
				`<span class="badge role-chip ${role}">${role.toUpperCase()}</span> ${fullName || me.email}`;

			document.getElementById('logoutLink')?.addEventListener('click', async e => {
				e.preventDefault();
				try { await fetch('/api/logout', { method:'POST', credentials:'include' }); } catch {}
				location.href = '/login';
			});

			const body = document.getElementById('logBody');
			const empty = document.getElementById('empty');

			async function load(){
				const p = new URLSearchParams();
				const t = document.getElementById('type').value;
				const f = document.getElementById('from').value;
				const to = document.getElementById('to').value;
				if (t) p.set('type', t);
				if (f) p.set('from', f);
				if (to) p.set('to', to);
				const url = '/api/logs' + (p.toString() ? ('?' + p.toString()) : '');
				const res = await fetch(url).then(r=>r.json()).catch(()=>({logs:[]}));
				const items = res?.logs || [];
				body.innerHTML = items.map(x => `
					<tr>
						<td>${escapeHtml(x.actor || x.user || 'System')}</td>
						<td>${escapeHtml(x.action || x.type || '')}</td>
						<td>${escapeHtml(x.created_at || x.date || '')}</td>
						<td>${escapeHtml(x.details || '')}</td>
					</tr>
				`).join('');
				empty.classList.toggle('d-none', items.length > 0);
			}
			function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
			document.getElementById('btnFilter').addEventListener('click', load);
			load();
		})();
	</script>
</body>
</html>
